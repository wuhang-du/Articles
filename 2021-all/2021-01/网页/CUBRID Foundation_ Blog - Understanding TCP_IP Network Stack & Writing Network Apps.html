<!DOCTYPE html>
<!-- saved from url=(0069)https://www.cubrid.org/index.php?mid=blog&page=2&document_srl=3826497 -->
<html lang="en" style="" class=" modernizr-js modernizr-flexbox modernizr-flexboxlegacy modernizr-canvas modernizr-canvastext modernizr-webgl modernizr-no-touch modernizr-geolocation modernizr-postmessage modernizr-websqldatabase modernizr-indexeddb modernizr-hashchange modernizr-history modernizr-draganddrop modernizr-websockets modernizr-rgba modernizr-hsla modernizr-multiplebgs modernizr-backgroundsize modernizr-borderimage modernizr-borderradius modernizr-boxshadow modernizr-textshadow modernizr-opacity modernizr-cssanimations modernizr-csscolumns modernizr-cssgradients modernizr-cssreflections modernizr-csstransforms modernizr-csstransforms3d modernizr-csstransitions modernizr-fontface modernizr-generatedcontent modernizr-video modernizr-audio modernizr-localstorage modernizr-sessionstorage modernizr-webworkers modernizr-no-applicationcache modernizr-svg modernizr-inlinesvg modernizr-smil modernizr-svgclippaths"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- META -->

<meta name="Generator" content="XpressEngine">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- TITLE -->
<title>CUBRID Foundation: Blog - Understanding TCP/IP Network Stack &amp; Writing Network Apps</title>
<!-- CSS -->
<link rel="stylesheet" href="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/xe.css">
<link rel="stylesheet" href="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/jquery-ui.min.css">
<link rel="stylesheet" href="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/font-awesome.min.css">
<link rel="stylesheet" href="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/board.css">
<!--[if lt IE 9]><link rel="stylesheet" href="/modules/board/skins/sketchbook5/css/ie8.css?20170729171906" />
<![endif]--><link rel="stylesheet" href="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/bootstrap.css">
<link rel="stylesheet" href="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/themify-icons.css">
<link rel="stylesheet" href="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/flexslider.css">
<link rel="stylesheet" href="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/lightbox.min.css">
<link rel="stylesheet" href="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/ytplayer.css">
<link rel="stylesheet" href="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/theme-navy.css">
<link rel="stylesheet" href="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/custom.css">
<link rel="stylesheet" href="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/style.css">
<link rel="stylesheet" href="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/shCoreDefault.css">
<!-- JS -->
<!--[if lt IE 9]><script src="/common/js/jquery-1.x.js?20170729171932"></script>
<![endif]--><!--[if gte IE 9]><!--><script type="text/javascript" async="" src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/analytics.js"></script><script async="" src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/gtm.js"></script><script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/jquery.js"></script>
<!--<![endif]--><script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/modernizr.js"></script>
<script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/x.js"></script>
<script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/common.js"></script>
<script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/js_app.js"></script>
<script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/xml_handler.js"></script>
<script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/xml_js_filter.js"></script>
<script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/board.js"></script>
<script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/shCore.js"></script>
<script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/shAutoloader.js"></script>
<!-- RSS -->
<!-- ICON -->
<link rel="shortcut icon" href="https://www.cubrid.org/files/attach/xeicon/favicon.ico"><link rel="apple-touch-icon" href="https://www.cubrid.org/files/attach/xeicon/mobicon.png">
<script>
						if(!captchaTargetAct) {var captchaTargetAct = [];}
						captchaTargetAct.push("procMemberInsert");
						</script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async="" src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/js"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-108822134-2');
</script>

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NQH4RXB');</script>
<!-- End Google Tag Manager -->
<link rel="canonical" href="https://www.cubrid.org/blog/3826497">
<meta name="description" content="Written by Hyeongyeop Kim on 06/09/2017 We cannot imagine Internet service without TCP/IP. All Internet services we have developed and used at NHN are based on a solid basis, TCP/IP. Understanding how data is transferred via the network will help you to improve performance through tuning, troubleshooting, or introduction to a new technology. This article will describe the overall o...">
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:url" content="https://www.cubrid.org/blog/3826497">
<meta property="og:title" content="CUBRID Foundation: Blog - Understanding TCP/IP Network Stack &amp;amp; Writing Network Apps">
<meta property="og:description" content="Written by Hyeongyeop Kim on 06/09/2017 We cannot imagine Internet service without TCP/IP. All Internet services we have developed and used at NHN are based on a solid basis, TCP/IP. Understanding how data is transferred via the network will help you to improve performance through tuning, troubleshooting, or introduction to a new technology. This article will describe the overall o...">
<meta property="article:published_time" content="2020-05-11T12:12:51+00:00">
<meta property="article:modified_time" content="2020-05-11T12:25:37+00:00">
<style> .xe_content { font-family:"Open Sans","Helvetica Neue","Nanum Gothic","Malgun Gothic","Helvetica","Arial","sans-serif";font-size:14px; }</style>
<style data-id="bdCss">
.bd em,.bd .color{color:#333333;}
.bd .shadow{text-shadow:1px 1px 1px ;}
.bd .bolder{color:#333333;text-shadow:2px 2px 4px ;}
.bd .bg_color{background-color:#333333;}
.bd .bg_f_color{background-color:#333333;background:-webkit-linear-gradient(#FFF -50%,#333333 50%);background:linear-gradient(to bottom,#FFF -50%,#333333 50%);}
.bd .border_color{border-color:#333333;}
.bd .bx_shadow{box-shadow:0 0 2px ;}
.viewer_with.on:before{background-color:#333333;box-shadow:0 0 2px #333333;}
.bd_zine.zine li:first-child,.bd_tb_lst.common_notice tr:first-child td{margin-top:2px;border-top:1px solid #DDD}
.bd_zine .info b,.bd_zine .info a{color:;}
.bd_zine.card h3{color:#333333;}
.bd_zine .tmb_wrp .no_img{width:230px;height:200px;line-height:200px}
.bd_zine a:hover,.bd_zine a:focus,.bd_zine .select a{border-color:#333333;}
.bd_zine.zine .tmb_wrp img,.bd_zine.card li{  }
.bd_zine.zine .rt_area{margin-left:250px}
.bd_zine.zine .tmb_wrp{margin-left:-250px}
</style>
<link rel="shortcut icon" href="https://www.cubrid.org/layouts/layout_master/img/favicon.ico" type="image/x-icon">
<!--#Meta:layouts/layout_master/css/bootstrap.css--><!--#Meta:layouts/layout_master/css/themify-icons.css--><!--#Meta:layouts/layout_master/css/flexslider.css--><!--#Meta:layouts/layout_master/css/lightbox.min.css--><!--#Meta:layouts/layout_master/css/ytplayer.css--><!-- fitness -->
<!-- fation --><!-- restorant -->
<!-- agency --><!-- capital firm -->
<!-- adventure --><!-- winery -->
<!--#Meta:layouts/layout_master/css/theme-navy.css--><!-- music --><!-- resume -->
<!-- app landing -->
<!-- archtecture -->
<!-- app landing2 -->
<!--#Meta:layouts/layout_master/css/custom.css--><link href="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/css" rel="stylesheet" type="text/css"></head><body style="position: static;"><div class="nav-container " style="min-height: 110px;">
    <a id="top"></a>
    <nav class="scrolled">
    	<!-- 네비 상단바 -->
    	<div class="nav-utility">
        	<div class="container">
                                    <div class="module right">
                                                                            </div>
            
            <div class="module widget-handle search-widget-handle right visible-lg">
                    <div class="search">
                        <i class="ti-search"></i>
                        <span class="title">Search Site</span>
                    </div>
                    <div class="function">
                    	<form action="https://www.cubrid.org/" method="get" class="search-form"><input type="hidden" name="error_return_url" value="/index.php?mid=blog&amp;page=2&amp;document_srl=3826497">
<meta name="viewport" content="width=device-width, initial-scale=0.9"><script>
//<![CDATA[
var current_url = "https://www.cubrid.org/?mid=blog&page=2&document_srl=3826497";
var request_uri = "https://www.cubrid.org/";
var current_mid = "blog";
var waiting_message = "Requesting to the server, please wait.";
var ssl_actions = new Array();
var default_url = "https://www.cubrid.org/";
var http_port = 80;var https_port = 443;var enforce_ssl = true;xe.current_lang = "en";
xe.cmd_find = "Find";
xe.cmd_cancel = "Cancel";
xe.cmd_confirm = "Confirm";
xe.msg_no_root = "You cannot select a root.";
xe.msg_no_shortcut = "You cannot select a shortcut.";
xe.msg_select_menu = "Select target menu";
//]]>
</script>


<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NQH4RXB"
		height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->


                                                        <input type="hidden" name="mid" value="blog">
                            <input type="hidden" name="act" value="IS">
                            <input type="hidden" name="search_target" value="title_content">
                            <input name="is_keyword" type="text" title="keyword" placeholder="Search...">
                        </form>
                    </div>
                </div>                
                                
                                
                <div class="module right top-right-menu">
		    <a href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497&amp;act=dispMemberLoginForm">Sign In</a>                                                                                
		    <!-- [2020.02.023] CUBRID.ORG 홈페이지로 운영하기 때문에 원격지원 버튼 제거 -->
		    <!-- <a href="http://www.113366.com/cubrid" target="_blank" style="color:#333" >원격지원</a> -->
                    <!-- <a href="#" style="color:#333" onclick="doChangeLangType('ko');return false;" >한국어</a> -->
                    <!-- [2017.08.09] English -> CUBRID.ORG 변경 (주영진) -->
                    <!--  -->
		    <!-- [2020.02.023] CUBRID.ORG 홈페이지로 운영하기 때문에CUBRID.ORG 버튼 제거 -->
		    <!--  -->
                </div>
                
        	</div>        
        </div>        
        <!-- 네비 메뉴바-->
        <div class="nav-bar">
        	<div class="container">
            <div class="module left">
                <a href="https://www.cubrid.org/">
                    
                                            
                                        <img class="logo logo-dark" src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/389898f67335a2d0cc8b17a1984a5caf.png" alt="">                               
                </a>
            </div>
            <div class="module widget-handle mobile-toggle right visible-sm visible-xs">
                <i class="ti-menu"></i>
            </div>
            <div class="module-group right">
                <div class="module left">
                
                                    <ul class="menu">                        
                        <li class=" has-dropdown">
                            <a href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#">ABOUT </a>
                                                        
                                                                
                            <!-- 2차메뉴 시작 -->
                            <ul>
                                <li class="">
                                    <a href="https://www.cubrid.org/cubrid" class="">CUBRID </a>
                                                                                                        </li><li class="">
                                    <a href="https://www.cubrid.org/cubrid_tools" class="">CUBRID TOOLS </a>
                                                                                                        </li><li class="">
                                    <a href="https://www.cubrid.org/stakeholder" class="">STAKEHOLDER </a>
                                                                                                        </li><li class="">
                                    <a href="https://www.cubrid.org/sponsor" class="">SPONSOR </a>
                                                                                                        </li><li class="">
                                    <a href="https://www.cubrid.org/brand" class="">BRAND </a>
                                                                                                        </li>        
                            </ul>                            <!-- // 2차메뉴 종료-->
                                                                                </li><li class="">
                            <a href="https://www.cubrid.org/downloads">DOWNLOADS </a>
                                                        
                                                                
                            <!-- 2차메뉴 시작 -->
                                                        <!-- // 2차메뉴 종료-->
                                                                                </li><li class=" has-dropdown">
                            <a href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#">DOCUMENTATION </a>
                                                        
                                                                
                            <!-- 2차메뉴 시작 -->
                            <ul>
                                <li class="">
                                    <a href="https://www.cubrid.org/manuals" class="">MANUALS </a>
                                                                                                        </li><li class="">
                                    <a href="https://www.cubrid.org/release" class="">RELEASE </a>
                                                                                                        </li><li class="">
                                    <a href="https://www.cubrid.org/getting_started" class="">GETTING STARTED </a>
                                                                                                        </li><li class="">
                                    <a href="https://www.cubrid.org/tutorials" class="">TUTORIALS </a>
                                                                                                        </li><li class="">
                                    <a href="https://www.cubrid.org/faq" class="">FAQ </a>
                                                                                                        </li>        
                            </ul>                            <!-- // 2차메뉴 종료-->
                                                                                </li><li class=" has-dropdown">
                            <a href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#">COMMUNITY </a>
                                                        
                                                                
                            <!-- 2차메뉴 시작 -->
                            <ul>
                                <li class="">
                                    <a href="https://www.cubrid.org/how_to_contribute" class="">HOW TO CONTRIBUTE </a>
                                                                                                        </li><li class="">
                                    <a href="https://www.cubrid.org/contributor_agreement" class="">CONTRIBUTOR AGREEMENT </a>
                                                                                                        </li>        
                            </ul>                            <!-- // 2차메뉴 종료-->
                                                                                </li><li class="">
                            <a href="https://www.reddit.com/r/CUBRID/" target="_blank">FORUM </a>
                                                        
                                                                
                            <!-- 2차메뉴 시작 -->
                                                        <!-- // 2차메뉴 종료-->
                                                                                </li><li class="">
                            <a href="https://www.cubrid.org/news">NEWS </a>
                                                        
                                                                
                            <!-- 2차메뉴 시작 -->
                                                        <!-- // 2차메뉴 종료-->
                                                                                </li><li class="">
                            <a href="https://www.cubrid.org/blog">BLOG </a>
                                                        
                                                                
                            <!-- 2차메뉴 시작 -->
                                                        <!-- // 2차메뉴 종료-->
                                                                                </li><li class="">
                            <a href="https://www.cubrid.org/contact">CONTACT </a>
                                                        
                                                                
                            <!-- 2차메뉴 시작 -->
                                                        <!-- // 2차메뉴 종료-->
                                                                                </li>                    </ul>
                </div>
                <!--end of menu module-->
                
            </div>
            <div class="module widget-handle search-widget-handle left hidden-lg hidden-md hidden-xl">
                    <div class="search">
                        <i class="ti-search"></i>
                        <span class="title">Search Site</span>
                    </div>
                    <div class="function">
                    	<form action="https://www.cubrid.org/" method="get" class="search-form"><input type="hidden" name="error_return_url" value="/index.php?mid=blog&amp;page=2&amp;document_srl=3826497">
                                                        <input type="hidden" name="mid" value="blog">
                            <input type="hidden" name="act" value="IS">
                            <input type="hidden" name="search_target" value="title_content">
                            <input name="is_keyword" type="text" title="keyword" placeholder="Search...">
                        </form>
                    </div>
                </div>            </div>
            <!--end of module group-->
        </div>
    </nav>
</div>
<div class="main-container">
	                                                                                                    <!-- 페이지 타이틀 / 왼쪽정렬 -->
<section class="page-title page-title-4 image-bg overlay parallax bg-secondary ">
    <div class="background-image-holder fadeIn" style="transform: translate3d(0px, 4019.33px, 0px); background: url(&quot;https://www.cubrid.org/files/attach/images/3826762/d6b926fd0be802da72b0e96ee8043c3e.jpg&quot;); top: -110px;">
        <img alt="Background Image" class="background-image" src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/d6b926fd0be802da72b0e96ee8043c3e.jpg" style="display: none;">
    </div>    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <h3 class="uppercase mb0">
                                    BLOG                                </h3>
            </div>
            <div class="col-md-6 text-right">
                <ol class="breadcrumb breadcrumb-2">
                    <li>
                        <a href="https://www.cubrid.org/">Home</a>
                    </li>
                    
                                        <li class="active">
                        <a href="https://www.cubrid.org/blog">BLOG</a>
                    </li>
                                        
                    
                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                    </ol>
            </div>
        </div>
        <!--end of row-->
    </div>
    <!--end of container-->
</section>    
        
    <div class="container">
		<!--#JSPLUGIN:ui--><script>//<![CDATA[
var lang_type = "en";
var bdLogin = "Sign In?@https://www.cubrid.org/index.php?mid=blog&page=2&document_srl=3826497&act=dispMemberLoginForm";
jQuery(function($){
	board('#bd_3826714_3826497');
	$.cookie('bd_viewer_font',$('body').css('font-family'));
});
//]]></script>
<div></div><div id="bd_3826714_3826497" class="bd   small_lst_btn1" data-default_style="webzine" data-bdfilestype="" x-ms-format-detection="none">
<div class="bd_hd v2 clear">
	<div class="bd_bc fl" style="display:none;">
	<a href="https://www.cubrid.org/"><strong>Home</strong></a>
		<i class="fa fa-angle-right"></i><a href="https://www.cubrid.org/blog"><em>BLOG</em></a>
		</div>	
	<div class="bd_font m_no fr" style="display:none">
		<a class="select tg_btn2" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#" data-href=".bd_font_select"><b>T</b><strong>Default</strong><span class="arrow down"></span></a>
		<div class="bd_font_select tg_cnt2"><button type="button" class="tg_blur2"></button>
			<ul>
				<li class="ui_font on"><a href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#" title="Default">Default</a><em>✔</em></li>
				<li class="ng"><a href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#">나눔고딕</a><em>✔</em></li>
				<li class="window_font"><a href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#">Segoe UI</a><em>✔</em></li>
				<li class="tahoma"><a href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#">Tahoma</a><em>✔</em></li>
			</ul><button type="button" class="tg_blur2"></button>
		</div>
	</div>	
	<div class="bd_set fr m_btn_wrp m_no" style="display:none;">
				<a class="bg_f_f9" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#" onclick="window.open(&#39;https://www.cubrid.org/index.php?mid=blog&amp;document_srl=3826497&amp;listStyle=viewer&#39;,&#39;viewer&#39;,&#39;width=9999,height=9999,scrollbars=yes,resizable=yes,toolbars=no&#39;);return false"><em>✔</em> <strong>Viewer</strong></a>											</div>
	
	</div>
<div class="rd rd_nav_style2 clear" style="padding:;" data-docsrl="3826497">
	
	<div class="rd_hd clear" style="margin:0 -15px 20px">
		
		<div class="board clear " style=";">
			<div class="top_area ngeb" style=";">
								<div class="fr">
										
				</div>
				<!-- <h1 class="np_18px"><a href="https://www.cubrid.org/3826497">Understanding TCP/IP Network Stack &amp; Writing Network Apps</a></h1> -->
				<h1 class="np_18px xe_title"><a href="https://www.cubrid.org/3826497">Understanding TCP/IP Network Stack &amp; Writing Network Apps</a></h1>
			</div>
			<div class="btm_area clear">
								<div class="side">
																													</div>
				<div class="side fr">
																																								<span>Votes <b>0</b></span>					<span>Comment <b>0</b></span>									</div>
				
							</div>
		</div>		
				
				
				
				
				
		<div class="rd_nav img_tx fr m_btn_wrp">
		<div class="help bubble left m_no">
		<a class="text" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#" onclick="jQuery(this).next().fadeToggle();return false;">?</a>
		<div class="wrp">
			<div class="speech">
				<h4>Shortcut</h4>
				<p><strong><i class="fa fa-long-arrow-left"></i><span class="blind">Prev</span></strong>Prev Article</p>
				<p><strong><i class="fa fa-long-arrow-right"></i><span class="blind">Next</span></strong>Next Article</p>
							</div>
			<i class="edge"></i>
			<i class="ie8_only bl"></i><i class="ie8_only br"></i>
		</div>
	</div>		<a class="font_plus bubble" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#" title="Larger Font"><i class="fa fa-search-plus"></i><b class="tx">Larger Font</b></a>
	<a class="font_minus bubble" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#" title="Smaller Font"><i class="fa fa-search-minus"></i><b class="tx">Smaller Font</b></a>
			<a class="back_to bubble m_no" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#bd_3826714_3826497" title="Up"><i class="fa fa-arrow-up"></i><b class="tx">Up</b></a>
	<a class="back_to bubble m_no" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#rd_end_3826497" title="(List) Down"><i class="fa fa-arrow-down"></i><b class="tx">Down</b></a>
	<a class="comment back_to bubble if_viewer m_no" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#3826497_comment" title="Go comment"><i class="fa fa-comment"></i><b class="tx">Go comment</b></a>
	<a class="print_doc bubble m_no" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497&amp;listStyle=viewer" title="Print"><i class="fa fa-print"></i><b class="tx">Print</b></a>			</div>		<div class="rd_nav_side" style="display:none;">
			<div class="rd_nav img_tx fr m_btn_wrp" style="display: block;">
		<div class="help bubble left m_no">
		<a class="text" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#" onclick="jQuery(this).next().fadeToggle();return false;">?</a>
		<div class="wrp">
			<div class="speech">
				<h4>Shortcut</h4>
				<p><strong><i class="fa fa-long-arrow-left"></i><span class="blind">Prev</span></strong>Prev Article</p>
				<p><strong><i class="fa fa-long-arrow-right"></i><span class="blind">Next</span></strong>Next Article</p>
							</div>
			<i class="edge"></i>
			<i class="ie8_only bl"></i><i class="ie8_only br"></i>
		</div>
	</div>		<a class="font_plus bubble" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#" title="Larger Font"><i class="fa fa-search-plus"></i><b class="tx">Larger Font</b></a>
	<a class="font_minus bubble" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#" title="Smaller Font"><i class="fa fa-search-minus"></i><b class="tx">Smaller Font</b></a>
			<a class="back_to bubble m_no" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#bd_3826714_3826497" title="Up"><i class="fa fa-arrow-up"></i><b class="tx">Up</b></a>
	<a class="back_to bubble m_no" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#rd_end_3826497" title="(List) Down"><i class="fa fa-arrow-down"></i><b class="tx">Down</b></a>
	<a class="comment back_to bubble if_viewer m_no" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#3826497_comment" title="Go comment"><i class="fa fa-comment"></i><b class="tx">Go comment</b></a>
	<a class="print_doc bubble m_no" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497&amp;listStyle=viewer" title="Print"><i class="fa fa-print"></i><b class="tx">Print</b></a>			</div>		</div>			</div>
	
		
	<div class="rd_body clear">
		
				
				
				<article><!--BeforeDocument(3826497,3825957)--><div class="document_3826497_3825957 xe_content"><h6 class="written-by">Written by <span class="author-name">Hyeongyeop Kim</span> on <span class="on-date">06/09/2017</span></h6>

<div class="blog">
  <p>We cannot imagine Internet service without TCP/IP. All Internet services we have developed and used at NHN are based on a solid basis, TCP/IP. Understanding how data is transferred via the network will help you to improve performance through
    tuning, troubleshooting, or introduction to a new technology.</p>

  <p>This article will describe the overall operation scheme of the network stack based on data flow and control flow in Linux OS and the hardware layer.</p>

  <h2>Key Characteristics of TCP/IP</h2>

  <p><b>How should I design a network protocol to transmit data quickly while keeping the data order without any data loss?</b> TCP/IP has been designed with this consideration. The following are the key characteristics of TCP/IP required to
    understand the concept of the stack.</p>

  <blockquote>
    <p><strong>TCP and IP</strong></p>

    <p>Technically, since TCP and IP have different layer structures, it would be correct to describe them separately. However, here we will describe them as one.</p>
  </blockquote>

  <h4>1. Connection-oriented</h4>

  <p>First, a connection is made between two endpoints (local and remote) and then data is transferred. Here, the "TCP connection identifier" is a combination of addresses of the two endpoints, having <code>&lt;local IP address, local port
      number, remote IP address, remote port number&gt;</code> type.</p>

  <h4>2. Bidirectional Byte Stream</h4>

  <p>Bidirectional data communication is made by using byte stream.</p>

  <h4>3. In-order Delivery</h4>

  <p>A receiver receives data in the order of sending data from a sender. For that, the order of data is required. To mark the order, 32-bit integer data type is used.</p>

  <h4>4. Reliability through ACK</h4>

  <p>When a sender did not receive ACK (acknowledgement) from a receiver after sending data to the receiver, the sender TCP re-sends the data to the receiver. Therefore, the sender TCP buffers unacknowledged data from the receiver.</p>

  <h4>5. Flow Control</h4>

  <p>A sender sends as much data as a receiver can afford. A receiver sends the maximum number of bytes that it can receive (<i>unused buffer size</i>, <i>receive window</i>) to the sender. The sender sends as much data as the size of bytes that the
    receiver's <i>receive window</i> allows.</p>

  <h4>6. Congestion Control</h4>

  <p>The <a class="get-started" href="http://en.wikipedia.org/wiki/Congestion_window" target="_blank">congestion window</a> is used separately from the <i>receive window</i> to prevent network congestion by limiting the volume of data flowing in the
    network. Like the receive window, the sender sends as much data as the size of bytes that the receiver's <i>congestion window</i> allows by using a variety of algorithms such as TCP Vegas, Westwood, BIC, and CUBIC. Different from flow
    control, congestion control is implemented by the sender only.</p>

  <h2>Data Transmission</h2>

  <p>As indicated by its name, a network stack has many layers. The following <strong>Figure 1</strong> shows the layer types.</p>

  <p style="text-align: center;"><img alt="operation_process_by_each_layer_of_tcp_ip.png" height="254" rel="xe_gallery" src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/4f230194dd6d52ed4566ef365eb3ff1a.png" width="556" style="cursor: pointer;"></p>

  <p style="text-align: center;"><b>Figure 1: Operation Process by Each Layer of TCP/IP Network Stack for Data Transmission.</b></p>

  <p>There are several layers and the layers are briefly classified into three areas:</p>

  <ol>
    <li>User area</li>
    <li>Kernel area</li>
    <li>Device area</li>
  </ol>

  <p>Tasks at the user area and the kernel area are performed by the CPU. The <i>user area</i> and the <i>kernel area</i> are called "<b>host</b>" to distinguish them from the device area. Here, the device is the <i>Network Interface
      Card</i> (NIC) that sends and receives packets. It is a more accurate term than the commonly used "LAN card".</p>

  <p>Let's take a look at the user area. First, the application creates data to send (the "<b>User data</b>" box in <b>Figure 1</b>) and then calls the <code>write()</code> system call to send the data. Assume that the socket (<b>fd</b>
    in <b>Figure 1</b>) has been already created. When the system call is called, the area is switched to the kernel area.</p>

  <p>POSIX-series operating systems including Linux and Unix expose the socket to the application by using a file descriptor. In the POSIX-series operating system, the socket is a kind of a file. The file layer executes a simple examination and calls
    the socket function by using the socket structure connected to the file structure.</p>

  <p>The kernel socket has two buffers.</p>

  <ol>
    <li>One is the <i>send socket buffer</i> for sending;</li>
    <li>And the other is the <i>receive socket buffer</i> for receiving.</li>
  </ol>

  <p>When the write system call is called, the data in the user area is copied to the kernel memory and then added to the end of the send socket buffer. This is to send data in order. In the <b>Figure 1</b>, the light-gray box refers to the data in
    the socket buffer. Then, TCP is called.</p>

  <p>There is the TCP Control Block (TCB) structure connected to the socket. The TCB includes data required for processing the TCP connection. Data in the TCB are <i>connection state</i> (<code>LISTEN</code>, <code>ESTABLISHED</code>,
    <code>TIME_WAIT</code>), <i>receive window</i>, <i>congestion window</i>, <i>sequence number</i>, <i>resending timer</i>, etc.</p>

  <p>If the current TCP state allows for data transmission, a new TCP segment (in other words, a packet) is created. If data transmission is impossible due to flow control or such a reason, the system call is ended here and then the mode is returned
    to the user mode (in other words, the control is passed to the application).</p>

  <p>There are two TCP segments as shown in <b>Figure 2</b>:</p>

  <ol>
    <li>TCP header;</li>
    <li>And payload.</li>
  </ol>

  <p><img alt="tcp_frame_structure.png" height="416" rel="xe_gallery" src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/461258caebd0ea3011eaaeeb9cd4a968.png" style="display: block; margin-left: auto; margin-right: auto; cursor: pointer;" width="575"></p>

  <p style="text-align: center;"><b>Figure 2: TCP Frame Structure (<a class="get-started" href="http://www.skullbox.net/tcpudp.php" target="_blank">source</a>).</b></p>

  <p>The payload includes the data saved in the unacknowledged send socket buffer. The maximum length of the payload is the maximum value among the receive window, congestion window, and maximum segment size (MSS).</p>

  <p>Then, TCP checksum is computed. In this checksum computation, pseudo header information (IP addresses, segment length, and protocol number) is included. One or more packets can be transmitted according to the TCP state.</p>

  <p>In fact, since the current network stack uses the checksum offload, the TCP checksum is computed by NIC, not by the kernel. However, we assume that the kernel computes the TCP checksum for convenience.</p>

  <p>The created TCP segment goes down to the IP layer. The IP layer adds an IP header to the TCP segment and performs IP routing. <b>IP routing</b> is a procedure of searching the next hop IP in order to go to the destination IP.</p>

  <p>After the IP layer has computed and added the IP header checksum, it sends the data to the Ethernet layer.&nbsp;The Ethernet layer searches for the MAC address of the next hop IP by using the Address Resolution Protocol (ARP). It then adds the
    Ethernet header to the packet. The host packet is completed by adding the Ethernet header.</p>

  <p>After IP routing is performed, the transmit interface (NIC) is known as the result of IP routing. The interface is used for transmitting a packet to the next hop IP and the IP. Therefore, the transmit NIC driver is called.</p>

  <p>At this time, if a packet capture program such as tcpdump or Wireshark is running, the kernel copies the packet data onto the memory buffer that the program uses. In that way, the receiving packet is directly captured on the driver. Generally,
    the traffic shaper function is implemented to run on this layer.</p>

  <p>The driver requests packet transmission according to the driver-NIC communication protocol defined by the NIC manufacturer.</p>

  <p>After receiving the packet transmission request, the NIC copies the packets from the main memory to its memory and then sends it to the network line. At this time, by complying with the Ethernet standard, it adds the IFG (Inter-Frame Gap),
    preamble, and CRC to the packet. The IFG and preamble are used to distinguish the start of the packet (as a networking term, framing), and the CRC is used to protect the data (the same purpose as TCP and IP checksum). Packet transmission is
    started based on the physical speed of the Ethernet and the condition of Ethernet flow control. It is like getting the floor and speaking in a conference room.</p>

  <p>When an NIC sends a packet, the NIC generates interrupts on the host CPU. Every interrupt has its own interrupt number and the OS searches an adequate driver to handle the interrupt by using the number. The driver registers a function to handle
    the interrupt (an interrupt handler) when the driver is started. The OS calls the interrupt handler and then the interrupt handler returns the transmitted packet to the OS.</p>

  <p>So far we have discussed the procedure of data transmission through the kernel and the device when an application performs write. However, without a direct write request from the application, the kernel can transmit a packet by directly calling
    TCP. For example, when an ACK is received and the receive window is expanded, the kernel creates a TCP segment including the data left in the socket buffer and sends the TCP segment to the receiver.</p>

  <h2>Data Receiving</h2>

  <p>Now, let's take a look at how data is received. Data receiving is a procedure for how the network stack handles a packet coming in. <b>Figure 3</b> shows how the network stack handles a packet received.</p>

  <p><img alt="operation_process_by_each_layer_of_tcp_ip_for_data_received.png" height="254" rel="xe_gallery" src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/5d7322505c1ea20bb741d7b3904ef8f9.png" style="display: block; margin-left: auto; margin-right: auto; cursor: pointer;" width="556"></p>

  <p style="text-align: center;"><b>Figure 3: Operation Process by Each Layer of TCP/IP Network Stack for Handling Data Received.</b></p>

  <p>First, the NIC writes the packet onto its memory. It checks whether the packet is valid by performing the CRC check and then sends the packet to the memory buffer of the host. This buffer is a memory that has already been requested by the driver
    to the kernel and allocated for receiving packets. After the buffer has been allocated, the driver tells the memory address and size to the NIC. When there is no host memory buffer allocated by the driver even though the NIC receives a packet,
    the NIC may drop the packet.</p>

  <p>After sending the packet to the host memory buffer, the NIC sends an interrupt to the host OS.</p>

  <p>Then, the driver checks whether it can handle the new packet or not. So far, the driver-NIC communication protocol defined by the manufacturer is used.</p>

  <p>When the driver should send a packet to the upper layer, the packet must be wrapped in a packet structure that the OS uses for the OS to understand the packet. For example, <b>sk_buff</b> of Linux, <b>mbuf</b> of BSD-series kernel, and
    <b>NET_BUFFER_LIST</b> of Microsoft Windows are the packet structures of the corresponding OS. The driver sends the wrapped packets to the upper layer.</p>

  <p>The Ethernet layer checks whether the packet is valid and then de-multiplexes the upper protocol (network protocol). At this time, it uses the ethertype value of the Ethernet header. The IPv4 ethertype value is <b>0x0800</b>. It removes the
    Ethernet header and then sends the packet to the IP layer.</p>

  <p>The IP layer also checks whether the packet is valid. In other words, it checks the IP header checksum. It logically determines whether it should perform IP routing and make the local system handle the packet, or send the packet to the other
    system. If the packet must be handled by the local system, the IP layer de-multiplexes the upper protocol (transport protocol) by referring to the proto value of the IP header. The TCP proto value is 6. It removes the IP header and then sends the
    packet to the TCP layer.</p>

  <p>Like the lower layer, the TCP layer checks whether the packet is valid. It also checks the TCP checksum. As mentioned before, since the current network stack uses the checksum offload, the TCP checksum is computed by NIC, not by the kernel.</p>

  <p>Then it searches the TCP control block where the packet is connected. At this time, <code>&lt;source IP, source port, target IP, target port&gt;</code> of the packet is used as an identifier. After searching the connection, it performs the
    protocol to handle the packet. If it has received new data, it adds the data to the receive socket buffer. According to the TCP state, it can send a new TCP packet (for example, an ACK packet). Now TCP/IP receiving packet handling has completed.
  </p>

  <p>The size of the receive socket buffer is the TCP receive window. To a certain point, the TCP throughput increases when the receive window is large. In the past, the socket buffer size had been adjusted on the application or the OS configuration.
    The latest network stack has a function to adjust the receive socket buffer size, i.e., the receive window, automatically.</p>

  <p>When the application calls the read system call, the area is changed to the kernel area and the data in the socket buffer is copied to the memory in the user area. The copied data is removed from the socket buffer. And then the TCP is called.
    The TCP increases the receive window because there is new space in the socket buffer. And it sends a packet according to the protocol status. If no packet is transferred, the system call is terminated.</p>

  <h2>Network Stack Development Direction</h2>

  <p>The functions of network stack layers described so far are the most basic functions. The network stack in the early 1990s had few more functions than the functions described above. However, the latest network stack has many more functions and
    complexity as the network stack implementation structure gets higher.</p>

  <p>The latest network stack is classified by purpose as follows.</p>

  <h3>Packet Processing Procedure Manipulation</h3>

  <p>It is a function like Netfilter (firewall, NAT) and traffic control. By inserting the user-controllable code to the basic processing flow, the function can work differently according to the user configuration.</p>

  <h3>Protocol Performance</h3>

  <p>It aims to improve the throughput, latency, and stability that the TCP protocol can achieve within the given network environment. Various congestion control algorithms and additional TCP functions such as SACK are the typical examples. The
    protocol improvement will not be discussed here since it is out of the scope.</p>

  <h3>Packet Processing Efficiency</h3>

  <p>The packet processing efficiency aims to improve the maximum number of packets that can be processed per second by reducing the CPU cycle, memory usage, and memory accesses that one system consumes to process packets. There have been several
    attempts to reduce the latency in the system. The attempts include stack parallel processing, header prediction, zero-copy, single-copy, checksum offload, TSO, LRO, RSS, etc.</p>

  <h2>Control Flow in the Stack</h2>

  <p>Now, we will take a more detailed look at the internal flow of the Linux network stack. Like a subsystem which is not a network stack, a network stack basically runs as the event-driven way that reacts when the event occurs. Therefore, there is
    no separated thread to execute the stack. <b>Figure 1</b> and <b>Figure 3</b> showed the simplified diagrams of control flow. <b>Figure 4</b>&nbsp;below illustrates more exact control flow.</p>

  <p style="text-align: center;"><img alt="control_flow_in_stack.png" height="421" rel="xe_gallery" src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/bf6bff327d8abd33c8e44258c98ccce6.png" width="558" style="cursor: pointer;"></p>

  <p style="text-align: center;"><b>Figure 4: Control Flow in the Stack.</b></p>

  <p>At Flow (1) in Figure 4, an application calls a system call to execute (use) the TCP. For example, calls the read system call and the write system call and then executes TCP. However, there is no packet transmission.</p>

  <p>Flow (2) is same as Flow (1) if it requires packet transmission after executing TCP. It creates a packet and sends down the packet to the driver. A queue is in front of the driver. The packet comes into the queue first, and then the queue
    implementation structure decides the time to send the packet to the driver. This is queue discipline (<b>qdisc</b>) of Linux. The function of Linux traffic control is to manipulate the qdisc. The default qdisc is a simple First-In-First-Out
    (FIFO) queue. By using another qdisc, operators can achieve various effects such as artificial packet loss, packet delay, transmission rate limit, etc. At Flow (1) and Flow (2), the process thread of the application also executes the driver.</p>

  <p>Flow (3) shows the case in which the timer used by the TCP has expired. For example, when the <b>TIME_WAIT</b> timer has expired, the TCP is called to delete the connection.</p>

  <p>Like Flow (3), Flow (4) is the case in which the timer used by the TCP has expired and the TCP execution result packet should be transmitted. For example, when the retransmit timer has expired, the packet of which ACK has not been received is
    transmitted.</p>

  <p>Flow (3) and Flow (4) show the procedure of executing the timer softirq that has processed the timer interrupt.</p>

  <p>When the NIC driver receives an interrupt, it frees the transmitted packet. In most cases, execution of the driver is terminated here. Flow (5) is the case of packet accumulation in the transmit queue. The driver requests softirq and the softirq
    handler executes the transmit queue to send the accumulated packet to the driver.</p>

  <p>When the NIC driver receives an interrupt and finds a newly received packet, it requests softirq. The softirq that processes the received packet calls the driver and transmits the received packet to the upper layer. In Linux, processing the
    received packet as shown above is called New API (NAPI). It is similar to polling because the driver does not directly transmit the packet to the upper layer, but the upper layer directly gets the packet. The actual code is called NAPI poll or
    poll.</p>

  <p>Flow (6) shows the case that completes execution of TCP, and Flow (7) shows the case that requires additional packet transmission. All of Flow (5), (6), and (7) are executed by the softirq which has processed the NIC interrupt.</p>

  <h2>How to Process Interrupt and Received Packet</h2>

  <p>Interrupt processing is complex; however, you need to understand the performance issue related to processing of packets received. Figure 5 shows the procedure of processing an interrupt.</p>

  <p style="text-align: center;"><img alt="processing_interrupt_softirq_and_received_packet.png" height="314" rel="xe_gallery" src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/29b36ba3ab2a478bd683d1ab0be694da.png" width="539" style="cursor: pointer;"></p>

  <p style="text-align: center;"><b>Figure 5: Processing Interrupt, softirq, and Received Packet.</b></p>

  <p>Assume that the CPU 0 is executing an application program (user program). At this time, the NIC receives a packet and generates an interrupt for the CPU 0. Then the CPU executes the kernel interrupt (called irq) handler. This handler refers to
    the interrupt number and then calls the driver interrupt handler. The driver frees the packet transmitted and then calls the <code>napi_schedule()</code> function to process the received packet. This function requests the softirq (software
    interrupt).</p>

  <p>After execution of the driver interrupt handler has been terminated, the control is passed to the kernel handler. The kernel handler executes the interrupt handler for the softirq.</p>

  <p>After the interrupt context has been executed, the softirq context will be executed. The interrupt context and the softirq context are executed by an identical thread. However, they use different stacks. And, the interrupt context blocks
    hardware interrupts; however, the softirq context allows for hardware interrupts.</p>

  <p>The softirq handler that processes the received packet is the <code>net_rx_action()</code> function. This function calls the <code>poll()</code> function of the driver. The <code>poll()</code> function calls the <code>netif_receive_skb()</code>
    function and then sends the received packets one by one to the upper layer. After processing the softirq, the application restarts execution from the stopped point in order to request a system call.</p>

  <p>Therefore, the CPU that has received the interrupt processes the received packets from the first to the last. In Linux, BSD, and Microsoft Windows, the processing procedure is basically the same on this wise.</p>

  <p>When you check the server CPU utilization, sometimes you can check that only one CPU executes the softirq hard among the server CPUs. The phenomenon occurs due to the way of processing received packets explained so far. To solve the problem,
    multi-queue NIC, RSS, and RPS have been developed.</p>

  <h2>Data Structure</h2>

  <p>The followings are some key data structures. Take a look at them and review the code.</p>

  <h3>sk_buff structure</h3>

  <p>First, there is the <b>sk_buff</b> structure or <b>skb</b> structure that means a packet. <b>Figure 6</b> shows some of the <b>sk_buff</b> structure. As the functions have been advanced, they get more complicated. However, the basic functions
    are very common that anyone can think.</p>

  <p style="text-align: center;"><img alt="packet_structure_sk_buff.png" height="354" rel="xe_gallery" src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/cfdb2ac9851aa45fdc5dc8fbabf0de37.png" width="548" style="cursor: pointer;"></p>

  <p style="text-align: center;"><b>Figure 6: Packet Structure sk_buff.</b></p>

  <h3>Including Packet Data and <i>meta data</i></h3>

  <p>The structure directly includes the packet data or refers to it by using a pointer. In <b>Figure 6</b>, some of the packets (from Ethernet to buffer) refer to using the data pointer and the additional data (frags) refer to the actual page.</p>

  <p>The necessary information such as header and payload length is saved in the meta data area. For example, in <b>Figure 6</b>, the mac_header, the network_header, and the transport_header have the corresponding pointer data that points the
    starting position of the Ethernet header, IP header and TCP header, respectively. This way makes TCP protocol processing easy.</p>

  <h3>How to Add or Delete a Header</h3>

  <p>The header is added or deleted as up and down each layer of the network stack. Pointers are used for more efficient processing. For example, to remove the Ethernet header, just increase the head pointer.</p>

  <h3>How to Combine and Divide Packet</h3>

  <p>The linked list is used for efficient execution of tasks such as adding or deleting packet payload data to the socket buffer, or packet chain. The next pointer and the prev pointer are used for this purpose.</p>

  <h3>Quick Allocation and Free</h3>

  <p>As a structure is allocated whenever creating a packet, the quick allocator is used. For example, if data is transmitted at the speed of 10-Gigabit Ethernet, more than one million packets per second must be created and deleted.</p>

  <h2>TCP Control Block</h2>

  <p>Second, there is a structure that represents the TCP connection. Previously, it was abstractly called a TCP control block. Linux uses tcp_sock for the structure. In <b>Figure 7</b>, you can see the relationship among the file, the socket, and
    the <b>tcp_sock</b>.</p>

  <p style="text-align: center;"><img alt="tcp_connection_structure.png" height="360" rel="xe_gallery" src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/ca2196ad43ec94fdb25bfb486ed64857.png" width="522" style="cursor: pointer;"></p>

  <p style="text-align: center;"><b>Figure 7: TCP Connection Structure.</b></p>

  <p>When a system call has occurred, it searches the file in the file descriptor used by the application that has called the system call. For the Unix-series OS, the socket, the file and the device for general file system for storage are abstracted
    to a file. Therefore, the file structure includes the least information. For a socket, a separate socket structure saves the socket-related information and the file refers to the socket as a pointer. The socket refers to the <b>tcp_sock</b>
    again. The <b>tcp_sock</b> is classified into sock, inet_sock, etc to support various protocols except TCP. It may be considered as a kind of polymorphism.</p>

  <p>All status information used by the TCP protocol is saved in the tcp_sock. For example, the sequence number, receive window, congestion control, and retransmit timer are saved in the <b>tcp_sock</b>.</p>

  <p>The send socket buffer and the receive socket buffer are the <b>sk_buff</b> lists and they include the <b>tcp_sock</b>. The dst_entry, the IP routing result, is referred to in order to avoid too frequent routing. The dst_entry allows for easy
    search of the ARP result, i.e., the destination MAC address. The dst_entry is part of the routing table. The structure of the routing table is very complex that it will not be discussed in this document. The NIC to be used for packet transmission
    is searched by using the <b>dst_entry</b>. The NIC is expressed as the net_device structure.</p>

  <p>Therefore, by searching just the file, it is very easy to find all structures (from the file to the driver) required to process the TCP connection with the pointer. The size of the structures is the memory size used by one TCP connection. The
    memory size is a few KBs (excluding the packet data). As more functions have been added, the memory usage has been gradually increased.</p>

  <p>Finally, let's see the TCP connection lookup table. It is a hash table used to search the TCP connection where the received packet belongs. The hash value is calculated by using the input data of <code>&lt;source IP, target IP, source port,
      target port&gt;</code> of the packet and the Jenkins hash algorithm. It is told that the hash function has been selected by considering defense against attacks to the hash table.</p>

  <h2>Following Code: How to Transmit Data</h2>

  <p>We will check the key tasks performed by the stack by following the actual Linux kernel source code. Here, we will observe two paths which are frequently used.</p>

  <p>First, this is a path used to transmit data when an application calls the write system call.</p>

  <div><div id="highlighter_924425" class="syntaxhighlighter  cpp"><div class="toolbar"><span><a href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">SYSCALL_DEFINE3(write, unsigned </code><code class="cpp color1 bold">int</code><code class="cpp plain">, fd, </code><code class="cpp keyword bold">const</code> <code class="cpp color1 bold">char</code> <code class="cpp plain">__user *, buf, ...)</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number3 index2 alt2"><code class="cpp plain">{</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number5 index4 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">file *file;</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number7 index6 alt2"><code class="cpp plain">[...]</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number9 index8 alt2"><code class="cpp plain">file = fget_light(fd, &amp;fput_needed);</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number11 index10 alt2"><code class="cpp plain">[...] ===&gt;</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number13 index12 alt2"><code class="cpp plain">ret = filp-&gt;f_op-&gt;aio_write(&amp;kiocb, &amp;iov, 1, kiocb.ki_pos);</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number15 index14 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number16 index15 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number17 index16 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">file_operations {</code></div><div class="line number18 index17 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number19 index18 alt2"><code class="cpp plain">[...]</code></div><div class="line number20 index19 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number21 index20 alt2"><code class="cpp plain">ssize_t (*aio_read) (</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">kiocb *, </code><code class="cpp keyword bold">const</code> <code class="cpp keyword bold">struct</code> <code class="cpp plain">iovec *, ...)</code></div><div class="line number22 index21 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number23 index22 alt2"><code class="cpp plain">ssize_t (*aio_write) (</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">kiocb *, </code><code class="cpp keyword bold">const</code> <code class="cpp keyword bold">struct</code> <code class="cpp plain">iovec *, ...)</code></div><div class="line number24 index23 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number25 index24 alt2"><code class="cpp plain">[...]</code></div><div class="line number26 index25 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number27 index26 alt2"><code class="cpp plain">};</code></div><div class="line number28 index27 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number29 index28 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number30 index29 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number31 index30 alt2"><code class="cpp keyword bold">static</code> <code class="cpp keyword bold">const</code> <code class="cpp keyword bold">struct</code> <code class="cpp plain">file_operations socket_file_ops = {</code></div><div class="line number32 index31 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number33 index32 alt2"><code class="cpp plain">[...]</code></div><div class="line number34 index33 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number35 index34 alt2"><code class="cpp plain">.aio_read = sock_aio_read,</code></div><div class="line number36 index35 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number37 index36 alt2"><code class="cpp plain">.aio_write = sock_aio_write,</code></div><div class="line number38 index37 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number39 index38 alt2"><code class="cpp plain">[...]</code></div><div class="line number40 index39 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number41 index40 alt2"><code class="cpp plain">};</code></div></div></td></tr></tbody></table></div></div>

  <p>When the application calls the write system call, the kernel performs the <code>write()</code> function of the file layer. First, the actual file structure of the file descriptor fd is fetched. And then the <b>aio_write</b> is called. This is
    the
    function pointer. In the file structure, you will see the <b>file_operations</b> structure pointer. The structure is generally called function table and includes the function pointers such as aio_read and <b>aio_write</b>. The actual table for
    the
    socket is socket_file_ops. The aio_write function used by the socket is sock_aio_write. The function table is used for the purpose that is similar to the Java interface. It is generally used for the kernel to perform code abstraction or
    refactoring.</p>

  <div>
    <div class="syntaxhighlighter  cpp" id="highlighter_259122">
      <div class="toolbar"><span><a class="toolbar_item command_help help" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#">?</a></span></div>

      <table border="0" cellpadding="0" cellspacing="0">
        <tbody>
          <tr>
            <td class="gutter">
              <div class="line number1 index0 alt2">1</div>

              <div class="line number2 index1 alt1">2</div>

              <div class="line number3 index2 alt2">3</div>

              <div class="line number4 index3 alt1">4</div>

              <div class="line number5 index4 alt2">5</div>

              <div class="line number6 index5 alt1">6</div>

              <div class="line number7 index6 alt2">7</div>

              <div class="line number8 index7 alt1">8</div>

              <div class="line number9 index8 alt2">9</div>

              <div class="line number10 index9 alt1">10</div>

              <div class="line number11 index10 alt2">11</div>

              <div class="line number12 index11 alt1">12</div>

              <div class="line number13 index12 alt2">13</div>

              <div class="line number14 index13 alt1">14</div>

              <div class="line number15 index14 alt2">15</div>

              <div class="line number16 index15 alt1">16</div>

              <div class="line number17 index16 alt2">17</div>

              <div class="line number18 index17 alt1">18</div>

              <div class="line number19 index18 alt2">19</div>

              <div class="line number20 index19 alt1">20</div>

              <div class="line number21 index20 alt2">21</div>

              <div class="line number22 index21 alt1">22</div>

              <div class="line number23 index22 alt2">23</div>

              <div class="line number24 index23 alt1">24</div>

              <div class="line number25 index24 alt2">25</div>

              <div class="line number26 index25 alt1">26</div>

              <div class="line number27 index26 alt2">27</div>

              <div class="line number28 index27 alt1">28</div>

              <div class="line number29 index28 alt2">29</div>

              <div class="line number30 index29 alt1">30</div>

              <div class="line number31 index30 alt2">31</div>

              <div class="line number32 index31 alt1">32</div>

              <div class="line number33 index32 alt2">33</div>

              <div class="line number34 index33 alt1">34</div>

              <div class="line number35 index34 alt2">35</div>

              <div class="line number36 index35 alt1">36</div>

              <div class="line number37 index36 alt2">37</div>

              <div class="line number38 index37 alt1">38</div>

              <div class="line number39 index38 alt2">39</div>

              <div class="line number40 index39 alt1">40</div>

              <div class="line number41 index40 alt2">41</div>

              <div class="line number42 index41 alt1">42</div>

              <div class="line number43 index42 alt2">43</div>

              <div class="line number44 index43 alt1">44</div>

              <div class="line number45 index44 alt2">45</div>

              <div class="line number46 index45 alt1">46</div>

              <div class="line number47 index46 alt2">47</div>

              <div class="line number48 index47 alt1">48</div>

              <div class="line number49 index48 alt2">49</div>

              <div class="line number50 index49 alt1">50</div>

              <div class="line number51 index50 alt2">51</div>

              <div class="line number52 index51 alt1">52</div>

              <div class="line number53 index52 alt2">53</div>

              <div class="line number54 index53 alt1">54</div>

              <div class="line number55 index54 alt2">55</div>

              <div class="line number56 index55 alt1">56</div>

              <div class="line number57 index56 alt2">57</div>

              <div class="line number58 index57 alt1">58</div>

              <div class="line number59 index58 alt2">59</div>

              <div class="line number60 index59 alt1">60</div>

              <div class="line number61 index60 alt2">61</div>

              <div class="line number62 index61 alt1">62</div>

              <div class="line number63 index62 alt2">63</div>

              <div class="line number64 index63 alt1">64</div>

              <div class="line number65 index64 alt2">65</div>
            </td>
            <td class="code">
              <div class="container">
                <div class="line number1 index0 alt2"><code class="cpp keyword bold">static</code> <code class="cpp plain">ssize_t sock_aio_write(</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">kiocb *iocb, </code><code class="cpp keyword bold">const</code> <code class="cpp keyword bold">struct</code> <code class="cpp plain">iovec *iov, ..)</code></div>

                <div class="line number2 index1 alt1">&nbsp;</div>

                <div class="line number3 index2 alt2"><code class="cpp plain">{</code></div>

                <div class="line number4 index3 alt1">&nbsp;</div>

                <div class="line number5 index4 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number6 index5 alt1">&nbsp;</div>

                <div class="line number7 index6 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">socket *sock = file-&gt;private_data;</code></div>

                <div class="line number8 index7 alt1">&nbsp;</div>

                <div class="line number9 index8 alt2"><code class="cpp plain">[...] ===&gt;</code></div>

                <div class="line number10 index9 alt1">&nbsp;</div>

                <div class="line number11 index10 alt2"><code class="cpp keyword bold">return</code> <code class="cpp plain">sock-&gt;ops-&gt;sendmsg(iocb, sock, msg, size);</code></div>

                <div class="line number12 index11 alt1">&nbsp;</div>

                <div class="line number13 index12 alt2">&nbsp;</div>

                <div class="line number14 index13 alt1">&nbsp;</div>

                <div class="line number15 index14 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">socket {</code></div>

                <div class="line number16 index15 alt1">&nbsp;</div>

                <div class="line number17 index16 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number18 index17 alt1">&nbsp;</div>

                <div class="line number19 index18 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">file *file;</code></div>

                <div class="line number20 index19 alt1">&nbsp;</div>

                <div class="line number21 index20 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">sock *sk;</code></div>

                <div class="line number22 index21 alt1">&nbsp;</div>

                <div class="line number23 index22 alt2"><code class="cpp keyword bold">const</code> <code class="cpp keyword bold">struct</code> <code class="cpp plain">proto_ops *ops;</code></div>

                <div class="line number24 index23 alt1">&nbsp;</div>

                <div class="line number25 index24 alt2"><code class="cpp plain">};</code></div>

                <div class="line number26 index25 alt1">&nbsp;</div>

                <div class="line number27 index26 alt2">&nbsp;</div>

                <div class="line number28 index27 alt1">&nbsp;</div>

                <div class="line number29 index28 alt2"><code class="cpp keyword bold">const</code> <code class="cpp keyword bold">struct</code> <code class="cpp plain">proto_ops inet_stream_ops = {</code></div>

                <div class="line number30 index29 alt1">&nbsp;</div>

                <div class="line number31 index30 alt2"><code class="cpp plain">.family = PF_INET,</code></div>

                <div class="line number32 index31 alt1">&nbsp;</div>

                <div class="line number33 index32 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number34 index33 alt1">&nbsp;</div>

                <div class="line number35 index34 alt2"><code class="cpp plain">.connect = inet_stream_connect,</code></div>

                <div class="line number36 index35 alt1">&nbsp;</div>

                <div class="line number37 index36 alt2"><code class="cpp plain">.accept = inet_accept,</code></div>

                <div class="line number38 index37 alt1">&nbsp;</div>

                <div class="line number39 index38 alt2"><code class="cpp plain">.listen = inet_listen, .sendmsg = tcp_sendmsg,</code></div>

                <div class="line number40 index39 alt1">&nbsp;</div>

                <div class="line number41 index40 alt2"><code class="cpp plain">.recvmsg = inet_recvmsg,</code></div>

                <div class="line number42 index41 alt1">&nbsp;</div>

                <div class="line number43 index42 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number44 index43 alt1">&nbsp;</div>

                <div class="line number45 index44 alt2"><code class="cpp plain">};</code></div>

                <div class="line number46 index45 alt1">&nbsp;</div>

                <div class="line number47 index46 alt2">&nbsp;</div>

                <div class="line number48 index47 alt1">&nbsp;</div>

                <div class="line number49 index48 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">proto_ops {</code></div>

                <div class="line number50 index49 alt1">&nbsp;</div>

                <div class="line number51 index50 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number52 index51 alt1">&nbsp;</div>

                <div class="line number53 index52 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">(*connect) (</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">socket *sock, ...)</code></div>

                <div class="line number54 index53 alt1">&nbsp;</div>

                <div class="line number55 index54 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">(*accept) (</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">socket *sock, ...)</code></div>

                <div class="line number56 index55 alt1">&nbsp;</div>

                <div class="line number57 index56 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">(*listen) (</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">socket *sock, </code><code class="cpp color1 bold">int</code> <code class="cpp plain">len);</code></div>

                <div class="line number58 index57 alt1">&nbsp;</div>

                <div class="line number59 index58 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">(*sendmsg) (</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">kiocb *iocb, </code><code class="cpp keyword bold">struct</code> <code class="cpp plain">socket *sock, ...)</code></div>

                <div class="line number60 index59 alt1">&nbsp;</div>

                <div class="line number61 index60 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">(*recvmsg) (</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">kiocb *iocb, </code><code class="cpp keyword bold">struct</code> <code class="cpp plain">socket *sock, ...)</code></div>

                <div class="line number62 index61 alt1">&nbsp;</div>

                <div class="line number63 index62 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number64 index63 alt1">&nbsp;</div>

                <div class="line number65 index64 alt2"><code class="cpp plain">};</code></div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <p>The <code>sock_aio_write()</code> function gets the socket structure from the file and then calls <b>sendmsg</b>. It is also the function pointer. The socket structure includes the <b>proto_ops</b> function table. The proto_ops implemented by
    the
    IPv4 TCP is inet_stream_ops and the sendmsg is implemented by <b>tcp_sendmsg</b>.</p>

  <div>
    <div class="syntaxhighlighter  cpp" id="highlighter_414719">
      <div class="toolbar"><span><a class="toolbar_item command_help help" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#">?</a></span></div>

      <table border="0" cellpadding="0" cellspacing="0">
        <tbody>
          <tr>
            <td class="gutter">
              <div class="line number1 index0 alt2">1</div>

              <div class="line number2 index1 alt1">2</div>

              <div class="line number3 index2 alt2">3</div>

              <div class="line number4 index3 alt1">4</div>

              <div class="line number5 index4 alt2">5</div>

              <div class="line number6 index5 alt1">6</div>

              <div class="line number7 index6 alt2">7</div>

              <div class="line number8 index7 alt1">8</div>

              <div class="line number9 index8 alt2">9</div>

              <div class="line number10 index9 alt1">10</div>

              <div class="line number11 index10 alt2">11</div>

              <div class="line number12 index11 alt1">12</div>

              <div class="line number13 index12 alt2">13</div>

              <div class="line number14 index13 alt1">14</div>

              <div class="line number15 index14 alt2">15</div>

              <div class="line number16 index15 alt1">16</div>

              <div class="line number17 index16 alt2">17</div>

              <div class="line number18 index17 alt1">18</div>

              <div class="line number19 index18 alt2">19</div>

              <div class="line number20 index19 alt1">20</div>

              <div class="line number21 index20 alt2">21</div>

              <div class="line number22 index21 alt1">22</div>

              <div class="line number23 index22 alt2">23</div>

              <div class="line number24 index23 alt1">24</div>

              <div class="line number25 index24 alt2">25</div>

              <div class="line number26 index25 alt1">26</div>

              <div class="line number27 index26 alt2">27</div>

              <div class="line number28 index27 alt1">28</div>

              <div class="line number29 index28 alt2">29</div>

              <div class="line number30 index29 alt1">30</div>

              <div class="line number31 index30 alt2">31</div>

              <div class="line number32 index31 alt1">32</div>

              <div class="line number33 index32 alt2">33</div>

              <div class="line number34 index33 alt1">34</div>

              <div class="line number35 index34 alt2">35</div>

              <div class="line number36 index35 alt1">36</div>

              <div class="line number37 index36 alt2">37</div>

              <div class="line number38 index37 alt1">38</div>

              <div class="line number39 index38 alt2">39</div>

              <div class="line number40 index39 alt1">40</div>

              <div class="line number41 index40 alt2">41</div>

              <div class="line number42 index41 alt1">42</div>

              <div class="line number43 index42 alt2">43</div>

              <div class="line number44 index43 alt1">44</div>

              <div class="line number45 index44 alt2">45</div>

              <div class="line number46 index45 alt1">46</div>

              <div class="line number47 index46 alt2">47</div>

              <div class="line number48 index47 alt1">48</div>

              <div class="line number49 index48 alt2">49</div>

              <div class="line number50 index49 alt1">50</div>

              <div class="line number51 index50 alt2">51</div>

              <div class="line number52 index51 alt1">52</div>

              <div class="line number53 index52 alt2">53</div>

              <div class="line number54 index53 alt1">54</div>

              <div class="line number55 index54 alt2">55</div>

              <div class="line number56 index55 alt1">56</div>

              <div class="line number57 index56 alt2">57</div>

              <div class="line number58 index57 alt1">58</div>

              <div class="line number59 index58 alt2">59</div>

              <div class="line number60 index59 alt1">60</div>

              <div class="line number61 index60 alt2">61</div>

              <div class="line number62 index61 alt1">62</div>

              <div class="line number63 index62 alt2">63</div>

              <div class="line number64 index63 alt1">64</div>

              <div class="line number65 index64 alt2">65</div>

              <div class="line number66 index65 alt1">66</div>

              <div class="line number67 index66 alt2">67</div>

              <div class="line number68 index67 alt1">68</div>

              <div class="line number69 index68 alt2">69</div>

              <div class="line number70 index69 alt1">70</div>

              <div class="line number71 index70 alt2">71</div>

              <div class="line number72 index71 alt1">72</div>

              <div class="line number73 index72 alt2">73</div>

              <div class="line number74 index73 alt1">74</div>

              <div class="line number75 index74 alt2">75</div>

              <div class="line number76 index75 alt1">76</div>

              <div class="line number77 index76 alt2">77</div>

              <div class="line number78 index77 alt1">78</div>

              <div class="line number79 index78 alt2">79</div>

              <div class="line number80 index79 alt1">80</div>

              <div class="line number81 index80 alt2">81</div>

              <div class="line number82 index81 alt1">82</div>

              <div class="line number83 index82 alt2">83</div>

              <div class="line number84 index83 alt1">84</div>

              <div class="line number85 index84 alt2">85</div>

              <div class="line number86 index85 alt1">86</div>

              <div class="line number87 index86 alt2">87</div>

              <div class="line number88 index87 alt1">88</div>

              <div class="line number89 index88 alt2">89</div>

              <div class="line number90 index89 alt1">90</div>

              <div class="line number91 index90 alt2">91</div>

              <div class="line number92 index91 alt1">92</div>

              <div class="line number93 index92 alt2">93</div>

              <div class="line number94 index93 alt1">94</div>

              <div class="line number95 index94 alt2">95</div>

              <div class="line number96 index95 alt1">96</div>

              <div class="line number97 index96 alt2">97</div>
            </td>
            <td class="code">
              <div class="container">
                <div class="line number1 index0 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">tcp_sendmsg(</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">kiocb *iocb, </code><code class="cpp keyword bold">struct</code> <code class="cpp plain">socket *sock,</code></div>

                <div class="line number2 index1 alt1">&nbsp;</div>

                <div class="line number3 index2 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">msghdr *msg, </code><code class="cpp color1 bold">size_t</code> <code class="cpp plain">size)</code></div>

                <div class="line number4 index3 alt1">&nbsp;</div>

                <div class="line number5 index4 alt2"><code class="cpp plain">{</code></div>

                <div class="line number6 index5 alt1">&nbsp;</div>

                <div class="line number7 index6 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">sock *sk = sock-&gt;sk;</code></div>

                <div class="line number8 index7 alt1">&nbsp;</div>

                <div class="line number9 index8 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">iovec *iov;</code></div>

                <div class="line number10 index9 alt1">&nbsp;</div>

                <div class="line number11 index10 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">tcp_sock *tp = tcp_sk(sk);</code></div>

                <div class="line number12 index11 alt1">&nbsp;</div>

                <div class="line number13 index12 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">sk_buff *skb;</code></div>

                <div class="line number14 index13 alt1">&nbsp;</div>

                <div class="line number15 index14 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number16 index15 alt1">&nbsp;</div>

                <div class="line number17 index16 alt2"><code class="cpp plain">mss_now = tcp_send_mss(sk, &amp;size_goal, flags);</code></div>

                <div class="line number18 index17 alt1">&nbsp;</div>

                <div class="line number19 index18 alt2">&nbsp;</div>

                <div class="line number20 index19 alt1">&nbsp;</div>

                <div class="line number21 index20 alt2"><code class="cpp comments">/* Ok commence sending. */</code></div>

                <div class="line number22 index21 alt1">&nbsp;</div>

                <div class="line number23 index22 alt2"><code class="cpp plain">iovlen = msg-&gt;msg_iovlen;</code></div>

                <div class="line number24 index23 alt1">&nbsp;</div>

                <div class="line number25 index24 alt2"><code class="cpp plain">iov = msg-&gt;msg_iov;</code></div>

                <div class="line number26 index25 alt1">&nbsp;</div>

                <div class="line number27 index26 alt2"><code class="cpp plain">copied = 0;</code></div>

                <div class="line number28 index27 alt1">&nbsp;</div>

                <div class="line number29 index28 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number30 index29 alt1">&nbsp;</div>

                <div class="line number31 index30 alt2"><code class="cpp keyword bold">while</code> <code class="cpp plain">(--iovlen &gt;= 0) {</code></div>

                <div class="line number32 index31 alt1">&nbsp;</div>

                <div class="line number33 index32 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">seglen = iov-&gt;iov_len;</code></div>

                <div class="line number34 index33 alt1">&nbsp;</div>

                <div class="line number35 index34 alt2"><code class="cpp plain">unsigned </code><code class="cpp color1 bold">char</code> <code class="cpp plain">__user *from = iov-&gt;iov_base;</code></div>

                <div class="line number36 index35 alt1">&nbsp;</div>

                <div class="line number37 index36 alt2">&nbsp;</div>

                <div class="line number38 index37 alt1">&nbsp;</div>

                <div class="line number39 index38 alt2"><code class="cpp plain">iov++;</code></div>

                <div class="line number40 index39 alt1">&nbsp;</div>

                <div class="line number41 index40 alt2"><code class="cpp keyword bold">while</code> <code class="cpp plain">(seglen &gt; 0) {</code></div>

                <div class="line number42 index41 alt1">&nbsp;</div>

                <div class="line number43 index42 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">copy = 0;</code></div>

                <div class="line number44 index43 alt1">&nbsp;</div>

                <div class="line number45 index44 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">max = size_goal;</code></div>

                <div class="line number46 index45 alt1">&nbsp;</div>

                <div class="line number47 index46 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number48 index47 alt1">&nbsp;</div>

                <div class="line number49 index48 alt2"><code class="cpp plain">skb = sk_stream_alloc_skb(sk,</code></div>

                <div class="line number50 index49 alt1">&nbsp;</div>

                <div class="line number51 index50 alt2"><code class="cpp plain">select_size(sk, sg),</code></div>

                <div class="line number52 index51 alt1">&nbsp;</div>

                <div class="line number53 index52 alt2"><code class="cpp plain">sk-&gt;sk_allocation);</code></div>

                <div class="line number54 index53 alt1">&nbsp;</div>

                <div class="line number55 index54 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(!skb)</code></div>

                <div class="line number56 index55 alt1">&nbsp;</div>

                <div class="line number57 index56 alt2"><code class="cpp keyword bold">goto</code> <code class="cpp plain">wait_for_memory;</code></div>

                <div class="line number58 index57 alt1">&nbsp;</div>

                <div class="line number59 index58 alt2"><code class="cpp comments">/*</code></div>

                <div class="line number60 index59 alt1">&nbsp;</div>

                <div class="line number61 index60 alt2"><code class="cpp comments">* Check whether we can use HW checksum.</code></div>

                <div class="line number62 index61 alt1">&nbsp;</div>

                <div class="line number63 index62 alt2"><code class="cpp comments">*/</code></div>

                <div class="line number64 index63 alt1">&nbsp;</div>

                <div class="line number65 index64 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(sk-&gt;sk_route_caps &amp; NETIF_F_ALL_CSUM)</code></div>

                <div class="line number66 index65 alt1">&nbsp;</div>

                <div class="line number67 index66 alt2"><code class="cpp plain">skb-&gt;ip_summed = CHECKSUM_PARTIAL;</code></div>

                <div class="line number68 index67 alt1">&nbsp;</div>

                <div class="line number69 index68 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number70 index69 alt1">&nbsp;</div>

                <div class="line number71 index70 alt2"><code class="cpp plain">skb_entail(sk, skb);</code></div>

                <div class="line number72 index71 alt1">&nbsp;</div>

                <div class="line number73 index72 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number74 index73 alt1">&nbsp;</div>

                <div class="line number75 index74 alt2"><code class="cpp comments">/* Where to copy to? */</code></div>

                <div class="line number76 index75 alt1">&nbsp;</div>

                <div class="line number77 index76 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(skb_tailroom(skb) &gt; 0) {</code></div>

                <div class="line number78 index77 alt1">&nbsp;</div>

                <div class="line number79 index78 alt2"><code class="cpp comments">/* We have some space in skb head. Superb! */</code></div>

                <div class="line number80 index79 alt1">&nbsp;</div>

                <div class="line number81 index80 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(copy &gt; skb_tailroom(skb))</code></div>

                <div class="line number82 index81 alt1">&nbsp;</div>

                <div class="line number83 index82 alt2"><code class="cpp plain">copy = skb_tailroom(skb);</code></div>

                <div class="line number84 index83 alt1">&nbsp;</div>

                <div class="line number85 index84 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">((err = skb_add_data(skb, from, copy)) != 0)</code></div>

                <div class="line number86 index85 alt1">&nbsp;</div>

                <div class="line number87 index86 alt2"><code class="cpp keyword bold">goto</code> <code class="cpp plain">do_fault;</code></div>

                <div class="line number88 index87 alt1">&nbsp;</div>

                <div class="line number89 index88 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number90 index89 alt1">&nbsp;</div>

                <div class="line number91 index90 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(copied)</code></div>

                <div class="line number92 index91 alt1">&nbsp;</div>

                <div class="line number93 index92 alt2"><code class="cpp plain">tcp_push(sk, flags, mss_now, tp-&gt;nonagle);</code></div>

                <div class="line number94 index93 alt1">&nbsp;</div>

                <div class="line number95 index94 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number96 index95 alt1">&nbsp;</div>

                <div class="line number97 index96 alt2"><code class="cpp plain">}</code></div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <p><b>tcp_sengmsg</b> gets tcp_sock (i.e.,TCP control block) from the socket and copies the data that the application has requested to transmit to the send socket buffer. When copying data to sk_buff, how many bytes will one sk_buff include? One
    sk_buff copies and includes MSS (tcp_send_mss) bytes to help the code that actually creates packets. Maximum Segment Size (MSS) stands for the maximum payload size that one TCP packet includes. By using TSO and GSO, one sk_buff can save more data
    than MSS. This will be discussed later, not in this document.</p>

  <p>The <b>sk_stream_alloc_skb</b> function creates a new <b>sk_buff</b>, and <b>skb_entail</b> adds the new <b>sk_buff</b> to the tail of the <b>send_socket_buffer</b>. The <b>skb_add_data</b> function copies the actual application data to the data
    buffer of the <b>sk_buff</b>. All the data is copied by repeating the procedure (creating an <b>sk_buff</b> and adding it to the send socket buffer) several times. Therefore, <b>sk_buffs</b> at the size of the MSS are in the send socket buffer as
    a
    list. Finally, the <b>tcp_push</b> is called to make the data which can be transmitted now as a packet, and the packet is sent.</p>

  <div>
    <div class="syntaxhighlighter  cpp" id="highlighter_366912">
      <div class="toolbar"><span><a class="toolbar_item command_help help" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#">?</a></span></div>

      <table border="0" cellpadding="0" cellspacing="0">
        <tbody>
          <tr>
            <td class="gutter">
              <div class="line number1 index0 alt2">1</div>

              <div class="line number2 index1 alt1">2</div>

              <div class="line number3 index2 alt2">3</div>

              <div class="line number4 index3 alt1">4</div>

              <div class="line number5 index4 alt2">5</div>

              <div class="line number6 index5 alt1">6</div>

              <div class="line number7 index6 alt2">7</div>

              <div class="line number8 index7 alt1">8</div>

              <div class="line number9 index8 alt2">9</div>

              <div class="line number10 index9 alt1">10</div>

              <div class="line number11 index10 alt2">11</div>

              <div class="line number12 index11 alt1">12</div>

              <div class="line number13 index12 alt2">13</div>

              <div class="line number14 index13 alt1">14</div>

              <div class="line number15 index14 alt2">15</div>

              <div class="line number16 index15 alt1">16</div>

              <div class="line number17 index16 alt2">17</div>

              <div class="line number18 index17 alt1">18</div>

              <div class="line number19 index18 alt2">19</div>

              <div class="line number20 index19 alt1">20</div>

              <div class="line number21 index20 alt2">21</div>

              <div class="line number22 index21 alt1">22</div>

              <div class="line number23 index22 alt2">23</div>

              <div class="line number24 index23 alt1">24</div>

              <div class="line number25 index24 alt2">25</div>

              <div class="line number26 index25 alt1">26</div>

              <div class="line number27 index26 alt2">27</div>

              <div class="line number28 index27 alt1">28</div>

              <div class="line number29 index28 alt2">29</div>

              <div class="line number30 index29 alt1">30</div>

              <div class="line number31 index30 alt2">31</div>

              <div class="line number32 index31 alt1">32</div>

              <div class="line number33 index32 alt2">33</div>

              <div class="line number34 index33 alt1">34</div>

              <div class="line number35 index34 alt2">35</div>

              <div class="line number36 index35 alt1">36</div>

              <div class="line number37 index36 alt2">37</div>

              <div class="line number38 index37 alt1">38</div>

              <div class="line number39 index38 alt2">39</div>

              <div class="line number40 index39 alt1">40</div>

              <div class="line number41 index40 alt2">41</div>

              <div class="line number42 index41 alt1">42</div>

              <div class="line number43 index42 alt2">43</div>

              <div class="line number44 index43 alt1">44</div>

              <div class="line number45 index44 alt2">45</div>

              <div class="line number46 index45 alt1">46</div>

              <div class="line number47 index46 alt2">47</div>

              <div class="line number48 index47 alt1">48</div>

              <div class="line number49 index48 alt2">49</div>
            </td>
            <td class="code">
              <div class="container">
                <div class="line number1 index0 alt2"><code class="cpp keyword bold">static</code> <code class="cpp keyword bold">inline</code> <code class="cpp keyword bold">void</code> <code class="cpp plain">tcp_push(</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">sock *sk, </code><code class="cpp color1 bold">int</code> <code class="cpp plain">flags, </code><code class="cpp color1 bold">int</code> <code class="cpp plain">mss_now,
                    ...)</code></div>

                <div class="line number2 index1 alt1">&nbsp;</div>

                <div class="line number3 index2 alt2"><code class="cpp plain">[...] ===&gt;</code></div>

                <div class="line number4 index3 alt1">&nbsp;</div>

                <div class="line number5 index4 alt2"><code class="cpp keyword bold">static</code> <code class="cpp color1 bold">int</code> <code class="cpp plain">tcp_write_xmit(</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">sock *sk, unsigned </code><code class="cpp color1 bold">int</code> <code class="cpp plain">mss_now, ...)</code></div>

                <div class="line number6 index5 alt1">&nbsp;</div>

                <div class="line number7 index6 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">nonagle,</code></div>

                <div class="line number8 index7 alt1">&nbsp;</div>

                <div class="line number9 index8 alt2"><code class="cpp plain">{</code></div>

                <div class="line number10 index9 alt1">&nbsp;</div>

                <div class="line number11 index10 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">tcp_sock *tp = tcp_sk(sk);</code></div>

                <div class="line number12 index11 alt1">&nbsp;</div>

                <div class="line number13 index12 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">sk_buff *skb;</code></div>

                <div class="line number14 index13 alt1">&nbsp;</div>

                <div class="line number15 index14 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number16 index15 alt1">&nbsp;</div>

                <div class="line number17 index16 alt2"><code class="cpp keyword bold">while</code> <code class="cpp plain">((skb = tcp_send_head(sk))) {</code></div>

                <div class="line number18 index17 alt1">&nbsp;</div>

                <div class="line number19 index18 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number20 index19 alt1">&nbsp;</div>

                <div class="line number21 index20 alt2"><code class="cpp plain">cwnd_quota = tcp_cwnd_test(tp, skb);</code></div>

                <div class="line number22 index21 alt1">&nbsp;</div>

                <div class="line number23 index22 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(!cwnd_quota)</code></div>

                <div class="line number24 index23 alt1">&nbsp;</div>

                <div class="line number25 index24 alt2"><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div>

                <div class="line number26 index25 alt1">&nbsp;</div>

                <div class="line number27 index26 alt2">&nbsp;</div>

                <div class="line number28 index27 alt1">&nbsp;</div>

                <div class="line number29 index28 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(unlikely(!tcp_snd_wnd_test(tp, skb, mss_now)))</code></div>

                <div class="line number30 index29 alt1">&nbsp;</div>

                <div class="line number31 index30 alt2"><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div>

                <div class="line number32 index31 alt1">&nbsp;</div>

                <div class="line number33 index32 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number34 index33 alt1">&nbsp;</div>

                <div class="line number35 index34 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(unlikely(tcp_transmit_skb(sk, skb, 1, gfp)))</code></div>

                <div class="line number36 index35 alt1">&nbsp;</div>

                <div class="line number37 index36 alt2"><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div>

                <div class="line number38 index37 alt1">&nbsp;</div>

                <div class="line number39 index38 alt2">&nbsp;</div>

                <div class="line number40 index39 alt1">&nbsp;</div>

                <div class="line number41 index40 alt2"><code class="cpp comments">/* Advance the send_head. This one is sent out.</code></div>

                <div class="line number42 index41 alt1">&nbsp;</div>

                <div class="line number43 index42 alt2"><code class="cpp comments">* This call will increment packets_out.</code></div>

                <div class="line number44 index43 alt1">&nbsp;</div>

                <div class="line number45 index44 alt2"><code class="cpp comments">*/</code></div>

                <div class="line number46 index45 alt1">&nbsp;</div>

                <div class="line number47 index46 alt2"><code class="cpp plain">tcp_event_new_data_sent(sk, skb);</code></div>

                <div class="line number48 index47 alt1">&nbsp;</div>

                <div class="line number49 index48 alt2"><code class="cpp plain">[...]</code></div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <p>The <b>tcp_push</b> function transmits as many of the <b>sk_buffs</b> in the send socket buffer as the TCP allows in sequence. First, the <b>tcp_send_head</b> is called to get the first <b>sk_buff</b> in the socket buffer and the
    <b>tcp_cwnd_test</b> and the <b>tcp_snd_wnd_test</b> are performed to check whether the congestion window and the receive window of the receiving TCP allow new packets to be transmitted. Then, the <b>tcp_transmit_skb</b> function is called to
    create a packet.</p>

  <div>
    <div class="syntaxhighlighter  cpp" id="highlighter_170002">
      <div class="toolbar"><span><a class="toolbar_item command_help help" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#">?</a></span></div>

      <table border="0" cellpadding="0" cellspacing="0">
        <tbody>
          <tr>
            <td class="gutter">
              <div class="line number1 index0 alt2">1</div>

              <div class="line number2 index1 alt1">2</div>

              <div class="line number3 index2 alt2">3</div>

              <div class="line number4 index3 alt1">4</div>

              <div class="line number5 index4 alt2">5</div>

              <div class="line number6 index5 alt1">6</div>

              <div class="line number7 index6 alt2">7</div>

              <div class="line number8 index7 alt1">8</div>

              <div class="line number9 index8 alt2">9</div>

              <div class="line number10 index9 alt1">10</div>

              <div class="line number11 index10 alt2">11</div>

              <div class="line number12 index11 alt1">12</div>

              <div class="line number13 index12 alt2">13</div>

              <div class="line number14 index13 alt1">14</div>

              <div class="line number15 index14 alt2">15</div>

              <div class="line number16 index15 alt1">16</div>

              <div class="line number17 index16 alt2">17</div>

              <div class="line number18 index17 alt1">18</div>

              <div class="line number19 index18 alt2">19</div>

              <div class="line number20 index19 alt1">20</div>

              <div class="line number21 index20 alt2">21</div>

              <div class="line number22 index21 alt1">22</div>

              <div class="line number23 index22 alt2">23</div>

              <div class="line number24 index23 alt1">24</div>

              <div class="line number25 index24 alt2">25</div>

              <div class="line number26 index25 alt1">26</div>

              <div class="line number27 index26 alt2">27</div>

              <div class="line number28 index27 alt1">28</div>

              <div class="line number29 index28 alt2">29</div>

              <div class="line number30 index29 alt1">30</div>

              <div class="line number31 index30 alt2">31</div>

              <div class="line number32 index31 alt1">32</div>

              <div class="line number33 index32 alt2">33</div>

              <div class="line number34 index33 alt1">34</div>

              <div class="line number35 index34 alt2">35</div>

              <div class="line number36 index35 alt1">36</div>

              <div class="line number37 index36 alt2">37</div>

              <div class="line number38 index37 alt1">38</div>

              <div class="line number39 index38 alt2">39</div>

              <div class="line number40 index39 alt1">40</div>

              <div class="line number41 index40 alt2">41</div>

              <div class="line number42 index41 alt1">42</div>

              <div class="line number43 index42 alt2">43</div>

              <div class="line number44 index43 alt1">44</div>

              <div class="line number45 index44 alt2">45</div>

              <div class="line number46 index45 alt1">46</div>

              <div class="line number47 index46 alt2">47</div>

              <div class="line number48 index47 alt1">48</div>

              <div class="line number49 index48 alt2">49</div>

              <div class="line number50 index49 alt1">50</div>

              <div class="line number51 index50 alt2">51</div>

              <div class="line number52 index51 alt1">52</div>

              <div class="line number53 index52 alt2">53</div>

              <div class="line number54 index53 alt1">54</div>

              <div class="line number55 index54 alt2">55</div>

              <div class="line number56 index55 alt1">56</div>

              <div class="line number57 index56 alt2">57</div>

              <div class="line number58 index57 alt1">58</div>

              <div class="line number59 index58 alt2">59</div>

              <div class="line number60 index59 alt1">60</div>

              <div class="line number61 index60 alt2">61</div>

              <div class="line number62 index61 alt1">62</div>

              <div class="line number63 index62 alt2">63</div>

              <div class="line number64 index63 alt1">64</div>

              <div class="line number65 index64 alt2">65</div>

              <div class="line number66 index65 alt1">66</div>

              <div class="line number67 index66 alt2">67</div>

              <div class="line number68 index67 alt1">68</div>

              <div class="line number69 index68 alt2">69</div>

              <div class="line number70 index69 alt1">70</div>

              <div class="line number71 index70 alt2">71</div>

              <div class="line number72 index71 alt1">72</div>

              <div class="line number73 index72 alt2">73</div>

              <div class="line number74 index73 alt1">74</div>

              <div class="line number75 index74 alt2">75</div>

              <div class="line number76 index75 alt1">76</div>

              <div class="line number77 index76 alt2">77</div>

              <div class="line number78 index77 alt1">78</div>

              <div class="line number79 index78 alt2">79</div>
            </td>
            <td class="code">
              <div class="container">
                <div class="line number1 index0 alt2"><code class="cpp keyword bold">static</code> <code class="cpp color1 bold">int</code> <code class="cpp plain">tcp_transmit_skb(</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">sock *sk, </code><code class="cpp keyword bold">struct</code> <code class="cpp plain">sk_buff *skb,</code></div>

                <div class="line number2 index1 alt1">&nbsp;</div>

                <div class="line number3 index2 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">clone_it, gfp_t gfp_mask)</code></div>

                <div class="line number4 index3 alt1">&nbsp;</div>

                <div class="line number5 index4 alt2"><code class="cpp plain">{</code></div>

                <div class="line number6 index5 alt1">&nbsp;</div>

                <div class="line number7 index6 alt2"><code class="cpp keyword bold">const</code> <code class="cpp keyword bold">struct</code> <code class="cpp plain">inet_connection_sock *icsk = inet_csk(sk);</code></div>

                <div class="line number8 index7 alt1">&nbsp;</div>

                <div class="line number9 index8 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">inet_sock *inet;</code></div>

                <div class="line number10 index9 alt1">&nbsp;</div>

                <div class="line number11 index10 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">tcp_sock *tp;</code></div>

                <div class="line number12 index11 alt1">&nbsp;</div>

                <div class="line number13 index12 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number14 index13 alt1">&nbsp;</div>

                <div class="line number15 index14 alt2">&nbsp;</div>

                <div class="line number16 index15 alt1">&nbsp;</div>

                <div class="line number17 index16 alt2">&nbsp;</div>

                <div class="line number18 index17 alt1">&nbsp;</div>

                <div class="line number19 index18 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(likely(clone_it)) {</code></div>

                <div class="line number20 index19 alt1">&nbsp;</div>

                <div class="line number21 index20 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(unlikely(skb_cloned(skb)))</code></div>

                <div class="line number22 index21 alt1">&nbsp;</div>

                <div class="line number23 index22 alt2"><code class="cpp plain">skb = pskb_copy(skb, gfp_mask);</code></div>

                <div class="line number24 index23 alt1">&nbsp;</div>

                <div class="line number25 index24 alt2"><code class="cpp keyword bold">else</code></div>

                <div class="line number26 index25 alt1">&nbsp;</div>

                <div class="line number27 index26 alt2"><code class="cpp plain">skb = skb_clone(skb, gfp_mask);</code></div>

                <div class="line number28 index27 alt1">&nbsp;</div>

                <div class="line number29 index28 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(unlikely(!skb))</code></div>

                <div class="line number30 index29 alt1">&nbsp;</div>

                <div class="line number31 index30 alt2"><code class="cpp keyword bold">return</code> <code class="cpp plain">-ENOBUFS;</code></div>

                <div class="line number32 index31 alt1">&nbsp;</div>

                <div class="line number33 index32 alt2"><code class="cpp plain">}</code></div>

                <div class="line number34 index33 alt1">&nbsp;</div>

                <div class="line number35 index34 alt2">&nbsp;</div>

                <div class="line number36 index35 alt1">&nbsp;</div>

                <div class="line number37 index36 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number38 index37 alt1">&nbsp;</div>

                <div class="line number39 index38 alt2"><code class="cpp plain">skb_push(skb, tcp_header_size);</code></div>

                <div class="line number40 index39 alt1">&nbsp;</div>

                <div class="line number41 index40 alt2"><code class="cpp plain">skb_reset_transport_header(skb);</code></div>

                <div class="line number42 index41 alt1">&nbsp;</div>

                <div class="line number43 index42 alt2"><code class="cpp plain">skb_set_owner_w(skb, sk);</code></div>

                <div class="line number44 index43 alt1">&nbsp;</div>

                <div class="line number45 index44 alt2">&nbsp;</div>

                <div class="line number46 index45 alt1">&nbsp;</div>

                <div class="line number47 index46 alt2"><code class="cpp comments">/* Build TCP header and checksum it. */</code></div>

                <div class="line number48 index47 alt1">&nbsp;</div>

                <div class="line number49 index48 alt2"><code class="cpp plain">th = tcp_hdr(skb);</code></div>

                <div class="line number50 index49 alt1">&nbsp;</div>

                <div class="line number51 index50 alt2"><code class="cpp plain">th-&gt;source = inet-&gt;inet_sport;</code></div>

                <div class="line number52 index51 alt1">&nbsp;</div>

                <div class="line number53 index52 alt2"><code class="cpp plain">th-&gt;dest = inet-&gt;inet_dport;</code></div>

                <div class="line number54 index53 alt1">&nbsp;</div>

                <div class="line number55 index54 alt2"><code class="cpp plain">th-&gt;seq = htonl(tcb-&gt;seq);</code></div>

                <div class="line number56 index55 alt1">&nbsp;</div>

                <div class="line number57 index56 alt2"><code class="cpp plain">th-&gt;ack_seq = htonl(tp-&gt;rcv_nxt);</code></div>

                <div class="line number58 index57 alt1">&nbsp;</div>

                <div class="line number59 index58 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number60 index59 alt1">&nbsp;</div>

                <div class="line number61 index60 alt2"><code class="cpp plain">icsk-&gt;icsk_af_ops-&gt;send_check(sk, skb);</code></div>

                <div class="line number62 index61 alt1">&nbsp;</div>

                <div class="line number63 index62 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number64 index63 alt1">&nbsp;</div>

                <div class="line number65 index64 alt2"><code class="cpp plain">err = icsk-&gt;icsk_af_ops-&gt;queue_xmit(skb);</code></div>

                <div class="line number66 index65 alt1">&nbsp;</div>

                <div class="line number67 index66 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(likely(err &lt;= 0))</code></div>

                <div class="line number68 index67 alt1">&nbsp;</div>

                <div class="line number69 index68 alt2"><code class="cpp keyword bold">return</code> <code class="cpp plain">err;</code></div>

                <div class="line number70 index69 alt1">&nbsp;</div>

                <div class="line number71 index70 alt2">&nbsp;</div>

                <div class="line number72 index71 alt1">&nbsp;</div>

                <div class="line number73 index72 alt2"><code class="cpp plain">tcp_enter_cwr(sk, 1);</code></div>

                <div class="line number74 index73 alt1">&nbsp;</div>

                <div class="line number75 index74 alt2">&nbsp;</div>

                <div class="line number76 index75 alt1">&nbsp;</div>

                <div class="line number77 index76 alt2"><code class="cpp keyword bold">return</code> <code class="cpp plain">net_xmit_eval(err);</code></div>

                <div class="line number78 index77 alt1">&nbsp;</div>

                <div class="line number79 index78 alt2"><code class="cpp plain">}</code></div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <p><b>tcp_transmit_skb</b> creates the copy of the given <b>sk_buff</b> (pskb_copy). At this time, it does not copy the entire data of the application but the metadata. And then it calls <b>skb_push</b> to secure the header area and records the
    header field value. Send_check computes the TCP checksum. With the checksum offload, the payload data is not computed. Finally, <b>queue_xmit</b> is called to send the packet to the IP layer. Queue_xmit for IPv4 is implemented by the
    <b>ip_queue_xmit</b> function.</p>

  <div>
    <div class="syntaxhighlighter  cpp" id="highlighter_703115">
      <div class="toolbar"><span><a class="toolbar_item command_help help" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#">?</a></span></div>

      <table border="0" cellpadding="0" cellspacing="0">
        <tbody>
          <tr>
            <td class="gutter">
              <div class="line number1 index0 alt2">1</div>

              <div class="line number2 index1 alt1">2</div>

              <div class="line number3 index2 alt2">3</div>

              <div class="line number4 index3 alt1">4</div>

              <div class="line number5 index4 alt2">5</div>

              <div class="line number6 index5 alt1">6</div>

              <div class="line number7 index6 alt2">7</div>

              <div class="line number8 index7 alt1">8</div>

              <div class="line number9 index8 alt2">9</div>

              <div class="line number10 index9 alt1">10</div>

              <div class="line number11 index10 alt2">11</div>

              <div class="line number12 index11 alt1">12</div>

              <div class="line number13 index12 alt2">13</div>

              <div class="line number14 index13 alt1">14</div>

              <div class="line number15 index14 alt2">15</div>

              <div class="line number16 index15 alt1">16</div>

              <div class="line number17 index16 alt2">17</div>

              <div class="line number18 index17 alt1">18</div>

              <div class="line number19 index18 alt2">19</div>

              <div class="line number20 index19 alt1">20</div>

              <div class="line number21 index20 alt2">21</div>

              <div class="line number22 index21 alt1">22</div>

              <div class="line number23 index22 alt2">23</div>

              <div class="line number24 index23 alt1">24</div>

              <div class="line number25 index24 alt2">25</div>

              <div class="line number26 index25 alt1">26</div>

              <div class="line number27 index26 alt2">27</div>

              <div class="line number28 index27 alt1">28</div>

              <div class="line number29 index28 alt2">29</div>

              <div class="line number30 index29 alt1">30</div>

              <div class="line number31 index30 alt2">31</div>

              <div class="line number32 index31 alt1">32</div>

              <div class="line number33 index32 alt2">33</div>

              <div class="line number34 index33 alt1">34</div>

              <div class="line number35 index34 alt2">35</div>

              <div class="line number36 index35 alt1">36</div>

              <div class="line number37 index36 alt2">37</div>

              <div class="line number38 index37 alt1">38</div>

              <div class="line number39 index38 alt2">39</div>

              <div class="line number40 index39 alt1">40</div>

              <div class="line number41 index40 alt2">41</div>

              <div class="line number42 index41 alt1">42</div>

              <div class="line number43 index42 alt2">43</div>

              <div class="line number44 index43 alt1">44</div>

              <div class="line number45 index44 alt2">45</div>

              <div class="line number46 index45 alt1">46</div>

              <div class="line number47 index46 alt2">47</div>

              <div class="line number48 index47 alt1">48</div>

              <div class="line number49 index48 alt2">49</div>

              <div class="line number50 index49 alt1">50</div>

              <div class="line number51 index50 alt2">51</div>

              <div class="line number52 index51 alt1">52</div>

              <div class="line number53 index52 alt2">53</div>

              <div class="line number54 index53 alt1">54</div>

              <div class="line number55 index54 alt2">55</div>

              <div class="line number56 index55 alt1">56</div>

              <div class="line number57 index56 alt2">57</div>

              <div class="line number58 index57 alt1">58</div>

              <div class="line number59 index58 alt2">59</div>

              <div class="line number60 index59 alt1">60</div>

              <div class="line number61 index60 alt2">61</div>

              <div class="line number62 index61 alt1">62</div>

              <div class="line number63 index62 alt2">63</div>

              <div class="line number64 index63 alt1">64</div>

              <div class="line number65 index64 alt2">65</div>

              <div class="line number66 index65 alt1">66</div>

              <div class="line number67 index66 alt2">67</div>

              <div class="line number68 index67 alt1">68</div>

              <div class="line number69 index68 alt2">69</div>

              <div class="line number70 index69 alt1">70</div>

              <div class="line number71 index70 alt2">71</div>

              <div class="line number72 index71 alt1">72</div>

              <div class="line number73 index72 alt2">73</div>

              <div class="line number74 index73 alt1">74</div>

              <div class="line number75 index74 alt2">75</div>

              <div class="line number76 index75 alt1">76</div>

              <div class="line number77 index76 alt2">77</div>

              <div class="line number78 index77 alt1">78</div>

              <div class="line number79 index78 alt2">79</div>

              <div class="line number80 index79 alt1">80</div>

              <div class="line number81 index80 alt2">81</div>

              <div class="line number82 index81 alt1">82</div>

              <div class="line number83 index82 alt2">83</div>
            </td>
            <td class="code">
              <div class="container">
                <div class="line number1 index0 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">ip_queue_xmit(</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">sk_buff *skb)</code></div>

                <div class="line number2 index1 alt1">&nbsp;</div>

                <div class="line number3 index2 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number4 index3 alt1">&nbsp;</div>

                <div class="line number5 index4 alt2"><code class="cpp plain">rt = (</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">rtable *)__sk_dst_check(sk, 0);</code></div>

                <div class="line number6 index5 alt1">&nbsp;</div>

                <div class="line number7 index6 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number8 index7 alt1">&nbsp;</div>

                <div class="line number9 index8 alt2"><code class="cpp comments">/* OK, we know where to send it, allocate and build IP header. */</code></div>

                <div class="line number10 index9 alt1">&nbsp;</div>

                <div class="line number11 index10 alt2"><code class="cpp plain">skb_push(skb, </code><code class="cpp keyword bold">sizeof</code><code class="cpp plain">(</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">iphdr)
                    + (opt ? opt-&gt;optlen : 0));</code></div>

                <div class="line number12 index11 alt1">&nbsp;</div>

                <div class="line number13 index12 alt2"><code class="cpp plain">skb_reset_network_header(skb);</code></div>

                <div class="line number14 index13 alt1">&nbsp;</div>

                <div class="line number15 index14 alt2"><code class="cpp plain">iph = ip_hdr(skb);</code></div>

                <div class="line number16 index15 alt1">&nbsp;</div>

                <div class="line number17 index16 alt2"><code class="cpp plain">*((__be16 *)iph) = htons((4 &lt;&lt; 12) | (5 &lt;&lt; 8) | (inet-&gt;tos &amp; 0xff));</code></div>

                <div class="line number18 index17 alt1">&nbsp;</div>

                <div class="line number19 index18 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(ip_dont_fragment(sk, &amp;rt-&gt;dst) &amp;&amp; !skb-&gt;local_df)</code></div>

                <div class="line number20 index19 alt1">&nbsp;</div>

                <div class="line number21 index20 alt2"><code class="cpp plain">iph-&gt;frag_off = htons(IP_DF);</code></div>

                <div class="line number22 index21 alt1">&nbsp;</div>

                <div class="line number23 index22 alt2"><code class="cpp keyword bold">else</code></div>

                <div class="line number24 index23 alt1">&nbsp;</div>

                <div class="line number25 index24 alt2"><code class="cpp plain">iph-&gt;frag_off = 0;</code></div>

                <div class="line number26 index25 alt1">&nbsp;</div>

                <div class="line number27 index26 alt2"><code class="cpp plain">iph-&gt;ttl = ip_select_ttl(inet, &amp;rt-&gt;dst);</code></div>

                <div class="line number28 index27 alt1">&nbsp;</div>

                <div class="line number29 index28 alt2"><code class="cpp plain">iph-&gt;protocol = sk-&gt;sk_protocol;</code></div>

                <div class="line number30 index29 alt1">&nbsp;</div>

                <div class="line number31 index30 alt2"><code class="cpp plain">iph-&gt;saddr = rt-&gt;rt_src;</code></div>

                <div class="line number32 index31 alt1">&nbsp;</div>

                <div class="line number33 index32 alt2"><code class="cpp plain">iph-&gt;daddr = rt-&gt;rt_dst;</code></div>

                <div class="line number34 index33 alt1">&nbsp;</div>

                <div class="line number35 index34 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number36 index35 alt1">&nbsp;</div>

                <div class="line number37 index36 alt2"><code class="cpp plain">res = ip_local_out(skb);</code></div>

                <div class="line number38 index37 alt1">&nbsp;</div>

                <div class="line number39 index38 alt2"><code class="cpp plain">[...] ===&gt;</code></div>

                <div class="line number40 index39 alt1">&nbsp;</div>

                <div class="line number41 index40 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">__ip_local_out(</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">sk_buff *skb)</code></div>

                <div class="line number42 index41 alt1">&nbsp;</div>

                <div class="line number43 index42 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number44 index43 alt1">&nbsp;</div>

                <div class="line number45 index44 alt2"><code class="cpp plain">ip_send_check(iph);</code></div>

                <div class="line number46 index45 alt1">&nbsp;</div>

                <div class="line number47 index46 alt2"><code class="cpp keyword bold">return</code> <code class="cpp plain">nf_hook(NFPROTO_IPV4, NF_INET_LOCAL_OUT, skb, NULL,</code></div>

                <div class="line number48 index47 alt1">&nbsp;</div>

                <div class="line number49 index48 alt2"><code class="cpp plain">skb_dst(skb)-&gt;dev, dst_output);</code></div>

                <div class="line number50 index49 alt1">&nbsp;</div>

                <div class="line number51 index50 alt2"><code class="cpp plain">[...] ===&gt;</code></div>

                <div class="line number52 index51 alt1">&nbsp;</div>

                <div class="line number53 index52 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">ip_output(</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">sk_buff *skb)</code></div>

                <div class="line number54 index53 alt1">&nbsp;</div>

                <div class="line number55 index54 alt2"><code class="cpp plain">{</code></div>

                <div class="line number56 index55 alt1">&nbsp;</div>

                <div class="line number57 index56 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">net_device *dev = skb_dst(skb)-&gt;dev;</code></div>

                <div class="line number58 index57 alt1">&nbsp;</div>

                <div class="line number59 index58 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number60 index59 alt1">&nbsp;</div>

                <div class="line number61 index60 alt2"><code class="cpp plain">skb-&gt;dev = dev;</code></div>

                <div class="line number62 index61 alt1">&nbsp;</div>

                <div class="line number63 index62 alt2"><code class="cpp plain">skb-&gt;protocol = htons(ETH_P_IP);</code></div>

                <div class="line number64 index63 alt1">&nbsp;</div>

                <div class="line number65 index64 alt2">&nbsp;</div>

                <div class="line number66 index65 alt1">&nbsp;</div>

                <div class="line number67 index66 alt2"><code class="cpp keyword bold">return</code> <code class="cpp plain">NF_HOOK_COND(NFPROTO_IPV4, NF_INET_POST_ROUTING, skb, NULL, dev,</code></div>

                <div class="line number68 index67 alt1">&nbsp;</div>

                <div class="line number69 index68 alt2"><code class="cpp plain">ip_finish_output,</code></div>

                <div class="line number70 index69 alt1">&nbsp;</div>

                <div class="line number71 index70 alt2"><code class="cpp plain">[...] ===&gt;</code></div>

                <div class="line number72 index71 alt1">&nbsp;</div>

                <div class="line number73 index72 alt2"><code class="cpp keyword bold">static</code> <code class="cpp color1 bold">int</code> <code class="cpp plain">ip_finish_output(</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">sk_buff *skb)</code></div>

                <div class="line number74 index73 alt1">&nbsp;</div>

                <div class="line number75 index74 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number76 index75 alt1">&nbsp;</div>

                <div class="line number77 index76 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(skb-&gt;len &gt; ip_skb_dst_mtu(skb) &amp;&amp; !skb_is_gso(skb))</code></div>

                <div class="line number78 index77 alt1">&nbsp;</div>

                <div class="line number79 index78 alt2"><code class="cpp keyword bold">return</code> <code class="cpp plain">ip_fragment(skb, ip_finish_output2);</code></div>

                <div class="line number80 index79 alt1">&nbsp;</div>

                <div class="line number81 index80 alt2"><code class="cpp keyword bold">else</code></div>

                <div class="line number82 index81 alt1">&nbsp;</div>

                <div class="line number83 index82 alt2"><code class="cpp keyword bold">return</code> <code class="cpp plain">ip_finish_output2(skb);</code></div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <p>The <b>ip_queue_xmit</b> function executes tasks required by the IP layers. <b>__sk_dst_check</b> checks whether the cached route is valid. If there is no cached route or the cached route is invalid, it performs IP routing. And then it calls
    skb_push to secure the IP header area and records the IP header field value. After that, as following the function call, <b>ip_send_check</b> computes the IP header checksum and calls the netfilter function. IP fragment is created when
    <b>ip_finish_output</b> function needs IP fragmentation. No fragmentation is generated when TCP is used. Therefore, ip_finish_output2 is called and it adds the Ethernet header. Finally, a packet is completed.</p>

  <div>
    <div class="syntaxhighlighter  cpp" id="highlighter_578430">
      <div class="toolbar"><span><a class="toolbar_item command_help help" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#">?</a></span></div>

      <table border="0" cellpadding="0" cellspacing="0">
        <tbody>
          <tr>
            <td class="gutter">
              <div class="line number1 index0 alt2">1</div>

              <div class="line number2 index1 alt1">2</div>

              <div class="line number3 index2 alt2">3</div>

              <div class="line number4 index3 alt1">4</div>

              <div class="line number5 index4 alt2">5</div>

              <div class="line number6 index5 alt1">6</div>

              <div class="line number7 index6 alt2">7</div>

              <div class="line number8 index7 alt1">8</div>

              <div class="line number9 index8 alt2">9</div>

              <div class="line number10 index9 alt1">10</div>

              <div class="line number11 index10 alt2">11</div>

              <div class="line number12 index11 alt1">12</div>

              <div class="line number13 index12 alt2">13</div>

              <div class="line number14 index13 alt1">14</div>

              <div class="line number15 index14 alt2">15</div>

              <div class="line number16 index15 alt1">16</div>

              <div class="line number17 index16 alt2">17</div>

              <div class="line number18 index17 alt1">18</div>

              <div class="line number19 index18 alt2">19</div>

              <div class="line number20 index19 alt1">20</div>

              <div class="line number21 index20 alt2">21</div>

              <div class="line number22 index21 alt1">22</div>

              <div class="line number23 index22 alt2">23</div>

              <div class="line number24 index23 alt1">24</div>

              <div class="line number25 index24 alt2">25</div>

              <div class="line number26 index25 alt1">26</div>

              <div class="line number27 index26 alt2">27</div>

              <div class="line number28 index27 alt1">28</div>

              <div class="line number29 index28 alt2">29</div>

              <div class="line number30 index29 alt1">30</div>

              <div class="line number31 index30 alt2">31</div>

              <div class="line number32 index31 alt1">32</div>

              <div class="line number33 index32 alt2">33</div>

              <div class="line number34 index33 alt1">34</div>

              <div class="line number35 index34 alt2">35</div>

              <div class="line number36 index35 alt1">36</div>

              <div class="line number37 index36 alt2">37</div>

              <div class="line number38 index37 alt1">38</div>

              <div class="line number39 index38 alt2">39</div>

              <div class="line number40 index39 alt1">40</div>

              <div class="line number41 index40 alt2">41</div>

              <div class="line number42 index41 alt1">42</div>

              <div class="line number43 index42 alt2">43</div>

              <div class="line number44 index43 alt1">44</div>

              <div class="line number45 index44 alt2">45</div>

              <div class="line number46 index45 alt1">46</div>

              <div class="line number47 index46 alt2">47</div>

              <div class="line number48 index47 alt1">48</div>

              <div class="line number49 index48 alt2">49</div>

              <div class="line number50 index49 alt1">50</div>

              <div class="line number51 index50 alt2">51</div>

              <div class="line number52 index51 alt1">52</div>

              <div class="line number53 index52 alt2">53</div>

              <div class="line number54 index53 alt1">54</div>

              <div class="line number55 index54 alt2">55</div>

              <div class="line number56 index55 alt1">56</div>

              <div class="line number57 index56 alt2">57</div>

              <div class="line number58 index57 alt1">58</div>

              <div class="line number59 index58 alt2">59</div>

              <div class="line number60 index59 alt1">60</div>

              <div class="line number61 index60 alt2">61</div>
            </td>
            <td class="code">
              <div class="container">
                <div class="line number1 index0 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">dev_queue_xmit(</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">sk_buff *skb)</code></div>

                <div class="line number2 index1 alt1">&nbsp;</div>

                <div class="line number3 index2 alt2"><code class="cpp plain">[...] ===&gt;</code></div>

                <div class="line number4 index3 alt1">&nbsp;</div>

                <div class="line number5 index4 alt2"><code class="cpp keyword bold">static</code> <code class="cpp keyword bold">inline</code> <code class="cpp color1 bold">int</code> <code class="cpp plain">__dev_xmit_skb(</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">sk_buff *skb, </code><code class="cpp keyword bold">struct</code> <code class="cpp plain">Qdisc *q, ...)</code></div>

                <div class="line number6 index5 alt1">&nbsp;</div>

                <div class="line number7 index6 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number8 index7 alt1">&nbsp;</div>

                <div class="line number9 index8 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(...) {</code></div>

                <div class="line number10 index9 alt1">&nbsp;</div>

                <div class="line number11 index10 alt2"><code class="cpp plain">....</code></div>

                <div class="line number12 index11 alt1">&nbsp;</div>

                <div class="line number13 index12 alt2"><code class="cpp plain">} </code><code class="cpp keyword bold">else</code></div>

                <div class="line number14 index13 alt1">&nbsp;</div>

                <div class="line number15 index14 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">((q-&gt;flags &amp; TCQ_F_CAN_BYPASS) &amp;&amp; !qdisc_qlen(q) &amp;&amp;</code></div>

                <div class="line number16 index15 alt1">&nbsp;</div>

                <div class="line number17 index16 alt2">&nbsp;</div>

                <div class="line number18 index17 alt1">&nbsp;</div>

                <div class="line number19 index18 alt2"><code class="cpp plain">qdisc_run_begin(q)) {</code></div>

                <div class="line number20 index19 alt1">&nbsp;</div>

                <div class="line number21 index20 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number22 index21 alt1">&nbsp;</div>

                <div class="line number23 index22 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(sch_direct_xmit(skb, q, dev, txq, root_lock)) {</code></div>

                <div class="line number24 index23 alt1">&nbsp;</div>

                <div class="line number25 index24 alt2"><code class="cpp plain">[...] ===&gt;</code></div>

                <div class="line number26 index25 alt1">&nbsp;</div>

                <div class="line number27 index26 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">sch_direct_xmit(</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">sk_buff *skb, </code><code class="cpp keyword bold">struct</code> <code class="cpp plain">Qdisc *q, ...)</code></div>

                <div class="line number28 index27 alt1">&nbsp;</div>

                <div class="line number29 index28 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number30 index29 alt1">&nbsp;</div>

                <div class="line number31 index30 alt2"><code class="cpp plain">HARD_TX_LOCK(dev, txq, smp_processor_id());</code></div>

                <div class="line number32 index31 alt1">&nbsp;</div>

                <div class="line number33 index32 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(!netif_tx_queue_frozen_or_stopped(txq))</code></div>

                <div class="line number34 index33 alt1">&nbsp;</div>

                <div class="line number35 index34 alt2"><code class="cpp plain">ret = dev_hard_start_xmit(skb, dev, txq);</code></div>

                <div class="line number36 index35 alt1">&nbsp;</div>

                <div class="line number37 index36 alt2">&nbsp;</div>

                <div class="line number38 index37 alt1">&nbsp;</div>

                <div class="line number39 index38 alt2"><code class="cpp plain">HARD_TX_UNLOCK(dev, txq);</code></div>

                <div class="line number40 index39 alt1">&nbsp;</div>

                <div class="line number41 index40 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number42 index41 alt1">&nbsp;</div>

                <div class="line number43 index42 alt2"><code class="cpp plain">}</code></div>

                <div class="line number44 index43 alt1">&nbsp;</div>

                <div class="line number45 index44 alt2">&nbsp;</div>

                <div class="line number46 index45 alt1">&nbsp;</div>

                <div class="line number47 index46 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">dev_hard_start_xmit(</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">sk_buff *skb, </code><code class="cpp keyword bold">struct</code> <code class="cpp plain">net_device *dev, ...)</code></div>

                <div class="line number48 index47 alt1">&nbsp;</div>

                <div class="line number49 index48 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number50 index49 alt1">&nbsp;</div>

                <div class="line number51 index50 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(!list_empty(&amp;ptype_all))</code></div>

                <div class="line number52 index51 alt1">&nbsp;</div>

                <div class="line number53 index52 alt2"><code class="cpp plain">dev_queue_xmit_nit(skb, dev);</code></div>

                <div class="line number54 index53 alt1">&nbsp;</div>

                <div class="line number55 index54 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number56 index55 alt1">&nbsp;</div>

                <div class="line number57 index56 alt2"><code class="cpp plain">rc = ops-&gt;ndo_start_xmit(skb, dev);</code></div>

                <div class="line number58 index57 alt1">&nbsp;</div>

                <div class="line number59 index58 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number60 index59 alt1">&nbsp;</div>

                <div class="line number61 index60 alt2"><code class="cpp plain">}</code></div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <p>The completed packet is transmitted through the <b>dev_queue_xmit</b> function. First, the packet passes via the qdisc. If the default qdisc is used and the queue is empty, the <b>sch_direct_xmit</b> function is called to directly send down the
    packet to the driver, skipping the queue. <b>Dev_hard_start_xmit</b> function calls the actual driver. Before calling the driver, the device TX is locked first. This is to prevent several threads from accessing the device simultaneously. As the
    kernel locks the device TX, the driver transmission code does not need an additional lock. It is closely related to the parallel processing that will be discussed next time.</p>

  <p><b>Ndo_start_xmit</b> function calls the driver code. Just before, you will see <b>ptype_all</b> and <b>dev_queue_xmit_nit</b>. The ptype_all is a list that includes the modules such as packet capture. If a capture program is running, the packet
    is copied by ptype_all to the separate program. Therefore, the packet that tcpdump shows is the packet transmitted to the driver. When checksum offload or TSO is used, the NIC manipulates the packet. So the tcpdump packet is different from the
    packet transmitted to the network line. After completing packet transmission, the driver interrupt handler returns the <b>sk_buff</b>.</p>

  <h2>Following Code: How to Receive Data</h2>

  <p>The general executed path is to receive a packet and then to add the data to the receive socket buffer. After executing the driver interrupt handler, follow the napi poll handle first.</p>

  <div>
    <div class="syntaxhighlighter  cpp" id="highlighter_797268">
      <div class="toolbar"><span><a class="toolbar_item command_help help" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#">?</a></span></div>

      <table border="0" cellpadding="0" cellspacing="0">
        <tbody>
          <tr>
            <td class="gutter">
              <div class="line number1 index0 alt2">1</div>

              <div class="line number2 index1 alt1">2</div>

              <div class="line number3 index2 alt2">3</div>

              <div class="line number4 index3 alt1">4</div>

              <div class="line number5 index4 alt2">5</div>

              <div class="line number6 index5 alt1">6</div>

              <div class="line number7 index6 alt2">7</div>

              <div class="line number8 index7 alt1">8</div>

              <div class="line number9 index8 alt2">9</div>

              <div class="line number10 index9 alt1">10</div>

              <div class="line number11 index10 alt2">11</div>

              <div class="line number12 index11 alt1">12</div>

              <div class="line number13 index12 alt2">13</div>

              <div class="line number14 index13 alt1">14</div>

              <div class="line number15 index14 alt2">15</div>

              <div class="line number16 index15 alt1">16</div>

              <div class="line number17 index16 alt2">17</div>

              <div class="line number18 index17 alt1">18</div>

              <div class="line number19 index18 alt2">19</div>

              <div class="line number20 index19 alt1">20</div>

              <div class="line number21 index20 alt2">21</div>

              <div class="line number22 index21 alt1">22</div>

              <div class="line number23 index22 alt2">23</div>

              <div class="line number24 index23 alt1">24</div>

              <div class="line number25 index24 alt2">25</div>

              <div class="line number26 index25 alt1">26</div>

              <div class="line number27 index26 alt2">27</div>

              <div class="line number28 index27 alt1">28</div>

              <div class="line number29 index28 alt2">29</div>

              <div class="line number30 index29 alt1">30</div>

              <div class="line number31 index30 alt2">31</div>

              <div class="line number32 index31 alt1">32</div>

              <div class="line number33 index32 alt2">33</div>

              <div class="line number34 index33 alt1">34</div>

              <div class="line number35 index34 alt2">35</div>

              <div class="line number36 index35 alt1">36</div>

              <div class="line number37 index36 alt2">37</div>

              <div class="line number38 index37 alt1">38</div>

              <div class="line number39 index38 alt2">39</div>

              <div class="line number40 index39 alt1">40</div>

              <div class="line number41 index40 alt2">41</div>

              <div class="line number42 index41 alt1">42</div>

              <div class="line number43 index42 alt2">43</div>

              <div class="line number44 index43 alt1">44</div>

              <div class="line number45 index44 alt2">45</div>

              <div class="line number46 index45 alt1">46</div>

              <div class="line number47 index46 alt2">47</div>

              <div class="line number48 index47 alt1">48</div>

              <div class="line number49 index48 alt2">49</div>

              <div class="line number50 index49 alt1">50</div>

              <div class="line number51 index50 alt2">51</div>

              <div class="line number52 index51 alt1">52</div>

              <div class="line number53 index52 alt2">53</div>

              <div class="line number54 index53 alt1">54</div>

              <div class="line number55 index54 alt2">55</div>

              <div class="line number56 index55 alt1">56</div>

              <div class="line number57 index56 alt2">57</div>

              <div class="line number58 index57 alt1">58</div>

              <div class="line number59 index58 alt2">59</div>

              <div class="line number60 index59 alt1">60</div>

              <div class="line number61 index60 alt2">61</div>

              <div class="line number62 index61 alt1">62</div>

              <div class="line number63 index62 alt2">63</div>

              <div class="line number64 index63 alt1">64</div>

              <div class="line number65 index64 alt2">65</div>

              <div class="line number66 index65 alt1">66</div>

              <div class="line number67 index66 alt2">67</div>

              <div class="line number68 index67 alt1">68</div>

              <div class="line number69 index68 alt2">69</div>

              <div class="line number70 index69 alt1">70</div>

              <div class="line number71 index70 alt2">71</div>

              <div class="line number72 index71 alt1">72</div>

              <div class="line number73 index72 alt2">73</div>

              <div class="line number74 index73 alt1">74</div>

              <div class="line number75 index74 alt2">75</div>

              <div class="line number76 index75 alt1">76</div>

              <div class="line number77 index76 alt2">77</div>

              <div class="line number78 index77 alt1">78</div>

              <div class="line number79 index78 alt2">79</div>

              <div class="line number80 index79 alt1">80</div>

              <div class="line number81 index80 alt2">81</div>

              <div class="line number82 index81 alt1">82</div>

              <div class="line number83 index82 alt2">83</div>

              <div class="line number84 index83 alt1">84</div>

              <div class="line number85 index84 alt2">85</div>

              <div class="line number86 index85 alt1">86</div>

              <div class="line number87 index86 alt2">87</div>

              <div class="line number88 index87 alt1">88</div>

              <div class="line number89 index88 alt2">89</div>

              <div class="line number90 index89 alt1">90</div>

              <div class="line number91 index90 alt2">91</div>

              <div class="line number92 index91 alt1">92</div>

              <div class="line number93 index92 alt2">93</div>

              <div class="line number94 index93 alt1">94</div>

              <div class="line number95 index94 alt2">95</div>

              <div class="line number96 index95 alt1">96</div>

              <div class="line number97 index96 alt2">97</div>

              <div class="line number98 index97 alt1">98</div>

              <div class="line number99 index98 alt2">99</div>

              <div class="line number100 index99 alt1">100</div>

              <div class="line number101 index100 alt2">101</div>

              <div class="line number102 index101 alt1">102</div>

              <div class="line number103 index102 alt2">103</div>

              <div class="line number104 index103 alt1">104</div>

              <div class="line number105 index104 alt2">105</div>

              <div class="line number106 index105 alt1">106</div>

              <div class="line number107 index106 alt2">107</div>

              <div class="line number108 index107 alt1">108</div>

              <div class="line number109 index108 alt2">109</div>

              <div class="line number110 index109 alt1">110</div>

              <div class="line number111 index110 alt2">111</div>

              <div class="line number112 index111 alt1">112</div>

              <div class="line number113 index112 alt2">113</div>

              <div class="line number114 index113 alt1">114</div>

              <div class="line number115 index114 alt2">115</div>
            </td>
            <td class="code">
              <div class="container">
                <div class="line number1 index0 alt2"><code class="cpp keyword bold">static</code> <code class="cpp keyword bold">void</code> <code class="cpp plain">net_rx_action(</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">softirq_action *h)</code></div>

                <div class="line number2 index1 alt1">&nbsp;</div>

                <div class="line number3 index2 alt2"><code class="cpp plain">{</code></div>

                <div class="line number4 index3 alt1">&nbsp;</div>

                <div class="line number5 index4 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">softnet_data *sd = &amp;__get_cpu_var(softnet_data);</code></div>

                <div class="line number6 index5 alt1">&nbsp;</div>

                <div class="line number7 index6 alt2"><code class="cpp plain">unsigned </code><code class="cpp color1 bold">long</code> <code class="cpp plain">time_limit = jiffies + 2;</code></div>

                <div class="line number8 index7 alt1">&nbsp;</div>

                <div class="line number9 index8 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">budget = netdev_budget;</code></div>

                <div class="line number10 index9 alt1">&nbsp;</div>

                <div class="line number11 index10 alt2"><code class="cpp keyword bold">void</code> <code class="cpp plain">*have;</code></div>

                <div class="line number12 index11 alt1">&nbsp;</div>

                <div class="line number13 index12 alt2">&nbsp;</div>

                <div class="line number14 index13 alt1">&nbsp;</div>

                <div class="line number15 index14 alt2"><code class="cpp plain">local_irq_disable();</code></div>

                <div class="line number16 index15 alt1">&nbsp;</div>

                <div class="line number17 index16 alt2">&nbsp;</div>

                <div class="line number18 index17 alt1">&nbsp;</div>

                <div class="line number19 index18 alt2"><code class="cpp keyword bold">while</code> <code class="cpp plain">(!list_empty(&amp;sd-&gt;poll_list)) {</code></div>

                <div class="line number20 index19 alt1">&nbsp;</div>

                <div class="line number21 index20 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">napi_struct *n;</code></div>

                <div class="line number22 index21 alt1">&nbsp;</div>

                <div class="line number23 index22 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number24 index23 alt1">&nbsp;</div>

                <div class="line number25 index24 alt2"><code class="cpp plain">n = list_first_entry(&amp;sd-&gt;poll_list, </code><code class="cpp keyword bold">struct</code> <code class="cpp plain">napi_struct,</code></div>

                <div class="line number26 index25 alt1">&nbsp;</div>

                <div class="line number27 index26 alt2"><code class="cpp plain">poll_list);</code></div>

                <div class="line number28 index27 alt1">&nbsp;</div>

                <div class="line number29 index28 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(test_bit(NAPI_STATE_SCHED, &amp;n-&gt;state)) {</code></div>

                <div class="line number30 index29 alt1">&nbsp;</div>

                <div class="line number31 index30 alt2"><code class="cpp plain">work = n-&gt;poll(n, weight);</code></div>

                <div class="line number32 index31 alt1">&nbsp;</div>

                <div class="line number33 index32 alt2"><code class="cpp plain">trace_napi_poll(n);</code></div>

                <div class="line number34 index33 alt1">&nbsp;</div>

                <div class="line number35 index34 alt2"><code class="cpp plain">}</code></div>

                <div class="line number36 index35 alt1">&nbsp;</div>

                <div class="line number37 index36 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number38 index37 alt1">&nbsp;</div>

                <div class="line number39 index38 alt2"><code class="cpp plain">}</code></div>

                <div class="line number40 index39 alt1">&nbsp;</div>

                <div class="line number41 index40 alt2">&nbsp;</div>

                <div class="line number42 index41 alt1">&nbsp;</div>

                <div class="line number43 index42 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">netif_receive_skb(</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">sk_buff *skb)</code></div>

                <div class="line number44 index43 alt1">&nbsp;</div>

                <div class="line number45 index44 alt2"><code class="cpp plain">[...] ===&gt;</code></div>

                <div class="line number46 index45 alt1">&nbsp;</div>

                <div class="line number47 index46 alt2"><code class="cpp keyword bold">static</code> <code class="cpp color1 bold">int</code> <code class="cpp plain">__netif_receive_skb(</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">sk_buff *skb)</code></div>

                <div class="line number48 index47 alt1">&nbsp;</div>

                <div class="line number49 index48 alt2"><code class="cpp plain">{</code></div>

                <div class="line number50 index49 alt1">&nbsp;</div>

                <div class="line number51 index50 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">packet_type *ptype, *pt_prev;</code></div>

                <div class="line number52 index51 alt1">&nbsp;</div>

                <div class="line number53 index52 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number54 index53 alt1">&nbsp;</div>

                <div class="line number55 index54 alt2"><code class="cpp plain">__be16 type;</code></div>

                <div class="line number56 index55 alt1">&nbsp;</div>

                <div class="line number57 index56 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number58 index57 alt1">&nbsp;</div>

                <div class="line number59 index58 alt2"><code class="cpp plain">list_for_each_entry_rcu(ptype, &amp;ptype_all, list) {</code></div>

                <div class="line number60 index59 alt1">&nbsp;</div>

                <div class="line number61 index60 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(!ptype-&gt;dev || ptype-&gt;dev == skb-&gt;dev) {</code></div>

                <div class="line number62 index61 alt1">&nbsp;</div>

                <div class="line number63 index62 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(pt_prev)</code></div>

                <div class="line number64 index63 alt1">&nbsp;</div>

                <div class="line number65 index64 alt2"><code class="cpp plain">ret = deliver_skb(skb, pt_prev, orig_dev);</code></div>

                <div class="line number66 index65 alt1">&nbsp;</div>

                <div class="line number67 index66 alt2"><code class="cpp plain">pt_prev = ptype;</code></div>

                <div class="line number68 index67 alt1">&nbsp;</div>

                <div class="line number69 index68 alt2"><code class="cpp plain">}</code></div>

                <div class="line number70 index69 alt1">&nbsp;</div>

                <div class="line number71 index70 alt2"><code class="cpp plain">}</code></div>

                <div class="line number72 index71 alt1">&nbsp;</div>

                <div class="line number73 index72 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number74 index73 alt1">&nbsp;</div>

                <div class="line number75 index74 alt2"><code class="cpp plain">type = skb-&gt;protocol;</code></div>

                <div class="line number76 index75 alt1">&nbsp;</div>

                <div class="line number77 index76 alt2"><code class="cpp plain">list_for_each_entry_rcu(ptype,</code></div>

                <div class="line number78 index77 alt1">&nbsp;</div>

                <div class="line number79 index78 alt2"><code class="cpp plain">&amp;ptype_base[ntohs(type) &amp; PTYPE_HASH_MASK], list) {</code></div>

                <div class="line number80 index79 alt1">&nbsp;</div>

                <div class="line number81 index80 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(ptype-&gt;type == type &amp;&amp;</code></div>

                <div class="line number82 index81 alt1">&nbsp;</div>

                <div class="line number83 index82 alt2">&nbsp;</div>

                <div class="line number84 index83 alt1">&nbsp;</div>

                <div class="line number85 index84 alt2"><code class="cpp plain">(ptype-&gt;dev == null_or_dev || ptype-&gt;dev == skb-&gt;dev ||</code></div>

                <div class="line number86 index85 alt1">&nbsp;</div>

                <div class="line number87 index86 alt2"><code class="cpp plain">ptype-&gt;dev == orig_dev)) {</code></div>

                <div class="line number88 index87 alt1">&nbsp;</div>

                <div class="line number89 index88 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(pt_prev)</code></div>

                <div class="line number90 index89 alt1">&nbsp;</div>

                <div class="line number91 index90 alt2"><code class="cpp plain">ret = deliver_skb(skb, pt_prev, orig_dev);</code></div>

                <div class="line number92 index91 alt1">&nbsp;</div>

                <div class="line number93 index92 alt2"><code class="cpp plain">pt_prev = ptype;</code></div>

                <div class="line number94 index93 alt1">&nbsp;</div>

                <div class="line number95 index94 alt2"><code class="cpp plain">}</code></div>

                <div class="line number96 index95 alt1">&nbsp;</div>

                <div class="line number97 index96 alt2"><code class="cpp plain">}</code></div>

                <div class="line number98 index97 alt1">&nbsp;</div>

                <div class="line number99 index98 alt2">&nbsp;</div>

                <div class="line number100 index99 alt1">&nbsp;</div>

                <div class="line number101 index100 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(pt_prev) {</code></div>

                <div class="line number102 index101 alt1">&nbsp;</div>

                <div class="line number103 index102 alt2"><code class="cpp plain">ret = pt_prev-&gt;func(skb, skb-&gt;dev, pt_prev, orig_dev);</code></div>

                <div class="line number104 index103 alt1">&nbsp;</div>

                <div class="line number105 index104 alt2">&nbsp;</div>

                <div class="line number106 index105 alt1">&nbsp;</div>

                <div class="line number107 index106 alt2"><code class="cpp keyword bold">static</code> <code class="cpp keyword bold">struct</code> <code class="cpp plain">packet_type ip_packet_type __read_mostly = {</code></div>

                <div class="line number108 index107 alt1">&nbsp;</div>

                <div class="line number109 index108 alt2"><code class="cpp plain">.type = cpu_to_be16(ETH_P_IP),</code></div>

                <div class="line number110 index109 alt1">&nbsp;</div>

                <div class="line number111 index110 alt2"><code class="cpp plain">.func = ip_rcv,</code></div>

                <div class="line number112 index111 alt1">&nbsp;</div>

                <div class="line number113 index112 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number114 index113 alt1">&nbsp;</div>

                <div class="line number115 index114 alt2"><code class="cpp plain">};</code></div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <p>As mentioned before, the net_rx_action function is the softirq handler that receives a packet. First, the driver that has requested the napi poll is retrieved from the <b>poll_list</b> and the poll handler of the driver is called. The driver
    wraps
    the received packet with sk_buff and then calls <b>netif_receive_skb</b>.</p>

  <p>When there is a module that requests all packets, the <b>netif_receive_skb</b> sends packets to the module. Like packet transmission, the packets are transmitted to the module registered to the ptype_all list. The packets are captured here.</p>

  <p>Then, the packets are transmitted to the upper layer based on the packet type. The Ethernet packet includes 2-byte ethertype field in the header. The value indicates the packet type. The driver records the value in <b>sk_buff</b>
    (skb-&gt;protocol). Each protocol has its own packet_type structure and registers the pointer of the structure to the ptype_base hash table. IPv4 uses <b>ip_packet_type</b>. The Type field value is the IPv4 ethertype (<b>ETH_P_IP</b>) value.
    Therefore, the IPv4 packet calls the <b>ip_rcv</b> function.</p>

  <div>
    <div class="syntaxhighlighter  cpp" id="highlighter_601836">
      <div class="toolbar"><span><a class="toolbar_item command_help help" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#">?</a></span></div>

      <table border="0" cellpadding="0" cellspacing="0">
        <tbody>
          <tr>
            <td class="gutter">
              <div class="line number1 index0 alt2">1</div>

              <div class="line number2 index1 alt1">2</div>

              <div class="line number3 index2 alt2">3</div>

              <div class="line number4 index3 alt1">4</div>

              <div class="line number5 index4 alt2">5</div>

              <div class="line number6 index5 alt1">6</div>

              <div class="line number7 index6 alt2">7</div>

              <div class="line number8 index7 alt1">8</div>

              <div class="line number9 index8 alt2">9</div>

              <div class="line number10 index9 alt1">10</div>

              <div class="line number11 index10 alt2">11</div>

              <div class="line number12 index11 alt1">12</div>

              <div class="line number13 index12 alt2">13</div>

              <div class="line number14 index13 alt1">14</div>

              <div class="line number15 index14 alt2">15</div>

              <div class="line number16 index15 alt1">16</div>

              <div class="line number17 index16 alt2">17</div>

              <div class="line number18 index17 alt1">18</div>

              <div class="line number19 index18 alt2">19</div>

              <div class="line number20 index19 alt1">20</div>

              <div class="line number21 index20 alt2">21</div>

              <div class="line number22 index21 alt1">22</div>

              <div class="line number23 index22 alt2">23</div>

              <div class="line number24 index23 alt1">24</div>

              <div class="line number25 index24 alt2">25</div>

              <div class="line number26 index25 alt1">26</div>

              <div class="line number27 index26 alt2">27</div>

              <div class="line number28 index27 alt1">28</div>

              <div class="line number29 index28 alt2">29</div>

              <div class="line number30 index29 alt1">30</div>

              <div class="line number31 index30 alt2">31</div>

              <div class="line number32 index31 alt1">32</div>

              <div class="line number33 index32 alt2">33</div>

              <div class="line number34 index33 alt1">34</div>

              <div class="line number35 index34 alt2">35</div>

              <div class="line number36 index35 alt1">36</div>

              <div class="line number37 index36 alt2">37</div>

              <div class="line number38 index37 alt1">38</div>

              <div class="line number39 index38 alt2">39</div>

              <div class="line number40 index39 alt1">40</div>

              <div class="line number41 index40 alt2">41</div>

              <div class="line number42 index41 alt1">42</div>

              <div class="line number43 index42 alt2">43</div>

              <div class="line number44 index43 alt1">44</div>

              <div class="line number45 index44 alt2">45</div>

              <div class="line number46 index45 alt1">46</div>

              <div class="line number47 index46 alt2">47</div>

              <div class="line number48 index47 alt1">48</div>

              <div class="line number49 index48 alt2">49</div>

              <div class="line number50 index49 alt1">50</div>

              <div class="line number51 index50 alt2">51</div>

              <div class="line number52 index51 alt1">52</div>

              <div class="line number53 index52 alt2">53</div>

              <div class="line number54 index53 alt1">54</div>

              <div class="line number55 index54 alt2">55</div>

              <div class="line number56 index55 alt1">56</div>

              <div class="line number57 index56 alt2">57</div>

              <div class="line number58 index57 alt1">58</div>

              <div class="line number59 index58 alt2">59</div>

              <div class="line number60 index59 alt1">60</div>

              <div class="line number61 index60 alt2">61</div>

              <div class="line number62 index61 alt1">62</div>

              <div class="line number63 index62 alt2">63</div>

              <div class="line number64 index63 alt1">64</div>

              <div class="line number65 index64 alt2">65</div>

              <div class="line number66 index65 alt1">66</div>

              <div class="line number67 index66 alt2">67</div>

              <div class="line number68 index67 alt1">68</div>

              <div class="line number69 index68 alt2">69</div>

              <div class="line number70 index69 alt1">70</div>

              <div class="line number71 index70 alt2">71</div>

              <div class="line number72 index71 alt1">72</div>

              <div class="line number73 index72 alt2">73</div>

              <div class="line number74 index73 alt1">74</div>

              <div class="line number75 index74 alt2">75</div>

              <div class="line number76 index75 alt1">76</div>

              <div class="line number77 index76 alt2">77</div>

              <div class="line number78 index77 alt1">78</div>

              <div class="line number79 index78 alt2">79</div>

              <div class="line number80 index79 alt1">80</div>

              <div class="line number81 index80 alt2">81</div>

              <div class="line number82 index81 alt1">82</div>

              <div class="line number83 index82 alt2">83</div>

              <div class="line number84 index83 alt1">84</div>

              <div class="line number85 index84 alt2">85</div>

              <div class="line number86 index85 alt1">86</div>

              <div class="line number87 index86 alt2">87</div>

              <div class="line number88 index87 alt1">88</div>

              <div class="line number89 index88 alt2">89</div>

              <div class="line number90 index89 alt1">90</div>

              <div class="line number91 index90 alt2">91</div>

              <div class="line number92 index91 alt1">92</div>

              <div class="line number93 index92 alt2">93</div>

              <div class="line number94 index93 alt1">94</div>

              <div class="line number95 index94 alt2">95</div>

              <div class="line number96 index95 alt1">96</div>

              <div class="line number97 index96 alt2">97</div>

              <div class="line number98 index97 alt1">98</div>

              <div class="line number99 index98 alt2">99</div>

              <div class="line number100 index99 alt1">100</div>

              <div class="line number101 index100 alt2">101</div>

              <div class="line number102 index101 alt1">102</div>

              <div class="line number103 index102 alt2">103</div>

              <div class="line number104 index103 alt1">104</div>

              <div class="line number105 index104 alt2">105</div>

              <div class="line number106 index105 alt1">106</div>

              <div class="line number107 index106 alt2">107</div>

              <div class="line number108 index107 alt1">108</div>

              <div class="line number109 index108 alt2">109</div>

              <div class="line number110 index109 alt1">110</div>

              <div class="line number111 index110 alt2">111</div>

              <div class="line number112 index111 alt1">112</div>

              <div class="line number113 index112 alt2">113</div>

              <div class="line number114 index113 alt1">114</div>

              <div class="line number115 index114 alt2">115</div>

              <div class="line number116 index115 alt1">116</div>

              <div class="line number117 index116 alt2">117</div>
            </td>
            <td class="code">
              <div class="container">
                <div class="line number1 index0 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">ip_rcv(</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">sk_buff *skb, </code><code class="cpp keyword bold">struct</code> <code class="cpp plain">net_device *dev, ...)</code></div>

                <div class="line number2 index1 alt1">&nbsp;</div>

                <div class="line number3 index2 alt2"><code class="cpp plain">{</code></div>

                <div class="line number4 index3 alt1">&nbsp;</div>

                <div class="line number5 index4 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">iphdr *iph;</code></div>

                <div class="line number6 index5 alt1">&nbsp;</div>

                <div class="line number7 index6 alt2"><code class="cpp plain">u32 len;</code></div>

                <div class="line number8 index7 alt1">&nbsp;</div>

                <div class="line number9 index8 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number10 index9 alt1">&nbsp;</div>

                <div class="line number11 index10 alt2"><code class="cpp plain">iph = ip_hdr(skb);</code></div>

                <div class="line number12 index11 alt1">&nbsp;</div>

                <div class="line number13 index12 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number14 index13 alt1">&nbsp;</div>

                <div class="line number15 index14 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(iph-&gt;ihl &lt; 5 || iph-&gt;version != 4)</code></div>

                <div class="line number16 index15 alt1">&nbsp;</div>

                <div class="line number17 index16 alt2"><code class="cpp keyword bold">goto</code> <code class="cpp plain">inhdr_error;</code></div>

                <div class="line number18 index17 alt1">&nbsp;</div>

                <div class="line number19 index18 alt2">&nbsp;</div>

                <div class="line number20 index19 alt1">&nbsp;</div>

                <div class="line number21 index20 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(!pskb_may_pull(skb, iph-&gt;ihl*4))</code></div>

                <div class="line number22 index21 alt1">&nbsp;</div>

                <div class="line number23 index22 alt2"><code class="cpp keyword bold">goto</code> <code class="cpp plain">inhdr_error;</code></div>

                <div class="line number24 index23 alt1">&nbsp;</div>

                <div class="line number25 index24 alt2">&nbsp;</div>

                <div class="line number26 index25 alt1">&nbsp;</div>

                <div class="line number27 index26 alt2"><code class="cpp plain">iph = ip_hdr(skb);</code></div>

                <div class="line number28 index27 alt1">&nbsp;</div>

                <div class="line number29 index28 alt2">&nbsp;</div>

                <div class="line number30 index29 alt1">&nbsp;</div>

                <div class="line number31 index30 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(unlikely(ip_fast_csum((u8 *)iph, iph-&gt;ihl)))</code></div>

                <div class="line number32 index31 alt1">&nbsp;</div>

                <div class="line number33 index32 alt2"><code class="cpp keyword bold">goto</code> <code class="cpp plain">inhdr_error;</code></div>

                <div class="line number34 index33 alt1">&nbsp;</div>

                <div class="line number35 index34 alt2">&nbsp;</div>

                <div class="line number36 index35 alt1">&nbsp;</div>

                <div class="line number37 index36 alt2"><code class="cpp plain">len = ntohs(iph-&gt;tot_len);</code></div>

                <div class="line number38 index37 alt1">&nbsp;</div>

                <div class="line number39 index38 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(skb-&gt;len &lt; len) {</code></div>

                <div class="line number40 index39 alt1">&nbsp;</div>

                <div class="line number41 index40 alt2"><code class="cpp plain">IP_INC_STATS_BH(dev_net(dev), IPSTATS_MIB_INTRUNCATEDPKTS);</code></div>

                <div class="line number42 index41 alt1">&nbsp;</div>

                <div class="line number43 index42 alt2"><code class="cpp keyword bold">goto</code> <code class="cpp plain">drop;</code></div>

                <div class="line number44 index43 alt1">&nbsp;</div>

                <div class="line number45 index44 alt2"><code class="cpp plain">} </code><code class="cpp keyword bold">else</code> <code class="cpp keyword bold">if</code> <code class="cpp plain">(len &lt; (iph-&gt;ihl*4))</code></div>

                <div class="line number46 index45 alt1">&nbsp;</div>

                <div class="line number47 index46 alt2"><code class="cpp keyword bold">goto</code> <code class="cpp plain">inhdr_error;</code></div>

                <div class="line number48 index47 alt1">&nbsp;</div>

                <div class="line number49 index48 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number50 index49 alt1">&nbsp;</div>

                <div class="line number51 index50 alt2"><code class="cpp keyword bold">return</code> <code class="cpp plain">NF_HOOK(NFPROTO_IPV4, NF_INET_PRE_ROUTING, skb, dev, NULL,</code></div>

                <div class="line number52 index51 alt1">&nbsp;</div>

                <div class="line number53 index52 alt2"><code class="cpp plain">ip_rcv_finish);</code></div>

                <div class="line number54 index53 alt1">&nbsp;</div>

                <div class="line number55 index54 alt2"><code class="cpp plain">[...] ===&gt;</code></div>

                <div class="line number56 index55 alt1">&nbsp;</div>

                <div class="line number57 index56 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">ip_local_deliver(</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">sk_buff *skb)</code></div>

                <div class="line number58 index57 alt1">&nbsp;</div>

                <div class="line number59 index58 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number60 index59 alt1">&nbsp;</div>

                <div class="line number61 index60 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(ip_hdr(skb)-&gt;frag_off &amp; htons(IP_MF | IP_OFFSET)) {</code></div>

                <div class="line number62 index61 alt1">&nbsp;</div>

                <div class="line number63 index62 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(ip_defrag(skb, IP_DEFRAG_LOCAL_DELIVER))</code></div>

                <div class="line number64 index63 alt1">&nbsp;</div>

                <div class="line number65 index64 alt2"><code class="cpp keyword bold">return</code> <code class="cpp plain">0;</code></div>

                <div class="line number66 index65 alt1">&nbsp;</div>

                <div class="line number67 index66 alt2"><code class="cpp plain">}</code></div>

                <div class="line number68 index67 alt1">&nbsp;</div>

                <div class="line number69 index68 alt2">&nbsp;</div>

                <div class="line number70 index69 alt1">&nbsp;</div>

                <div class="line number71 index70 alt2"><code class="cpp keyword bold">return</code> <code class="cpp plain">NF_HOOK(NFPROTO_IPV4, NF_INET_LOCAL_IN, skb, skb-&gt;dev, NULL,</code></div>

                <div class="line number72 index71 alt1">&nbsp;</div>

                <div class="line number73 index72 alt2"><code class="cpp plain">ip_local_deliver_finish);</code></div>

                <div class="line number74 index73 alt1">&nbsp;</div>

                <div class="line number75 index74 alt2"><code class="cpp plain">[...] ===&gt;</code></div>

                <div class="line number76 index75 alt1">&nbsp;</div>

                <div class="line number77 index76 alt2">&nbsp;</div>

                <div class="line number78 index77 alt1">&nbsp;</div>

                <div class="line number79 index78 alt2">&nbsp;</div>

                <div class="line number80 index79 alt1">&nbsp;</div>

                <div class="line number81 index80 alt2"><code class="cpp keyword bold">static</code> <code class="cpp color1 bold">int</code> <code class="cpp plain">ip_local_deliver_finish(</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">sk_buff *skb)</code></div>

                <div class="line number82 index81 alt1">&nbsp;</div>

                <div class="line number83 index82 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number84 index83 alt1">&nbsp;</div>

                <div class="line number85 index84 alt2"><code class="cpp plain">__skb_pull(skb, ip_hdrlen(skb));</code></div>

                <div class="line number86 index85 alt1">&nbsp;</div>

                <div class="line number87 index86 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number88 index87 alt1">&nbsp;</div>

                <div class="line number89 index88 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">protocol = ip_hdr(skb)-&gt;protocol;</code></div>

                <div class="line number90 index89 alt1">&nbsp;</div>

                <div class="line number91 index90 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">hash, raw;</code></div>

                <div class="line number92 index91 alt1">&nbsp;</div>

                <div class="line number93 index92 alt2"><code class="cpp keyword bold">const</code> <code class="cpp keyword bold">struct</code> <code class="cpp plain">net_protocol *ipprot;</code></div>

                <div class="line number94 index93 alt1">&nbsp;</div>

                <div class="line number95 index94 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number96 index95 alt1">&nbsp;</div>

                <div class="line number97 index96 alt2"><code class="cpp plain">hash = protocol &amp; (MAX_INET_PROTOS - 1);</code></div>

                <div class="line number98 index97 alt1">&nbsp;</div>

                <div class="line number99 index98 alt2"><code class="cpp plain">ipprot = rcu_dereference(inet_protos[hash]);</code></div>

                <div class="line number100 index99 alt1">&nbsp;</div>

                <div class="line number101 index100 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(ipprot != NULL) {</code></div>

                <div class="line number102 index101 alt1">&nbsp;</div>

                <div class="line number103 index102 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number104 index103 alt1">&nbsp;</div>

                <div class="line number105 index104 alt2"><code class="cpp plain">ret = ipprot-&gt;handler(skb);</code></div>

                <div class="line number106 index105 alt1">&nbsp;</div>

                <div class="line number107 index106 alt2"><code class="cpp plain">[...] ===&gt;</code></div>

                <div class="line number108 index107 alt1">&nbsp;</div>

                <div class="line number109 index108 alt2">&nbsp;</div>

                <div class="line number110 index109 alt1">&nbsp;</div>

                <div class="line number111 index110 alt2"><code class="cpp keyword bold">static</code> <code class="cpp keyword bold">const</code> <code class="cpp keyword bold">struct</code> <code class="cpp plain">net_protocol tcp_protocol =
                    {</code>
                </div>

                <div class="line number112 index111 alt1">&nbsp;</div>

                <div class="line number113 index112 alt2"><code class="cpp plain">.handler = tcp_v4_rcv,</code></div>

                <div class="line number114 index113 alt1">&nbsp;</div>

                <div class="line number115 index114 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number116 index115 alt1">&nbsp;</div>

                <div class="line number117 index116 alt2"><code class="cpp plain">};</code></div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <p>The <b>ip_rcv</b> function executes tasks required by the IP layers. It examines packets such as the length and header checksum. After passing through the netfilter code, it performs the <b>ip_local_deliver</b> function. If required, it
    assembles
    IP fragments. Then, it calls <b>ip_local_deliver_finish</b> through the netfilter code. The <b>ip_local_deliver_finish</b> function removes the IP header by using the __skb_pull and then searches the upper protocol whose value is identical to the
    IP header protocol value. Similar to the Ptype_base, each transport protocol registers its own <b>net_protocol</b> structure in <b>inet_protos</b>. IPv4 TCP uses <b>tcp_protocol</b> and calls <b>tcp_v4_rcv</b> that has been registered as a
    handler.
  </p>

  <p>When packets come into the TCP layer, the packet processing flow varies depending on the TCP status and the packet type. Here, we will see the packet processing procedure when the expected next data packet has been received in the
    <b>ESTABLISHED</b> status of the TCP connection. This path is frequently executed by the server receiving data when there is no packet loss or out-of-order delivery.</p>

  <div>
    <div class="syntaxhighlighter  cpp" id="highlighter_82862">
      <div class="toolbar"><span><a class="toolbar_item command_help help" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#">?</a></span></div>

      <table border="0" cellpadding="0" cellspacing="0">
        <tbody>
          <tr>
            <td class="gutter">
              <div class="line number1 index0 alt2">1</div>

              <div class="line number2 index1 alt1">2</div>

              <div class="line number3 index2 alt2">3</div>

              <div class="line number4 index3 alt1">4</div>

              <div class="line number5 index4 alt2">5</div>

              <div class="line number6 index5 alt1">6</div>

              <div class="line number7 index6 alt2">7</div>

              <div class="line number8 index7 alt1">8</div>

              <div class="line number9 index8 alt2">9</div>

              <div class="line number10 index9 alt1">10</div>

              <div class="line number11 index10 alt2">11</div>

              <div class="line number12 index11 alt1">12</div>

              <div class="line number13 index12 alt2">13</div>

              <div class="line number14 index13 alt1">14</div>

              <div class="line number15 index14 alt2">15</div>

              <div class="line number16 index15 alt1">16</div>

              <div class="line number17 index16 alt2">17</div>

              <div class="line number18 index17 alt1">18</div>

              <div class="line number19 index18 alt2">19</div>

              <div class="line number20 index19 alt1">20</div>

              <div class="line number21 index20 alt2">21</div>

              <div class="line number22 index21 alt1">22</div>

              <div class="line number23 index22 alt2">23</div>

              <div class="line number24 index23 alt1">24</div>

              <div class="line number25 index24 alt2">25</div>

              <div class="line number26 index25 alt1">26</div>

              <div class="line number27 index26 alt2">27</div>

              <div class="line number28 index27 alt1">28</div>

              <div class="line number29 index28 alt2">29</div>

              <div class="line number30 index29 alt1">30</div>

              <div class="line number31 index30 alt2">31</div>

              <div class="line number32 index31 alt1">32</div>

              <div class="line number33 index32 alt2">33</div>

              <div class="line number34 index33 alt1">34</div>

              <div class="line number35 index34 alt2">35</div>

              <div class="line number36 index35 alt1">36</div>

              <div class="line number37 index36 alt2">37</div>

              <div class="line number38 index37 alt1">38</div>

              <div class="line number39 index38 alt2">39</div>

              <div class="line number40 index39 alt1">40</div>

              <div class="line number41 index40 alt2">41</div>

              <div class="line number42 index41 alt1">42</div>

              <div class="line number43 index42 alt2">43</div>

              <div class="line number44 index43 alt1">44</div>

              <div class="line number45 index44 alt2">45</div>

              <div class="line number46 index45 alt1">46</div>

              <div class="line number47 index46 alt2">47</div>

              <div class="line number48 index47 alt1">48</div>

              <div class="line number49 index48 alt2">49</div>

              <div class="line number50 index49 alt1">50</div>

              <div class="line number51 index50 alt2">51</div>
            </td>
            <td class="code">
              <div class="container">
                <div class="line number1 index0 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">tcp_v4_rcv(</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">sk_buff *skb)</code></div>

                <div class="line number2 index1 alt1">&nbsp;</div>

                <div class="line number3 index2 alt2"><code class="cpp plain">{</code></div>

                <div class="line number4 index3 alt1">&nbsp;</div>

                <div class="line number5 index4 alt2"><code class="cpp keyword bold">const</code> <code class="cpp keyword bold">struct</code> <code class="cpp plain">iphdr *iph;</code></div>

                <div class="line number6 index5 alt1">&nbsp;</div>

                <div class="line number7 index6 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">tcphdr *th;</code></div>

                <div class="line number8 index7 alt1">&nbsp;</div>

                <div class="line number9 index8 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">sock *sk;</code></div>

                <div class="line number10 index9 alt1">&nbsp;</div>

                <div class="line number11 index10 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number12 index11 alt1">&nbsp;</div>

                <div class="line number13 index12 alt2"><code class="cpp plain">th = tcp_hdr(skb);</code></div>

                <div class="line number14 index13 alt1">&nbsp;</div>

                <div class="line number15 index14 alt2">&nbsp;</div>

                <div class="line number16 index15 alt1">&nbsp;</div>

                <div class="line number17 index16 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(th-&gt;doff &lt; </code><code class="cpp keyword bold">sizeof</code><code class="cpp plain">(</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">tcphdr) / 4)</code></div>

                <div class="line number18 index17 alt1">&nbsp;</div>

                <div class="line number19 index18 alt2"><code class="cpp keyword bold">goto</code> <code class="cpp plain">bad_packet;</code></div>

                <div class="line number20 index19 alt1">&nbsp;</div>

                <div class="line number21 index20 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(!pskb_may_pull(skb, th-&gt;doff * 4))</code></div>

                <div class="line number22 index21 alt1">&nbsp;</div>

                <div class="line number23 index22 alt2"><code class="cpp keyword bold">goto</code> <code class="cpp plain">discard_it;</code></div>

                <div class="line number24 index23 alt1">&nbsp;</div>

                <div class="line number25 index24 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number26 index25 alt1">&nbsp;</div>

                <div class="line number27 index26 alt2"><code class="cpp plain">th = tcp_hdr(skb);</code></div>

                <div class="line number28 index27 alt1">&nbsp;</div>

                <div class="line number29 index28 alt2"><code class="cpp plain">iph = ip_hdr(skb);</code></div>

                <div class="line number30 index29 alt1">&nbsp;</div>

                <div class="line number31 index30 alt2"><code class="cpp plain">TCP_SKB_CB(skb)-&gt;seq = ntohl(th-&gt;seq);</code></div>

                <div class="line number32 index31 alt1">&nbsp;</div>

                <div class="line number33 index32 alt2"><code class="cpp plain">TCP_SKB_CB(skb)-&gt;end_seq = (TCP_SKB_CB(skb)-&gt;seq + th-&gt;syn + th-&gt;fin +</code></div>

                <div class="line number34 index33 alt1">&nbsp;</div>

                <div class="line number35 index34 alt2"><code class="cpp plain">skb-&gt;len - th-&gt;doff * 4);</code></div>

                <div class="line number36 index35 alt1">&nbsp;</div>

                <div class="line number37 index36 alt2"><code class="cpp plain">TCP_SKB_CB(skb)-&gt;ack_seq = ntohl(th-&gt;ack_seq);</code></div>

                <div class="line number38 index37 alt1">&nbsp;</div>

                <div class="line number39 index38 alt2"><code class="cpp plain">TCP_SKB_CB(skb)-&gt;when = 0;</code></div>

                <div class="line number40 index39 alt1">&nbsp;</div>

                <div class="line number41 index40 alt2"><code class="cpp plain">TCP_SKB_CB(skb)-&gt;flags = iph-&gt;tos;</code></div>

                <div class="line number42 index41 alt1">&nbsp;</div>

                <div class="line number43 index42 alt2"><code class="cpp plain">TCP_SKB_CB(skb)-&gt;sacked = 0;</code></div>

                <div class="line number44 index43 alt1">&nbsp;</div>

                <div class="line number45 index44 alt2">&nbsp;</div>

                <div class="line number46 index45 alt1">&nbsp;</div>

                <div class="line number47 index46 alt2"><code class="cpp plain">sk = __inet_lookup_skb(&amp;tcp_hashinfo, skb, th-&gt;source, th-&gt;dest);</code></div>

                <div class="line number48 index47 alt1">&nbsp;</div>

                <div class="line number49 index48 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number50 index49 alt1">&nbsp;</div>

                <div class="line number51 index50 alt2"><code class="cpp plain">ret = tcp_v4_do_rcv(sk, skb);</code></div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <p>First, the <b>tcp_v4_rcv</b> function validates the received packets. When the header size is larger than the data offset (<code>th-&gt;doff &lt; sizeof(struct tcphdr) / 4</code>), it is the header error. And then <b>__inet_lookup_skb</b> is
    called to look for the connection where the packet belongs from the TCP connection hash table. From the sock structure found, all required structures such as <b>tcp_sock</b> and socket can be got.</p>

  <div>
    <div class="syntaxhighlighter  cpp" id="highlighter_902122">
      <div class="toolbar"><span><a class="toolbar_item command_help help" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#">?</a></span></div>

      <table border="0" cellpadding="0" cellspacing="0">
        <tbody>
          <tr>
            <td class="gutter">
              <div class="line number1 index0 alt2">1</div>

              <div class="line number2 index1 alt1">2</div>

              <div class="line number3 index2 alt2">3</div>

              <div class="line number4 index3 alt1">4</div>

              <div class="line number5 index4 alt2">5</div>

              <div class="line number6 index5 alt1">6</div>

              <div class="line number7 index6 alt2">7</div>

              <div class="line number8 index7 alt1">8</div>

              <div class="line number9 index8 alt2">9</div>

              <div class="line number10 index9 alt1">10</div>

              <div class="line number11 index10 alt2">11</div>

              <div class="line number12 index11 alt1">12</div>

              <div class="line number13 index12 alt2">13</div>

              <div class="line number14 index13 alt1">14</div>

              <div class="line number15 index14 alt2">15</div>

              <div class="line number16 index15 alt1">16</div>

              <div class="line number17 index16 alt2">17</div>

              <div class="line number18 index17 alt1">18</div>

              <div class="line number19 index18 alt2">19</div>

              <div class="line number20 index19 alt1">20</div>

              <div class="line number21 index20 alt2">21</div>

              <div class="line number22 index21 alt1">22</div>

              <div class="line number23 index22 alt2">23</div>

              <div class="line number24 index23 alt1">24</div>

              <div class="line number25 index24 alt2">25</div>

              <div class="line number26 index25 alt1">26</div>

              <div class="line number27 index26 alt2">27</div>

              <div class="line number28 index27 alt1">28</div>

              <div class="line number29 index28 alt2">29</div>

              <div class="line number30 index29 alt1">30</div>

              <div class="line number31 index30 alt2">31</div>

              <div class="line number32 index31 alt1">32</div>

              <div class="line number33 index32 alt2">33</div>

              <div class="line number34 index33 alt1">34</div>

              <div class="line number35 index34 alt2">35</div>

              <div class="line number36 index35 alt1">36</div>

              <div class="line number37 index36 alt2">37</div>

              <div class="line number38 index37 alt1">38</div>

              <div class="line number39 index38 alt2">39</div>

              <div class="line number40 index39 alt1">40</div>

              <div class="line number41 index40 alt2">41</div>

              <div class="line number42 index41 alt1">42</div>

              <div class="line number43 index42 alt2">43</div>

              <div class="line number44 index43 alt1">44</div>

              <div class="line number45 index44 alt2">45</div>

              <div class="line number46 index45 alt1">46</div>

              <div class="line number47 index46 alt2">47</div>

              <div class="line number48 index47 alt1">48</div>

              <div class="line number49 index48 alt2">49</div>

              <div class="line number50 index49 alt1">50</div>

              <div class="line number51 index50 alt2">51</div>

              <div class="line number52 index51 alt1">52</div>

              <div class="line number53 index52 alt2">53</div>

              <div class="line number54 index53 alt1">54</div>

              <div class="line number55 index54 alt2">55</div>

              <div class="line number56 index55 alt1">56</div>

              <div class="line number57 index56 alt2">57</div>

              <div class="line number58 index57 alt1">58</div>

              <div class="line number59 index58 alt2">59</div>

              <div class="line number60 index59 alt1">60</div>

              <div class="line number61 index60 alt2">61</div>

              <div class="line number62 index61 alt1">62</div>

              <div class="line number63 index62 alt2">63</div>

              <div class="line number64 index63 alt1">64</div>

              <div class="line number65 index64 alt2">65</div>

              <div class="line number66 index65 alt1">66</div>

              <div class="line number67 index66 alt2">67</div>

              <div class="line number68 index67 alt1">68</div>

              <div class="line number69 index68 alt2">69</div>

              <div class="line number70 index69 alt1">70</div>

              <div class="line number71 index70 alt2">71</div>

              <div class="line number72 index71 alt1">72</div>

              <div class="line number73 index72 alt2">73</div>

              <div class="line number74 index73 alt1">74</div>

              <div class="line number75 index74 alt2">75</div>

              <div class="line number76 index75 alt1">76</div>

              <div class="line number77 index76 alt2">77</div>

              <div class="line number78 index77 alt1">78</div>

              <div class="line number79 index78 alt2">79</div>

              <div class="line number80 index79 alt1">80</div>

              <div class="line number81 index80 alt2">81</div>

              <div class="line number82 index81 alt1">82</div>

              <div class="line number83 index82 alt2">83</div>

              <div class="line number84 index83 alt1">84</div>

              <div class="line number85 index84 alt2">85</div>

              <div class="line number86 index85 alt1">86</div>

              <div class="line number87 index86 alt2">87</div>

              <div class="line number88 index87 alt1">88</div>

              <div class="line number89 index88 alt2">89</div>

              <div class="line number90 index89 alt1">90</div>

              <div class="line number91 index90 alt2">91</div>

              <div class="line number92 index91 alt1">92</div>

              <div class="line number93 index92 alt2">93</div>

              <div class="line number94 index93 alt1">94</div>

              <div class="line number95 index94 alt2">95</div>
            </td>
            <td class="code">
              <div class="container">
                <div class="line number1 index0 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">tcp_v4_do_rcv(</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">sock *sk, </code><code class="cpp keyword bold">struct</code> <code class="cpp plain">sk_buff *skb)</code></div>

                <div class="line number2 index1 alt1">&nbsp;</div>

                <div class="line number3 index2 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number4 index3 alt1">&nbsp;</div>

                <div class="line number5 index4 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(sk-&gt;sk_state == TCP_ESTABLISHED) { </code><code class="cpp comments">/* Fast path */</code></div>

                <div class="line number6 index5 alt1">&nbsp;</div>

                <div class="line number7 index6 alt2"><code class="cpp plain">sock_rps_save_rxhash(sk, skb-&gt;rxhash);</code></div>

                <div class="line number8 index7 alt1">&nbsp;</div>

                <div class="line number9 index8 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(tcp_rcv_established(sk, skb, tcp_hdr(skb), skb-&gt;len)) {</code></div>

                <div class="line number10 index9 alt1">&nbsp;</div>

                <div class="line number11 index10 alt2"><code class="cpp plain">[...] ===&gt;</code></div>

                <div class="line number12 index11 alt1">&nbsp;</div>

                <div class="line number13 index12 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">tcp_rcv_established(</code><code class="cpp keyword bold">struct</code> <code class="cpp plain">sock *sk, </code><code class="cpp keyword bold">struct</code> <code class="cpp plain">sk_buff *skb,</code></div>

                <div class="line number14 index13 alt1">&nbsp;</div>

                <div class="line number15 index14 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number16 index15 alt1">&nbsp;</div>

                <div class="line number17 index16 alt2"><code class="cpp comments">/*</code></div>

                <div class="line number18 index17 alt1">&nbsp;</div>

                <div class="line number19 index18 alt2"><code class="cpp comments">* Header prediction.</code></div>

                <div class="line number20 index19 alt1">&nbsp;</div>

                <div class="line number21 index20 alt2"><code class="cpp comments">*/</code></div>

                <div class="line number22 index21 alt1">&nbsp;</div>

                <div class="line number23 index22 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">((tcp_flag_word(th) &amp; TCP_HP_BITS) == tp-&gt;pred_flags &amp;&amp;</code></div>

                <div class="line number24 index23 alt1">&nbsp;</div>

                <div class="line number25 index24 alt2">&nbsp;</div>

                <div class="line number26 index25 alt1">&nbsp;</div>

                <div class="line number27 index26 alt2"><code class="cpp plain">TCP_SKB_CB(skb)-&gt;seq == tp-&gt;rcv_nxt &amp;&amp;</code></div>

                <div class="line number28 index27 alt1">&nbsp;</div>

                <div class="line number29 index28 alt2">&nbsp;</div>

                <div class="line number30 index29 alt1">&nbsp;</div>

                <div class="line number31 index30 alt2"><code class="cpp plain">!after(TCP_SKB_CB(skb)-&gt;ack_seq, tp-&gt;snd_nxt))) {</code></div>

                <div class="line number32 index31 alt1">&nbsp;</div>

                <div class="line number33 index32 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number34 index33 alt1">&nbsp;</div>

                <div class="line number35 index34 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">((</code><code class="cpp color1 bold">int</code><code class="cpp plain">)skb-&gt;truesize &gt; sk-&gt;sk_forward_alloc)</code>
                </div>

                <div class="line number36 index35 alt1">&nbsp;</div>

                <div class="line number37 index36 alt2"><code class="cpp keyword bold">goto</code> <code class="cpp plain">step5;</code></div>

                <div class="line number38 index37 alt1">&nbsp;</div>

                <div class="line number39 index38 alt2">&nbsp;</div>

                <div class="line number40 index39 alt1">&nbsp;</div>

                <div class="line number41 index40 alt2"><code class="cpp plain">NET_INC_STATS_BH(sock_net(sk), LINUX_MIB_TCPHPHITS);</code></div>

                <div class="line number42 index41 alt1">&nbsp;</div>

                <div class="line number43 index42 alt2">&nbsp;</div>

                <div class="line number44 index43 alt1">&nbsp;</div>

                <div class="line number45 index44 alt2"><code class="cpp comments">/* Bulk data transfer: receiver */</code></div>

                <div class="line number46 index45 alt1">&nbsp;</div>

                <div class="line number47 index46 alt2"><code class="cpp plain">__skb_pull(skb, tcp_header_len);</code></div>

                <div class="line number48 index47 alt1">&nbsp;</div>

                <div class="line number49 index48 alt2"><code class="cpp plain">__skb_queue_tail(&amp;sk-&gt;sk_receive_queue, skb);</code></div>

                <div class="line number50 index49 alt1">&nbsp;</div>

                <div class="line number51 index50 alt2"><code class="cpp plain">skb_set_owner_r(skb, sk);</code></div>

                <div class="line number52 index51 alt1">&nbsp;</div>

                <div class="line number53 index52 alt2"><code class="cpp plain">tp-&gt;rcv_nxt = TCP_SKB_CB(skb)-&gt;end_seq;</code></div>

                <div class="line number54 index53 alt1">&nbsp;</div>

                <div class="line number55 index54 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number56 index55 alt1">&nbsp;</div>

                <div class="line number57 index56 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(!copied_early || tp-&gt;rcv_nxt != tp-&gt;rcv_wup)</code></div>

                <div class="line number58 index57 alt1">&nbsp;</div>

                <div class="line number59 index58 alt2"><code class="cpp plain">__tcp_ack_snd_check(sk, 0);</code></div>

                <div class="line number60 index59 alt1">&nbsp;</div>

                <div class="line number61 index60 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number62 index61 alt1">&nbsp;</div>

                <div class="line number63 index62 alt2"><code class="cpp plain">step5:</code></div>

                <div class="line number64 index63 alt1">&nbsp;</div>

                <div class="line number65 index64 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(th-&gt;ack &amp;&amp; tcp_ack(sk, skb, FLAG_SLOWPATH) &lt; 0)</code></div>

                <div class="line number66 index65 alt1">&nbsp;</div>

                <div class="line number67 index66 alt2"><code class="cpp keyword bold">goto</code> <code class="cpp plain">discard;</code></div>

                <div class="line number68 index67 alt1">&nbsp;</div>

                <div class="line number69 index68 alt2">&nbsp;</div>

                <div class="line number70 index69 alt1">&nbsp;</div>

                <div class="line number71 index70 alt2"><code class="cpp plain">tcp_rcv_rtt_measure_ts(sk, skb);</code></div>

                <div class="line number72 index71 alt1">&nbsp;</div>

                <div class="line number73 index72 alt2">&nbsp;</div>

                <div class="line number74 index73 alt1">&nbsp;</div>

                <div class="line number75 index74 alt2"><code class="cpp comments">/* Process urgent data. */</code></div>

                <div class="line number76 index75 alt1">&nbsp;</div>

                <div class="line number77 index76 alt2"><code class="cpp plain">tcp_urg(sk, skb, th);</code></div>

                <div class="line number78 index77 alt1">&nbsp;</div>

                <div class="line number79 index78 alt2">&nbsp;</div>

                <div class="line number80 index79 alt1">&nbsp;</div>

                <div class="line number81 index80 alt2"><code class="cpp comments">/* step 7: process the segment text */</code></div>

                <div class="line number82 index81 alt1">&nbsp;</div>

                <div class="line number83 index82 alt2"><code class="cpp plain">tcp_data_queue(sk, skb);</code></div>

                <div class="line number84 index83 alt1">&nbsp;</div>

                <div class="line number85 index84 alt2">&nbsp;</div>

                <div class="line number86 index85 alt1">&nbsp;</div>

                <div class="line number87 index86 alt2"><code class="cpp plain">tcp_data_snd_check(sk);</code></div>

                <div class="line number88 index87 alt1">&nbsp;</div>

                <div class="line number89 index88 alt2"><code class="cpp plain">tcp_ack_snd_check(sk);</code></div>

                <div class="line number90 index89 alt1">&nbsp;</div>

                <div class="line number91 index90 alt2"><code class="cpp keyword bold">return</code> <code class="cpp plain">0;</code></div>

                <div class="line number92 index91 alt1">&nbsp;</div>

                <div class="line number93 index92 alt2"><code class="cpp plain">[...]</code></div>

                <div class="line number94 index93 alt1">&nbsp;</div>

                <div class="line number95 index94 alt2"><code class="cpp plain">}</code></div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <p>The actual protocol is executed from the <b>tcp_v4_do_rcv</b> function. If the TCP is in the ESTABLISHED status, <b>tcp_rcv_esablished</b> is called. Processing of the <b>ESTABLISHED</b> status is separately handled and optimized since it is the
    most common status. The <b>tcp_rcv_established</b> first executes the header prediction code. The header prediction is also quickly processed to detect in the common state. The common case here is that there is no data to transmit and the
    received
    data packet is the packet that must be received next time, i.e., the sequence number is the sequence number that the receiving TCP expects. In this case, the procedure is completed by adding the data to the socket buffer and then transmitting
    ACK.
  </p>

  <p>Go forward and you will see the sentence comparing truesize with sk_forward_alloc. It is to check whether there is any free space in the receive socket buffer to add new packet data. If there is, header prediction is "hit" (prediction
    succeeded). Then <b>__skb_pull</b> is called to remove the TCP header. After that, <b>__skb_queue_tail</b> is called to add the packet to the receive socket buffer. Finally, <b>__tcp_ack_snd_check</b> is called for transmitting ACK if necessary.
    In
    this way, packet processing is completed.</p>

  <p>If there is not enough free space, a slow path is executed. The tcp_data_queue function newly allocates the buffer space and adds the data packet to the socket buffer. At this time, the receive socket buffer size is automatically increased if
    possible. Different from the quick path, <b>tcp_data_snd_check</b> is called to transmit a new data packet if possible. Finally, <b>tcp_ack_snd_check</b> is called to create and transmit the ACK packet if necessary.</p>

  <p>The amount of code executed by the two paths is not much. This is accomplished by optimizing the common case. In other words, it means that the uncommon case will be processed significantly more slowly. The out-of-order delivery is one of the
    uncommon cases.</p>

  <h2>How to Communicate between Driver and NIC</h2>

  <p>Communication between a driver and the NIC is the bottom of the stack and most people do not care about it. However, the NIC is executing more and more tasks to solve the performance issue. Understanding the basic operation scheme will help you
    understand the additional technology.</p>

  <p>A driver and the NIC asynchronously communicate. First, a driver requests packet transmission (call) and the CPU performs another task without waiting for the response. And then the NIC sends packets and notifies the CPU of that, the driver
    returns the received packets (returns the result). Like packet transmission, packet receiving is asynchronous. First, a driver requests packet receiving and the CPU performs another task (call). Then, the NIC receives packets and notifies the CPU
    of that, and the driver processes the received packets received (returns the result).</p>

  <p>Therefore, a space to save the request and the response is necessary. In most cases, the NIC uses the ring structure. The ring is similar to the common queue structure. With the fixed number of entries, one entry saves one request data or one
    response data. The entries are sequentially used in turn. The name "ring" is generally used since the fixed entries are reused in turn.</p>

  <p>As following the packet transmission procedure shown in the following <b>Figure 8</b>, you will see how the ring is used.</p>

  <p style="text-align: center;"><img alt="driver_nic_communication_how_to_transmit_packet.png" height="284" rel="xe_gallery" src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/95f3d5135499686bca8ca30f502e5201.png" width="542" style="cursor: pointer;"></p>

  <p style="text-align: center;"><b>Figure 8: Driver-NIC Communication: How to Transmit Packet.</b></p>

  <p>The driver receives packets from the upper layer and creates the send descriptor that the NIC can understand. The send descriptor includes the packet size and the memory address by default. As the NIC needs the physical address to access the
    memory, the driver should change the virtual address of the packets to the physical address. Then, it adds the send descriptor to the TX ring (1). The TX ring is the send descriptor ring.</p>

  <p>Next, it notifies the NIC of the new request (2). The driver directly writes the data to a specific NIC memory address. In this way, Programmed I/O (PIO) is the data transmission method in which the CPU directly sends data to the device.</p>

  <p>The notified NIC gets the send descriptor of the TX ring from the host memory (3). Since the device directly accesses the memory without intervention of the CPU, the access is called Direct Memory Access (DMA).</p>

  <p>After getting the send descriptor, the NIC determines the packet address and the size and then gets the actual packets from the host memory (4). With the checksum offload, the NIC computes the checksum when the NIC gets the packet data from the
    memory. Therefore, overhead rarely occurs.</p>

  <p>The NIC sends packets (5) and then writes the number of packets that are sent to the host memory (6). Then, it sends an interrupt (7). The driver reads the number of packets that are sent and then returns the packets that have been sent so far.
  </p>

  <p>In the following <b>Figure 9</b>, you will see the procedure of receiving packets.</p>

  <p style="text-align: center;"><img alt="driver_nic_cmomunication_how_to_receive_packets.png" height="290" rel="xe_gallery" src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/503efceb4e2486358f390a60252271f5.png" width="542" style="cursor: pointer;"></p>

  <p style="text-align: center;"><b>Figure 9: Driver-NIC Communication: How to Receive Packets.</b></p>

  <p>First, the driver allocates the host memory buffer for receiving packets and then creates the receive descriptor. The receive descriptor includes the buffer size and the memory address by default. Like the send descriptor, it saves the physical
    address that the DMA uses in the receive descriptor. Then, it adds the receive descriptor to the RX ring (1). It is the receive request and the RX ring is the receive request ring.</p>

  <p>Through the PIO, the driver notifies that there is a new descriptor in the NIC (2). The NIC gets the new descriptor of the RX ring. And then it saves the size and location of the buffer included in the descriptor to the NIC memory (3).</p>

  <p>After the packets have been received (4), the NIC sends the packets to the host memory buffer (5). If the checksum offload function is existing, the NIC computes the checksum at this time. The actual size of received packets, the checksum
    result,
    and any other information are saved in the separate ring (the receive return ring) (6). The receive return ring saves the result of processing the receive request, i.e., the response. And then the NIC sends an interrupt (7). The driver gets
    packet
    information from the receive return ring and processes the received packets. If necessary, it allocates new memory buffer and repeats Step (1) and Step (2).</p>

  <p>To tune the stack, most people say that the ring and interrupt setting should be adjusted. When the TX ring is large, a lot of send requests can be made at once. When the RX ring is large, a lot of packet receives can be done at once. A large
    ring
    is useful for the workload that has a huge burst of packet transmission/receiving. In most cases, the NIC uses a timer to reduce the number of interrupts since the CPU may suffer from large overhead to process interrupts. To avoid flooding the
    host
    system with too many interrupts, interrupts are collected and sent regularly(interrupt coalescing) while sending and receiving the packets.</p>

  <h2>Stack Buffer and Flow Control</h2>

  <p>Flow control is executed in several stages in the stack.&nbsp;<b>Figure 10</b> shows buffers used to transmit data. First, an application creates data and adds it to the send socket buffer. If there is no free space in the buffer, the system
    call
    is failed or the blocking occurs in the application thread. Therefore, the application data rate flowing into the kernel must be controlled by using the socket buffer size limit.</p>

  <p style="text-align: center;"><img alt="buffers_related_to_packet_transmission.png" height="400" rel="xe_gallery" src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/0459cdba18786920fb7cc32717e383c5.png" width="288" style="cursor: pointer;"></p>

  <p style="text-align: center;"><b>Figure 10: Buffers Related to Packet Transmission.</b></p>

  <p>The TCP creates and sends packets to the driver through the transmit queue (qdisc). It is a typical FIFO queue type and the maximum length of the queue is the value of txqueuelen which can be checked by executing the ifconfig command. Generally,
    it is thousands of packets.</p>

  <p>The TX ring is between the driver and the NIC. As mentioned before, it is considered as a transmission request queue. If there is no free space in the queue, no transmission request is made and the packets are accumulated in the transmit queue.
    If
    too many packets are accumulated, packets are dropped.</p>

  <p>The NIC saves the packets to transmit in the internal buffer. The packet rate from this buffer is affected by the physical rate (ex: 1 Gb/s NIC cannot offer performance of 10 Gb/s). And with the Ethernet flow control, packet transmission is
    stopped if there is no free space in the receive NIC buffer.</p>

  <p>When the packet rate from the kernel is faster than the packet rate from the NIC, packets are accumulated in the buffer of the NIC. If there is no free space in the buffer, processing of transmission request from the TX ring is stopped. More and
    more requests are accumulated in the TX ring and finally there is no free space in the queue. The driver cannot make any transmission request and the packets are accumulated in the transmit queue. Like this, backpressure is sent from the bottom
    to
    the top through many buffers.</p>

  <p><b>Figure 11</b> shows the buffers that the receive packets are passing. The packets are saved in the receive buffer of the NIC. From the view of flow control, the RX ring between the driver and the NIC is considered as a packet buffer. The
    driver
    gets packets coming into the RX ring and then sends them to the upper layer. There is no buffer between the driver and the upper layer since the NIC driver that is used by the server system uses NAPI by default. Therefore, it can be considered as
    the upper layer directly gets packets from the RX ring. The payload data of packets is saved in the receive socket buffer. The application gets the data from the socket buffer later.</p>

  <p style="text-align: center;"><img alt="buffers_related_to_packaet_receiving.png" height="362" rel="xe_gallery" src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/353be9e9e64a78e66eb752301d764ab3.png" width="303" style="cursor: pointer;"></p>

  <p style="text-align: center;"><b>Figure 11: Buffers Related to Packet Receiving.</b></p>

  <p>The driver that does not support NAPI saves packets in the backlog queue. Later, the NAPI handler gets packets. Therefore, the backlog queue can be considered as a buffer between the upper layer and the driver.</p>

  <p>If the packet processing rate of the kernel is slower than the packet flow rate into the NIC, the RX ring space is full. And the space of the buffer in the NIC is full, too. When the Ethernet flow control is used, the NIC sends a request to stop
    transmission to the transmission NIC or makes the packet drop.</p>

  <p>There is no packet drop due to lack of space in the receive socket buffer because the TCP supports end-to-end flow control. However, packet drop occurs due to lack of space in the socket buffer when the application rate is slow because the UDP
    does not support flow control.</p>

  <p>The sizes of the TX ring and the RX ring used by the driver in <b>Figure 10</b> and <b>Figure 11</b> are the sizes of the rings shown by the ethtool. For most workloads which regard throughput as important, it will be helpful to increase the
    ring
    size and the socket buffer size. Increasing the sizes reduces the possibility of failures caused by lack of space in the buffer while receiving and transmitting a lot of packets at a fast rate.</p>

  <h2>Conclusion</h2>

  <p>Initially, I planned to explain only the things that would be helpful for you to develop network programs, execute performance tests, and perform troubleshooting. In spite of my initial plan, the amount of description included in this document
    is
    not small. I hope this document will help you to develop network applications and monitor their performance. The TCP/IP protocol itself is very complicated and has many exceptions. However, you don't need to understand every line of
    TCP/IP-related code of the OS to understand performance and analyze the phenomena. Just understanding its context will be very helpful for you.</p>

  <p>With continuous advancement of system performance and implementation of the OS network stack, the latest server can offer 10-20 Gb/s TCP throughput without any problem. These days, there are too many technology types related to performance, such
    as TSO, LRO, RSS, GSO, GRO, UFO, XPS, IOAT, DDIO, and TOE, just like alphabet soup, to make us confused.</p>

  <p>In the next article, I will explain about the network stack from the performance perspective and discuss the problems and effects of this technology.</p>

  <p>By Hyeongyeop Kim, Senior Engineer at Performance Engineering Lab, NHN Corporation.</p>
</div></div><!--AfterDocument(3826497,3825957)--></article>
				
					</div>
	
	<div class="rd_ft">
		
				
		<div class="bd_prev_next clear">
						<div>
				<a class="bd_rd_prev bubble no_bubble fl" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826505">
					<span class="p"><em class="link"><i class="fa fa-angle-left"></i> Prev</em> Understanding Vert.x Architecture - Part I: Inside Vert.x. Co...</span>					<i class="fa fa-angle-left"></i>
					<span class="wrp prev_next" style="bottom: 100%; display: none;">
						<span class="speech">
														<b>Understanding Vert.x Architecture - Part I: Inside Vert.x. Co...</b>
							<span><em>2020.05.11</em><small>by </small></span>
						</span><i class="edge"></i>
						<i class="ie8_only bl"></i><i class="ie8_only br"></i>
					</span>
				</a>				
								<a class="bd_rd_next bubble no_bubble fr" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826470">
					<span class="p">Understanding JDBC Internals &amp; Timeout Configuration <em class="link">Next <i class="fa fa-angle-right"></i></em></span>					<i class="fa fa-angle-right"></i>
					<span class="wrp prev_next">
						<span class="speech">
							<img src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/90x90.ratio.jpg" alt="">							<b>Understanding JDBC Internals &amp; Timeout Configuration</b>
							<span><em>2020.05.11</em><small>by </small></span>
						</span><i class="edge"></i>
						<i class="ie8_only bl"></i><i class="ie8_only br"></i>
					</span>
				</a>			</div>
					</div>		
		<div class="rd_vote" style="display:none;">
			<a class="bd_login" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#" style="border:2px solid #333333;color:#333333;">
				<b><i class="fa fa-heart"></i> 0</b>
				<p>Like</p>
			</a>
			<a class="blamed bd_login" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#">
				<b><i class="fa fa-heart"></i> 0</b>
				<p>Dislike</p>
			</a>					</div>		
						
        
				
		<div class="rd_ft_nav clear">
						
			<div class="rd_nav img_tx to_sns fl" data-url="https://www.cubrid.org/3826497?l=en" data-title="Understanding+TCP%2FIP+Network+Stack+%26amp%3B+Writing+Network+Apps" style="display:none;">
	<a class="" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#" data-type="facebook" title="To Facebook"><i class="ico_sns16 facebook"></i><strong> Facebook</strong></a>
	<a class="" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#" data-type="twitter" title="To Twitter"><i class="ico_sns16 twitter"></i><strong> Twitter</strong></a>
	<a class="" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#" data-type="google" title="To Google"><i class="ico_sns16 google"></i><strong> Google</strong></a>
	<a class="" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#" data-type="pinterest" title="To Pinterest"><i class="ico_sns16 pinterest"></i><strong> Pinterest</strong></a>
</div>
		
					
						<div class="rd_nav img_tx fr m_btn_wrp">
				<a class="back_to bubble m_no" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#bd_3826714_3826497" title="Up"><i class="fa fa-arrow-up"></i><b class="tx">Up</b></a>
	<a class="back_to bubble m_no" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#rd_end_3826497" title="(List) Down"><i class="fa fa-arrow-down"></i><b class="tx">Down</b></a>
	<a class="comment back_to bubble if_viewer m_no" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#3826497_comment" title="Go comment"><i class="fa fa-comment"></i><b class="tx">Go comment</b></a>
	<a class="print_doc bubble m_no" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497&amp;listStyle=viewer" title="Print"><i class="fa fa-print"></i><b class="tx">Print</b></a>			</div>					</div>
	</div>
	
	<div class="fdb_lst_wrp  ">
		<div id="3826497_comment" class="fdb_lst clear  ">
			
						
			<div class="cmt_editor">
<label for="editor_3826497" class="cmt_editor_tl fl"><em>✔</em><strong>Write a comment</strong></label>
<div class="editor_select bubble fr m_no" title="※ Be careful of Refresh">
	<a class="tg_btn2" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#" data-href="#editor_select"><em class="fa fa-info-circle bd_info_icon"></em> Select Editor</a>
	<div id="editor_select" class="tg_cnt2 wrp m_no"><button type="button" class="tg_blur2"></button>
		<a class="on" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#" onclick="jQuery.cookie(&#39;bd_editor&#39;,&#39;simple&#39;);location.reload();return false"><em>✔ </em>Textarea</a>
		<a href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#" onclick="jQuery.cookie(&#39;bd_editor&#39;,&#39;editor&#39;);location.reload();return false"><em>✔ </em>WYSIWYG</a>
				<span class="edge"></span><button type="button" class="tg_blur2"></button>
		<i class="ie8_only bl"></i><i class="ie8_only br"></i>
	</div></div><div class="bd_wrt clear">
	<div class="simple_wrt">
		<span class="profile img no_img">?</span>
		<div class="text">
			<a class="cmt_disable bd_login" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497#">Write a comment You do not have permission to access. Sign In?</a>					</div>
		<input type="button" value="Submit" disabled="disabled" class="bd_btn">
	</div>
</div>
</div>			
			<div id="cmtPosition" aria-live="polite"></div>
			
								</div>
	</div>	
	</div>
<hr id="rd_end_3826497" class="rd_end clear">
<div class="bd_lst_wrp">
<div class="tl_srch clear">
	
			
	<div class="bd_faq_srch">
		<form action="https://www.cubrid.org/" method="get" onsubmit="return procFilter(this, search)"><input type="hidden" name="act" value="">
	<input type="hidden" name="vid" value="">
	<input type="hidden" name="mid" value="blog">
	<input type="hidden" name="category" value="">
	<table class="bd_tb">
		<tbody><tr>
			<td>
				<span class="select itx">
					<select name="search_target">
						<option value="title_content">Subject+Content</option><option value="title">Subject</option><option value="content">Content</option><option value="comment">Comment</option><option value="nick_name">Nick Name</option><option value="user_id">User ID</option><option value="tag">Tag</option>					</select>
				</span>
			</td>
			<td class="itx_wrp">
				<input type="text" name="search_keyword" value="" class="itx srch_itx">
			</td>
			<td>
				<button type="submit" onclick="jQuery(this).parents(&#39;form&#39;).submit();return false" class="bd_btn">Search</button>
							</td>
		</tr>
	</tbody></table>
</form>	</div></div>
<div class="cnb_n_list">
<div class="lst_btn fr" style="display:none;">
	<ul>
		<li class="classic"><a class="bubble" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;listStyle=list" title="Text Style"><b>List</b></a></li>
		<li class="zine on"><a class="bubble" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;listStyle=webzine" title="Text + Image Style"><b>Zine</b></a></li>
		<li class="gall"><a class="bubble" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;listStyle=gallery" title="Gallery Style"><b>Gallery</b></a></li>
			</ul>
</div></div>
<ol class=" bd_lst bd_zine zine zine1 img_loadN">
		
		
	<li class="clear">
		
				
		<div class="rt_area is_tmb">
			<div class="tmb_wrp ribbon_v">
				
								<img class="tmb" src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/230x200.crop.jpg" alt="">				
																																			</div>			
			<h3 class="ngeb">Become a Jave GC Expert  Series 4 : MaxClients in Apache and its effect on Tomcat during Full GC</h3>
			
			<div class="cnt">Written by Dongsoon Choi on 06/23/2017 This is the fourth article in the series of "Become a Java GC Expert". In the first issue Understanding Java Garbage Collection we have learned about the processes for different GC algorithms, about how GC works, what Young and Old Generation is, what you should know about the 5 types of GC in the new JDK 7, and what the performance implications are for each of these GC types. In the second article How to Monitor Java Garbage Collection we have explained how JVM actually runs the Garbage Collection in the real time, how we can monitor GC, and which tools we can use to make this process faster and more effective. In the third article How to Tune Java Garbage Collection we have shown some of the best options based on real cases as our examples that you c...</div>			
			<div class="info">
																												
																			</div>
		</div>
		<a class="hx" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826519" data-viewer="https://www.cubrid.org/index.php?mid=blog&amp;document_srl=3826519&amp;listStyle=viewer"><span class="blind">Read More</span></a>
	</li><li class="clear">
		
				
		<div class="rt_area is_tmb">
			<div class="tmb_wrp ribbon_v">
				
								<img class="tmb" src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/230x200.crop(1).jpg" alt="">				
																																			</div>			
			<h3 class="ngeb">Understanding Vert.x Architecture - Part II</h3>
			
			<div class="cnt">Written by Jaehong Kim on 06/16/2017 Previous blog article covered Vert.x, a Java application framework which provides noticeable performance advantage over competing technologies and features multi programming language support. The previous article has explained us about the philosophy of Vert.x, performance comparison with Node.js, internal structure of Vert.x, and many more. Today, I would like to continue this conversation and talk more about Vert.x architecture. Considerations Used to Develop Vert.x Polyglot is the feature making Vert.x stand out from other server frameworks. In the past, server frameworks could not support multiple languages. Supporting several languages does more than expand the range of users. More important thing is that services using different languages in a dist...</div>			
			<div class="info">
																												
																			</div>
		</div>
		<a class="hx" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826515" data-viewer="https://www.cubrid.org/index.php?mid=blog&amp;document_srl=3826515&amp;listStyle=viewer"><span class="blind">Read More</span></a>
	</li><li class="clear">
		
				
		<div class="rt_area">
			<div class="tmb_wrp ribbon_v">
				
				<span class="no_img tmb">No Image</span>								
																																			</div>			
			<h3 class="ngeb">Understanding Vert.x Architecture - Part I: Inside Vert.x. Comparison with Node.js</h3>
			
			<div class="cnt">Written by Seongmin Woo on 06/14/2017 Vert.x is a server framework that is rapidly arising. Each server framework claims its strong points are high performance with a variety of protocols supported. Vert.x takes a step forward from that. Vert.x considers the environment of establishing and operating the server network environment. In other words, Vert.x includes careful consideration in producing several 'server process DAEMONs' that run on the clustering environment, as well as producing one server process DAEMON. Therefore, it is important to review Vert.x: which network environment it considers as well as how it delivers high performance. So, I think it will be valuable to pay sufficient time examining Vert.x structure. Philosophy of Vert.x Vert.x is a project affected by Node.js. Like N...</div>			
			<div class="info">
																												
																			</div>
		</div>
		<a class="hx" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826505" data-viewer="https://www.cubrid.org/index.php?mid=blog&amp;document_srl=3826505&amp;listStyle=viewer"><span class="blind">Read More</span></a>
	</li><li class="select clear">
		
				
		<div class="rt_area is_tmb">
			<div class="tmb_wrp ribbon_v">
				
								<img class="tmb" src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/230x200.crop(2).jpg" alt="">				
																																			</div>			
			<h3 class="ngeb">Understanding TCP/IP Network Stack &amp; Writing Network Apps</h3>
			
			<div class="cnt">Written by Hyeongyeop Kim on 06/09/2017 We cannot imagine Internet service without TCP/IP. All Internet services we have developed and used at NHN are based on a solid basis, TCP/IP. Understanding how data is transferred via the network will help you to improve performance through tuning, troubleshooting, or introduction to a new technology. This article will describe the overall operation scheme of the network stack based on data flow and control flow in Linux OS and the hardware layer. Key Characteristics of TCP/IP How should I design a network protocol to transmit data quickly while keeping the data order without any data loss? TCP/IP has been designed with this consideration. The following are the key characteristics of TCP/IP required to understand the concept of the stack. TCP and IP ...</div>			
			<div class="info">
																												
																			</div>
		</div>
		<a class="hx" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497" data-viewer="https://www.cubrid.org/index.php?mid=blog&amp;document_srl=3826497&amp;listStyle=viewer"><span class="blind">Read More</span></a>
	</li><li class="clear">
		
				
		<div class="rt_area is_tmb">
			<div class="tmb_wrp ribbon_v">
				
								<img class="tmb" src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/230x200.crop(3).jpg" alt="">				
																																			</div>			
			<h3 class="ngeb">Understanding JDBC Internals &amp; Timeout Configuration</h3>
			
			<div class="cnt">Written by Woon Duk Kang on 06/07/2017 &nbsp; An application with a proper JDBC timeout can cut down the failure time. In this article, we would like to talk about different kinds of timeout values and recommended timeout application methods&nbsp;when you import values from DBMS. Web Application Server became unresponsive after a DDoS&nbsp;attack one day (This is a close reconstitution of an actual event.) The entire service did not work normally after a DDoS attack. The network was disconnected because L4 was not working, which caused WAS to be inoperable as well. Shortly afterward, the security team blocked all DDoS attacks and restored the network back to normal. Yet, WAS was still not working. Through the ThreadDump of WAS, the service team was able to confirm that WAS had stopped during API call from...</div>			
			<div class="info">
																												
																			</div>
		</div>
		<a class="hx" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826470" data-viewer="https://www.cubrid.org/index.php?mid=blog&amp;document_srl=3826470&amp;listStyle=viewer"><span class="blind">Read More</span></a>
	</li></ol>
<div class="btm_mn clear">
	
		<div class="fl">
				
		<form action="https://www.cubrid.org/" method="get" onsubmit="return procFilter(this, search)" class="bd_srch_btm"><input type="hidden" name="act" value="">
			<input type="hidden" name="vid" value="">
			<input type="hidden" name="mid" value="blog">
			<input type="hidden" name="category" value="">
			<span class="btn_img itx_wrp">
				<button type="submit" onclick="jQuery(this).parents(&#39;form.bd_srch_btm&#39;).submit();return false;" class="ico_16px search">Search</button>
				<label for="bd_srch_btm_itx_3826714">Search</label>
				<input type="text" name="search_keyword" id="bd_srch_btm_itx_3826714" class="bd_srch_btm_itx srch_itx" value="">
			</span>
			<span class="btn_img select">
				<select name="search_target">
					<option value="title_content">Subject+Content</option><option value="title">Subject</option><option value="content">Content</option><option value="comment">Comment</option><option value="nick_name">Nick Name</option><option value="user_id">User ID</option><option value="tag">Tag</option>				</select>
			</span>
					</form>	</div>
	<div class="fr">
							</div>
</div><form action="https://www.cubrid.org/" method="get" class="bd_pg clear"><input type="hidden" name="error_return_url" value="/index.php?mid=blog&amp;page=2&amp;document_srl=3826497"><input type="hidden" name="act" value="">
	<fieldset>
	<legend class="blind">Board Pagination</legend>
	<input type="hidden" name="vid" value="">
	<input type="hidden" name="mid" value="blog">
	<input type="hidden" name="category" value="">
	<input type="hidden" name="search_keyword" value="">
	<input type="hidden" name="search_target" value="">
	<input type="hidden" name="listStyle" value="webzine">
			<a href="https://www.cubrid.org/index.php?mid=blog&amp;page=1" class="direction"><i class="fa fa-angle-left"></i> Prev</a>		<a class="frst_last bubble" href="https://www.cubrid.org/blog" title="First Page">1</a>
				<strong class="this">2</strong> 
					<a class="frst_last bubble" href="https://www.cubrid.org/index.php?mid=blog&amp;page=3" title="Last Page">3</a>	<a href="https://www.cubrid.org/index.php?mid=blog&amp;page=3" class="direction">Next <i class="fa fa-angle-right"></i></a>		<div class="bd_go_page tg_cnt2 wrp">
		<button type="button" class="tg_blur2"></button>
		<input type="text" name="page" class="itx">/ 3 <button type="submit" class="bd_btn">GO</button>
		<span class="edge"></span>
		<i class="ie8_only bl"></i><i class="ie8_only br"></i>
		<button type="button" class="tg_blur2"></button>
	</div>
	</fieldset>
</form>
</div>	</div>    </div>        <section class="pt64 pb64">
        <div class="container">
            <div class="row">
                <div class="col-sm-12 text-center">
                    <h3 class="mb8">Join the CUBRID Project on</h3>
                    <p>
                        &nbsp; 
                    </p>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-4">
                    <div class=" ">
                        <div class="text-right">
                            <a href="https://github.com/cubrid" target="_blank"><img src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/github_logo_2.png"></a>
                        </div>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class=" ">
                        <div class="text-center">
                            <a href="http://jira.cubrid.org/" target="_blank"><img src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/jira_logo_2.png"></a>
                        </div>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class=" ">
                        <div class="text-left">
                            <a href="https://www.reddit.com/r/CUBRID/" target="_blank"><img src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/reddit_logo_2.png"></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section> 
    <section class="bg-secondary pt80 pb80">
        <div class="container">
                <h3 class="pull-left">Site Map</h3>
                <hr>
                <ul class="site-map">
                    <li class=" ">
                        <a href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497">About </a>
                        <!-- 2차메뉴 시작 -->
                        <ul>
                            <li class="">
                                <a href="https://www.cubrid.org/cubrid" class="">CUBRID </a>
                            </li>
                            <li class="">
                                <a href="https://www.cubrid.org/cubrid_tools" class="">CUBRID Tools</a>
                            </li>
                            <li class="">
                                <a href="https://www.cubrid.org/stakeholder" class="">Stakeholder </a>
                            </li>
                  			    <li class="">
                                <a href="https://www.cubrid.org/sponsor" class="">Sponsor </a>
                            </li>
                        </ul>
                        <!-- // 2차메뉴 종료-->
                    </li>
                    <li class=" ">
                        <a href="https://www.cubrid.org/downloads">Downloads </a>
                        <!-- 2차메뉴 시작 -->
                        
                        <!-- // 2차메뉴 종료-->
                    </li>
                    <li class=" ">
                        <a href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497">Documentation </a>
                        <!-- 2차메뉴 시작 -->
                        <ul>
                            <li class="">
                                <a href="https://www.cubrid.org/manuals" class="">Manuals </a>
                            </li>
                            <li class="">
                                <a href="https://www.cubrid.org/release" class="">Release </a>
                            </li>
                            <li class="">
                                <a href="https://www.cubrid.org/getting_started" class="">Getting Started </a>
                            </li>
                            <li class="">
                                <a href="https://www.cubrid.org/tutorials" class="">Tutorials </a>
                            </li>
                            <li class="">
                                <a href="https://www.cubrid.org/faq" class="">FAQ </a>
                            </li>
                        </ul>
                        <!-- // 2차메뉴 종료-->
                    </li>
                    <li class=" ">
                        <a href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497">Community </a>
                        <!-- 2차메뉴 시작 -->
                        <ul>
                            <li class="">
                                <a href="https://www.cubrid.org/how_to_contribute" class="">How to Contribute</a>
                            </li>
                            <li class="">
                                <a href="https://www.cubrid.org/contributor_agreement" class="">Contributor Agreement</a>
                            </li>
                        </ul>
                        <!-- // 2차메뉴 종료-->
                    </li>
                    <li class=" ">
                        <a href="https://www.reddit.com/r/CUBRID/" target="_blank">Forum </a>
                        <!-- 2차메뉴 시작 -->
                        
                        <!-- // 2차메뉴 종료-->
                    </li>
                    <li class=" ">
                        <a href="https://www.cubrid.org/news">News </a>
                        <!-- 2차메뉴 시작 -->
                        
                        <!-- // 2차메뉴 종료-->
                    </li>
		    <li class=" ">
			<a href="https://www.cubrid.org/blog">Blog </a>
		    </li>
                    <li class=" ">
                        <a href="https://www.cubrid.org/contact">Contact </a>
                        <!-- 2차메뉴 시작 -->
                        
                        <!-- // 2차메뉴 종료-->
                    </li>
                </ul>
    
            <!--end of row-->
            </div>
    
    </section>
        <footer class="footer-2 bg-dark ">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-md-offset-3 col-sm-8 col-sm-offset-2 text-center">
                <a href="https://www.cubrid.org/">
                                                    </a>
                                <h5 class="fade-1-4">ⓒ 2021 CUBRID Foundation. All rights reserved.</h5>                <ul class="list-inline social-list mb0">
                	                                        <li><a href="https://www.facebook.com/cubrid" target="_blank"><i class="ti-facebook"></i></a></li>                    <li><a href="https://twitter.com/cubrid" target="_blank"><i class="ti-twitter-alt"></i></a></li>                    
                </ul>
            </div>
        </div><!--end of row-->
    </div><!--end of container-->
</footer></div>
        <!--end modal strip-->
        
        
        
    
<!--end modal strip-->
<script type="text/javascript">
window.SyntaxHighlighter.autoloader(
"text plain /modules/editor/components/code_highlighter/syntaxhighlighter/scripts/shBrushPlain.js",
"applescript /modules/editor/components/code_highlighter/syntaxhighlighter/scripts/shBrushAppleScript.js",
"actionscript3 as3 /modules/editor/components/code_highlighter/syntaxhighlighter/scripts/shBrushAS3.js",
"bash shell /modules/editor/components/code_highlighter/syntaxhighlighter/scripts/shBrushBash.js",
"bat cmd batch btm /modules/editor/components/code_highlighter/syntaxhighlighter/scripts/shBrushBatch.js",
"coldfusion cf /modules/editor/components/code_highlighter/syntaxhighlighter/scripts/shBrushColdFusion.js",
"cpp c /modules/editor/components/code_highlighter/syntaxhighlighter/scripts/shBrushCpp.js",
"c# c-sharp csharp /modules/editor/components/code_highlighter/syntaxhighlighter/scripts/shBrushCSharp.js",
"css /modules/editor/components/code_highlighter/syntaxhighlighter/scripts/shBrushCss.js",
"delphi pascal /modules/editor/components/code_highlighter/syntaxhighlighter/scripts/shBrushDelphi.js",
"diff patch pas /modules/editor/components/code_highlighter/syntaxhighlighter/scripts/shBrushDiff.js",
"erl erlang /modules/editor/components/code_highlighter/syntaxhighlighter/scripts/shBrushErlang.js",
"groovy /modules/editor/components/code_highlighter/syntaxhighlighter/scripts/shBrushGroovy.js",
"java /modules/editor/components/code_highlighter/syntaxhighlighter/scripts/shBrushJava.js",
"jfx javafx /modules/editor/components/code_highlighter/syntaxhighlighter/scripts/shBrushJavaFX.js",
"js jscript javascript /modules/editor/components/code_highlighter/syntaxhighlighter/scripts/shBrushJScript.js",
"perl pl /modules/editor/components/code_highlighter/syntaxhighlighter/scripts/shBrushPerl.js",
"php /modules/editor/components/code_highlighter/syntaxhighlighter/scripts/shBrushPhp.js",
"powershell ps /modules/editor/components/code_highlighter/syntaxhighlighter/scripts/shBrushPowerShell.js",
"py python /modules/editor/components/code_highlighter/syntaxhighlighter/scripts/shBrushPython.js",
"ruby rails ror rb /modules/editor/components/code_highlighter/syntaxhighlighter/scripts/shBrushRuby.js",
"sass scss /modules/editor/components/code_highlighter/syntaxhighlighter/scripts/shBrushSass.js",
"scala /modules/editor/components/code_highlighter/syntaxhighlighter/scripts/shBrushScala.js",
"sql /modules/editor/components/code_highlighter/syntaxhighlighter/scripts/shBrushSql.js",
"vb vbnet /modules/editor/components/code_highlighter/syntaxhighlighter/scripts/shBrushVb.js",
"xml xhtml xslt html /modules/editor/components/code_highlighter/syntaxhighlighter/scripts/shBrushXml.js"
);
window.SyntaxHighlighter.config.bloggerMode = true;
window.SyntaxHighlighter.all();
</script><script type="text/javascript" src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/wcslog.js"></script> <script type="text/javascript"> if(!wcs_add) var wcs_add = {}; wcs_add["wa"] = "50270226a3ff"; wcs_do(); </script><!-- ETC -->
<div class="wfsr"></div>
<script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/captcha.js"></script><script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/d046d1841b9c79c545b82d3be892699d.en.compiled.js"></script><script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/1bdc15d63816408b99f674eb6a6ffcea.en.compiled.js"></script><script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/9b007ee9f2af763bb3d35e4fb16498e9.en.compiled.js"></script><script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/autolink.js"></script><script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/jquery-ui.min.js"></script><script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/jquery.ui.datepicker-ko.js"></script><script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/resize_image.js"></script><script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/imagesloaded.pkgd.min.js"></script><script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/jquery.cookie.js"></script><script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/xe_textarea.js"></script><script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/jquery.autogrowtextarea.min.js"></script><script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/board(1).js"></script><script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/jquery.masonry.min.js"></script><script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/font_ng.js"></script><script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/bootstrap.js"></script><script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/flickr.js"></script><script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/flexslider.min.js"></script><script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/lightbox.min.js"></script><script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/masonry.min.js"></script><script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/twitterfetcher.min.js"></script><script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/spectragram.min.js"></script><script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/ytplayer.min.js"></script><script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/countdown.min.js"></script><script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/smooth-scroll.min.js"></script><script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/parallax.js"></script><script src="./CUBRID Foundation_ Blog - Understanding TCP_IP Network Stack &amp; Writing Network Apps_files/scripts.js"></script>

<div class="fontcheckWrp"><p id="fontcheck_np1" style="font-family:&#39;나눔손글씨 펜&#39;,&#39;Nanum Pen Script&#39;,np,monospace,Verdana !important">Sketchbook5, 스케치북5</p><p id="fontcheck_np2" style="font-family:monospace,Verdana !important">Sketchbook5, 스케치북5</p></div><div id="bd_font_install"><div id="install_ng2"><button type="button" class="tg_blur2"></button><button type="button" class="tg_close2">X</button><h3>나눔글꼴 설치 안내</h3><br><h4>이 PC에는 <b>나눔글꼴</b>이 설치되어 있지 않습니다.</h4><p>이 사이트를 <b>나눔글꼴</b>로 보기 위해서는<br><b>나눔글꼴</b>을 설치해야 합니다.</p><div><a href="http://hangeul.naver.com/" target="_blank">나눔고딕 사이트로 가기</a></div><button type="button" class="tg_blur2"></button></div></div><div class="fontcheckWrp"><p id="fontcheck_ng3" style="font-family:&#39;나눔고딕&#39;,NanumGothic,monospace,Verdana !important">Sketchbook5, 스케치북5</p><p id="fontcheck_ng4" style="font-family:monospace,Verdana !important">Sketchbook5, 스케치북5</p></div><div id="lightboxOverlay" class="lightboxOverlay" style="display: none;"></div><div id="lightbox" class="lightbox" style="display: none;"><div class="lb-outerContainer"><div class="lb-container"><img class="lb-image" src="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497"><div class="lb-nav"><a class="lb-prev" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497"></a><a class="lb-next" href="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497"></a></div><div class="lb-loader"><a class="lb-cancel"></a></div></div></div><div class="lb-dataContainer"><div class="lb-data"><div class="lb-details"><span class="lb-caption"></span><span class="lb-number"></span></div><div class="lb-closeContainer"><a class="lb-close"></a></div></div></div></div><div id="captcha_layer" style="position:fixed; top:0; left:0; width:100%; height:100%;display:none;z-index:10"><div style="z-index:1000;position:absolute; width:310px;margin:-105px 0 0 -105px; top:50%; left:50%; background:#fff; border:3px solid #ccc;"><form method="post" action="https://www.cubrid.org/index.php?mid=blog&amp;page=2&amp;document_srl=3826497"><div style="position:relative; margin:25px 20px 15px 20px"><img src="about:blank" id="captcha_image" alt="CAPTCHA" width="240" height="50" style="display:block; width:240px; height:50px; border:1px solid #b0b0b0"><button type="button" class="reload" title="" style="position:absolute; top:0; left:245px; width:25px; height:25px; padding:0; overflow:visible; border:1px solid #575757; background:#747474 url(https://www.cubrid.org/addons/captcha/img/icon.gif) no-repeat center 5px;border-radius:3px;-moz-border-radius:3px;-webkit-border-radius:3px; cursor:pointer;box-shadow:0 0 3px #444 inset;-moz-box-shadow:0 0 3px #444 inset;-webkit-box-shadow:0 0 3px #444 inset;"></button><button type="button" class="play" title="" style="position:absolute; top:27px; left:245px; width:25px; height:25px; padding:0; overflow:visible; border:1px solid #575757; background:#747474 url(https://www.cubrid.org/addons/captcha/img/icon.gif) no-repeat center -20px;border-radius:3px;-moz-border-radius:3px;-webkit-border-radius:3px; cursor:pointer;box-shadow:0 0 3px #444 inset;-moz-box-shadow:0 0 3px #444 inset;-webkit-box-shadow:0 0 3px #444 inset;"></button></div><label id="captchaAbout" for="captcha" style="display:block; border-top:1px dashed #c5c5c5; padding:15px 0; margin:0 20px; font-size:12px; color:#5f5f5f;"></label><input name="" type="text" id="secret_text" style="ime-mode:inactive;margin:0 20px; width:232px; border:1px solid #bdbdbd; padding:3px 4px; font-size:18px; font-weight:bold;"><div style="margin:20px; border-top:1px dashed #c5c5c5; padding:15px 0 0 0; text-align:center"><button type="submit" style="height:31px; line-height:31px; padding:0 15px; margin:0 2px; font-size:12px; font-weight:bold; color:#fff; overflow:visible; border:1px solid #5c8a16; background:#6faa13;border-radius:3px;-moz-border-radius:3px;-webkit-border-radius:3px; cursor:pointer;box-shadow:0 0 3px #666 inset;-moz-box-shadow:0 0 3px #666 inset;-webkit-box-shadow:0 0 3px #666 inset;"></button><button type="button" class="cancel" style="height:31px; line-height:31px; padding:0 15px; margin:0 2px; font-size:12px; font-weight:bold; color:#fff; overflow:visible; border:1px solid #575757; background:#747474;border-radius:3px;-moz-border-radius:3px;-webkit-border-radius:3px; cursor:pointer;box-shadow:0 0 3px #444 inset;-moz-box-shadow:0 0 3px #444 inset;-webkit-box-shadow:0 0 3px #444 inset;"></button></div></form><embed src="https://www.cubrid.org/addons/captcha/swf/play.swf" quality="high" wmode="window" allowfullscreen="false" bgcolor="#ffffff" width="0" height="0" name="captcha_audio" align="middle" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer"></div></div><audio controls="controls" style="display: none;"></audio><div id="popup_menu_area" tabindex="0" style="display:none;z-index:9999"></div></body><style type="text/css">#yddContainer{display:block;font-family:Microsoft YaHei;position:relative;width:100%;height:100%;top:-4px;left:-4px;font-size:12px;border:1px solid}#yddTop{display:block;height:22px}#yddTopBorderlr{display:block;position:static;height:17px;padding:2px 28px;line-height:17px;font-size:12px;color:#5079bb;font-weight:bold;border-style:none solid;border-width:1px}#yddTopBorderlr .ydd-sp{position:absolute;top:2px;height:0;overflow:hidden}.ydd-icon{left:5px;width:17px;padding:0px 0px 0px 0px;padding-top:17px;background-position:-16px -44px}.ydd-close{right:5px;width:16px;padding-top:16px;background-position:left -44px}#yddKeyTitle{float:left;text-decoration:none}#yddMiddle{display:block;margin-bottom:10px}.ydd-tabs{display:block;margin:5px 0;padding:0 5px;height:18px;border-bottom:1px solid}.ydd-tab{display:block;float:left;height:18px;margin:0 5px -1px 0;padding:0 4px;line-height:18px;border:1px solid;border-bottom:none}.ydd-trans-container{display:block;line-height:160%}.ydd-trans-container a{text-decoration:none;}#yddBottom{position:absolute;bottom:0;left:0;width:100%;height:22px;line-height:22px;overflow:hidden;background-position:left -22px}.ydd-padding010{padding:0 10px}#yddWrapper{color:#252525;z-index:10001;background:url(chrome-extension://eopjamdnofihpioajgfdikhhbobonhbb/ab20.png);}#yddContainer{background:#fff;border-color:#4b7598}#yddTopBorderlr{border-color:#f0f8fc}#yddWrapper .ydd-sp{background-image:url(chrome-extension://eopjamdnofihpioajgfdikhhbobonhbb/ydd-sprite.png)}#yddWrapper a,#yddWrapper a:hover,#yddWrapper a:visited{color:#50799b}#yddWrapper .ydd-tabs{color:#959595}.ydd-tabs,.ydd-tab{background:#fff;border-color:#d5e7f3}#yddBottom{color:#363636}#yddWrapper{min-width:250px;max-width:400px;}</style></html>